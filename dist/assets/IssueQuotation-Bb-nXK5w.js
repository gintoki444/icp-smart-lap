import{r as c,u as V,h as W,y as p,j as t,R as B,C as q,B as x,i as J,k as K,F as X,w as Y}from"./index-6YeC_AS5.js";import{g as Z,e as ee}from"./serviceRequest-CJ15hpJs.js";import{g as te}from"./customerRequest-D-QXhSQD.js";import{A as se,a as ae,E as oe,b as ne}from"./ExpandMore-BGXL0BaM.js";import{d as ie}from"./quotationRequest-BTgCnPa-.js";import{C as j}from"./Card-BhOVTKNa.js";import{S as N}from"./Stack-DS5MSRky.js";import{F as k}from"./Form-CGCyrcfL.js";import{C as re,T as I,D as le,B as de,b as A}from"./DataGrid-DoczE-38.js";import{B as ce}from"./Badge-C_mrIdUk.js";import"./DefaultPropsProvider-2RhE6zQB.js";import"./emotion-element-f0de968e.browser.esm-C-W82wov.js";import"./TextField-DmQ6Lsg1.js";import"./toPropertyKey-CTo9CRTC.js";import"./Transition-rt6HDaS9.js";import"./setPrototypeOf-DgZC2w_0.js";import"./Divider-mvYdwXE_.js";const Ne=()=>{const[b,P]=c.useState(null),[C,z]=c.useState([]),[y,S]=c.useState([]),[h,L]=c.useState(()=>localStorage.getItem("filterText")||""),[g,w]=c.useState(!1),[F,O]=c.useState(!1),[f,R]=c.useState([]),D=V();c.useEffect(()=>{const e=localStorage.getItem("authToken");e&&(w(!0),W(e).then(s=>(P(s.user),E())).catch(s=>{p.error("ไม่สามารถตรวจสอบผู้ใช้ได้"),console.error(s)}).finally(()=>{w(!1),O(!0)}))},[]);const E=async()=>{try{const[e,s]=await Promise.all([te(),Z()]);if(e){const r=e.map((o,i)=>({id:o.company_id,No:i+1,company_code:o.company_code,company_name:o.company_name,tax_id:o.tax_id,company_address:o.company_address}));z(r)}if(s){const r=[...new Set(s.map(a=>a.user_id))],o=await Promise.all(r.map(a=>ee(a).then(n=>({userId:a,services:n.data||[]})).catch(n=>(console.error(`Error fetching services for user ${a}:`,n),{userId:a,services:[]}))));console.log("detailedServiceResults:",o);const i=o.flatMap(a=>a.services.map((n,_)=>{var m,d;return{id:n.request_id,No:_+1,request_date:new Date(n.request_date).toLocaleString(),request_date_raw:n.request_date,request_no:n.request_no||"-",user_id:n.user_id,user_name:n.user_name,customer_id:n.customer_id,customer_name:((m=e==null?void 0:e.find(H=>H.company_id===n.customer_id))==null?void 0:m.company_name)||n.customer_name||"-",sample_type_name:n.sample_type_name,status:n.status,notes:n.notes||"-",created_at:new Date(n.created_at).toLocaleString(),sample_submissions:n.sample_submissions,count_sample_submissions:((d=n.sample_submissions)==null?void 0:d.length)||0,request_id_list_by_quotation:n.request_id_list_by_quotation,quotation_id:n.quotation_id,quotation_no:n.quotation_no||"-",quotation_date:n.quotation_date,service_request_documents:n.service_request_documents,service_status_logs:n.service_status_logs}})),l=[...s.map((a,n)=>{var _,m;return{id:a.request_id,No:n+1,request_date:new Date(a.request_date).toLocaleString(),request_date_raw:a.request_date,request_no:a.request_no||"-",user_id:a.user_id,user_name:a.user_name,customer_id:a.customer_id,customer_name:((_=e==null?void 0:e.find(d=>d.company_id===a.customer_id))==null?void 0:_.company_name)||a.customer_name||"-",sample_type_name:a.sample_type_name,status:a.status,notes:a.notes||"-",created_at:new Date(a.created_at).toLocaleString(),sample_submissions:a.sample_submissions,count_sample_submissions:((m=a.sample_submissions)==null?void 0:m.length)||0,request_id_list_by_quotation:a.request_id_list_by_quotation||[],quotation_no:a.quotation_no||"-",quotation_date:a.quotation_date||null,service_request_documents:a.service_request_documents||[],service_status_logs:a.service_status_logs||[]}}),...i].reduce((a,n)=>(a[n.id]=n,a),{}),u=Object.values(l).filter(a=>a.request_no&&a.request_no!=="-").map((a,n)=>({...a,No:n+1}));S(u.length>0?u:[])}else S([])}catch(e){p.error("เกิดข้อผิดพลาดในการดึงข้อมูล"),console.error(e),S([])}},U=[{field:"checkbox",headerName:"เลือก",width:70,headerAlign:"center",align:"center",renderCell:e=>t.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:t.jsx(k.Check,{type:"checkbox",checked:f.includes(e.row.id),className:"d-flex justify-content-center align-items-center",disabled:e.row.request_id_list_by_quotation,onChange:s=>{s.target.checked?R(r=>[...r,e.row.id]):R(r=>r.filter(o=>o!==e.row.id))},style:{margin:0,padding:0}})})},{field:"No",headerName:"No.",width:90,headerAlign:"center",align:"center"},{field:"request_no",headerName:"เลขที่คำขอ",flex:.8},{field:"quotation_no",headerName:"เลขที่ใบเสนอราคา",flex:.8},{field:"sample_type_name",headerName:"ประเภทคำขอ",flex:.7},{field:"request_date",headerName:"วันที่สร้าง",flex:1},{field:"count_sample_submissions",headerName:"จำนวนตัวอย่าง",flex:1,headerAlign:"center",align:"center"},{field:"status",headerName:"สถานะ",width:120,headerAlign:"center",align:"center",renderCell:e=>t.jsx(ce,{pill:!0,bg:e.row.status==="pending"?"warning":e.row.status==="rejected"?"danger":"success",children:e.row.status==="pending"?"กำลังดำเนินการ":e.row.status==="rejected"?"ไม่อนุมัติ":"อนุมัติ"})},{field:"actions",headerName:"Action",width:200,headerAlign:"center",align:"center",renderCell:e=>t.jsxs(de,{children:[t.jsx(A,{title:"แก้ไข",placement:"bottom",arrow:!0,children:t.jsx(x,{variant:"info",size:"sm",disabled:!e.row.quotation_id,onClick:()=>$(e.row.quotation_id),children:t.jsx(X,{})})}),t.jsx(A,{title:"รายละเอียด",placement:"bottom",arrow:!0,children:t.jsx(x,{variant:"primary",size:"sm",disabled:!e.row.quotation_id,onClick:()=>{D("/admin/issue-quotation/detail",{state:{id:e.row.quotation_id}})},children:t.jsx("i",{className:"feather icon-file-text m-0"})})}),t.jsx(A,{title:"ลบใบเสนอราคา",placement:"bottom",arrow:!0,children:t.jsx(x,{variant:"outline-danger",size:"sm",disabled:!e.row.quotation_id,onClick:()=>v(e.row.quotation_id),children:t.jsx(Y,{})})})]})}],T=c.useMemo(()=>{if(!y.length||!C.length)return[];let e={};const s=h.toLowerCase().trim();y.forEach(o=>{var l,u,a,n,_,m;if(!s||((l=o.request_no)==null?void 0:l.toLowerCase().includes(s))||((u=o.sample_type_name)==null?void 0:u.toLowerCase().includes(s))||((a=o.request_date)==null?void 0:a.toLowerCase().includes(s))||((n=o.notes)==null?void 0:n.toLowerCase().includes(s))||((_=o.status)==null?void 0:_.toLowerCase().includes(s))||((m=o.customer_name)==null?void 0:m.toLowerCase().includes(s))){const d=o.customer_id;e[d]||(e[d]={customer_id:d,customer_name:o.customer_name,serviceCount:0,filteredRows:[],earliestRequestDate:o.request_date_raw}),e[d].serviceCount+=1,e[d].filteredRows.push(o),new Date(o.request_date_raw)<new Date(e[d].earliestRequestDate)&&(e[d].earliestRequestDate=o.request_date_raw)}});let r=Object.values(e).map(o=>{const i=C.find(l=>l.id===o.customer_id)||{};return{...o,company_name:i.company_name||o.customer_name,company_code:i.company_code,tax_id:i.tax_id||"-",company_address:i.company_address||"-",isVisible:!0}});return r=r.sort((o,i)=>new Date(i.earliestRequestDate)-new Date(o.earliestRequestDate)),r.map(o=>({...o,filteredRows:o.filteredRows.map((i,l)=>({...i,No:l+1}))})).filter(o=>o.isVisible)},[y,C,h]),Q=(e,s,r)=>{r.stopPropagation();const o=e.filteredRows.filter(i=>!i.quotation_no||i.quotation_no==="-").map(i=>i.id);R(i=>s?[...new Set([...i,...o])]:i.filter(l=>!o.includes(l)))},G=e=>{var l;if(f.length===0){p.error("กรุณาเลือกอย่างน้อย 1 รายการ");return}const s=y.filter(u=>f.includes(u.id)),r=(l=s[0])==null?void 0:l.customer_id;if(!s.every(u=>u.customer_id===r)){p.error("กรุณาเลือกคำขอจากลูกค้าคนเดียวกันเท่านั้น");return}const i=new URLSearchParams({request_ids:f.join(","),customer_id:r,discount_percentage:"0",created_by:b==null?void 0:b.user_id});D(`/admin/issue-quotation/create?${i.toString()}`)};c.useEffect(()=>{localStorage.setItem("filterText",h)},[h]);const M=()=>{L(""),localStorage.removeItem("filterText")},$=e=>{D("/admin/issue-quotation/edit",{state:{id:e}})},v=async e=>{if(window.confirm("คุณต้องการลบข้อมูลใบเสนอราคา หรือไม่?")){w(!0);try{const r=await ie(e);console.log("deleteQuotations:",r),p.success("ลบข้อมูลใบเสนอราคาสำเร็จ!",{autoClose:3e3}),await E()}catch(r){p.error("ลบข้อมูลใบเสนอราคาไม่สำเร็จ!",{autoClose:3e3}),console.error("❌ Delete error:",r)}finally{w(!1)}}};return t.jsxs(j,{children:[t.jsx(j.Header,{children:t.jsx(B,{children:t.jsx(q,{children:t.jsx(j.Title,{as:"h5",children:"รายการออกใบเสนอราคา"})})})}),t.jsxs(j.Body,{className:"pt-3 pb-3",children:[t.jsxs(N,{direction:"row",spacing:1,sx:{mb:2},children:[t.jsx(k.Control,{type:"text",placeholder:"ค้นหาลูกค้า หรือ คำขอรับบริการ...",value:h,onChange:e=>L(e.target.value),disabled:g}),t.jsx(x,{variant:"primary",size:"sm",onClick:M,disabled:!h||g,children:t.jsx(J,{style:{fontSize:20}})})]}),g||!F?t.jsxs(N,{direction:"column",alignItems:"center",justifyContent:"center",sx:{py:4},children:[t.jsx(re,{}),t.jsx(I,{variant:"body1",sx:{mt:2},children:"กำลังโหลดข้อมูล..."})]}):T.length>0?T.map(e=>t.jsx(q,{md:12,className:"mb-3",style:{border:"1px solid #f8f9fa",borderRadius:10},children:t.jsxs(se,{defaultExpanded:!0,sx:{boxShadow:"none"},children:[t.jsx(ae,{expandIcon:t.jsx(oe,{}),sx:{backgroundColor:"#e8f5ff",borderRadius:0},children:t.jsxs(B,{className:"align-items-center w-100",children:[t.jsxs(q,{children:[t.jsxs("h6",{children:["รหัสลูกค้า : ",e.company_code," "," - ",e.company_name]}),t.jsxs("p",{className:"mb-0",children:["เลขที่ผู้เสียภาษี: ",t.jsx("span",{style:{color:"#343a40"},children:e.tax_id+" "}),"ที่อยู่: ",t.jsx("span",{style:{color:"#343a40"},children:" "+e.company_address})]})]}),t.jsx(q,{xs:"auto",children:t.jsxs(N,{direction:"row",spacing:2,alignItems:"center",children:[t.jsx(k.Check,{type:"checkbox",label:"เลือกทั้งหมด",className:"mb-0",onClick:s=>s.stopPropagation(),onChange:s=>Q(e,s.target.checked,s),checked:e.filteredRows.filter(s=>!s.quotation_no||s.quotation_no==="-").every(s=>f.includes(s.id)),disabled:e.filteredRows.every(s=>s.quotation_no&&s.quotation_no!=="-")}),t.jsx(x,{variant:"success",size:"sm",onClick:s=>{s.stopPropagation(),G(e.customer_id)},disabled:!f.some(s=>e.filteredRows.some(r=>r.id===s)),children:"สร้างใบเสนอราคา"})]})})]})}),t.jsx(ne,{children:e.filteredRows.length>0?t.jsx(le,{rows:e.filteredRows,columns:U,pageSize:5,rowsPerPageOptions:[5,10,20],pagination:!0,disableSelectionOnClick:!0,hideFooterSelectedRowCount:!0,loading:g,autoHeight:!0}):t.jsx(I,{variant:"body2",align:"center",children:"ไม่พบใบเสนอราคาสำหรับลูกค้านี้"})})]})},`customer-${e.customer_id}`)):t.jsxs("div",{className:"text-center py-4",children:[t.jsx(K,{size:24}),t.jsx(I,{variant:"body2",className:"mt-2",children:"ไม่พบข้อมูลใบเสนอราคาที่ตรงกับคำค้นหา"})]})]})]})};export{Ne as default};
