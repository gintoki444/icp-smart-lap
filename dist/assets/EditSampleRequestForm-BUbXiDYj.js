import{u as te,a as se,t as re,r as n,h as ae,j as _,B as M}from"./index-6YeC_AS5.js";import{c as j,g as I,a as o,h as q,F as _e}from"./formik.esm-C0GtiMNK.js";import{g as le}from"./specialConditionsRequest-B-G5iiQh.js";import{g as oe}from"./fertilizerTypesRequest-CzftO6V-.js";import{a as ne}from"./customerRequest-D-QXhSQD.js";import{a as me,k as pe,j as ce,i as de}from"./serviceRequest-CJ15hpJs.js";import{d as ue,p as fe,e as ye,c as T,b as he}from"./sampleSubmissionsRequest-bNYMIj3U.js";import{d as ge,h as ze}from"./uploadFileRequest-j7nqPy1R.js";import{S as Se}from"./StepForm-BvfMe8oP.js";import{F as qe}from"./Form-CGCyrcfL.js";import{C as g}from"./Card-BhOVTKNa.js";import"./firebaseConfig-pMHECxRz.js";import"./CountrySelect-DQQwKg9k.js";import"./react-select.esm-jYPj7h1v.js";import"./toPropertyKey-CTo9CRTC.js";import"./emotion-element-f0de968e.browser.esm-C-W82wov.js";import"./setPrototypeOf-DgZC2w_0.js";import"./packageingTypeRequest-CUTcv2jf.js";import"./testItemsRequest-CIY3wZGW.js";import"./index-DRJWWvqM.js";import"./tslib.es6-RU1n5ZxP.js";import"./fertilizerMainRequest-kGbpd_0A.js";import"./fertilizerFormulasRequest-DNgpnBu6.js";import"./Modal-D05P99kH.js";import"./CloseButton-BYF_v0Zl.js";import"./Transition-rt6HDaS9.js";import"./TextField-DmQ6Lsg1.js";import"./DefaultPropsProvider-2RhE6zQB.js";const Xe=({userId:E})=>{var x;const w=te(),R=se(),{requestId:N}=re(),p=((x=R.state)==null?void 0:x.id)||N||null,[z,B]=n.useState(null),[S,P]=n.useState(null),[A,V]=n.useState(null),[O,$]=n.useState([]),[H,k]=n.useState([]),[y,d]=n.useState(null),[b,U]=n.useState(null),[u,G]=n.useState(E);n.useEffect(()=>{const e=localStorage.getItem("authToken");e&&ae(e).then(s=>{G(s.user.user_id)}).catch(s=>{console.error("Error authenticating user:",s),d("ไม่สามารถตรวจสอบผู้ใช้ได้")})},[]);const J=(e,s)=>{console.log("apiData:",e);const r=e.sample_submissions||[],a=r[0]||{};return r.map(t=>{console.log("sub.mail_delivery_location:",t.mail_delivery_location),console.log("companyData?.document_address:",s==null?void 0:s.document_address),console.log("sub.mail_delivery_location === companyData?.document_address:",t.mail_delivery_location===(s==null?void 0:s.document_address))}),{user_id:u||e.user_id,company_id:e.customer_id,analysisMethod:e.is_registration_analysis?"is_registration_analysis":"is_quality_check_analysis",notes:e.notes||"",sample_type_id:e.sample_type_id,reportMethod:[e.sr_is_self_pickup?"is_self_pickup":null,e.sr_pdf_email?"pdf_email":null,e.sr_is_mail_delivery?"is_mail_delivery":null].filter(Boolean),email:e.sr_pdf_email||"",sr_mail_delivery_location:e.sr_mail_delivery_location||"",fertilizerRecords:r.map(t=>({request_id:t.request_id,fertilizerCategory:t.is_single_fertilizer?"is_single_fertilizer":t.is_compound_fertilizer?"is_compound_fertilizer":t.is_mixed_fertilizer?"is_mixed_fertilizer":t.is_secondary_nutrient_fertilizer?"is_secondary_nutrient_fertilizer":null,fertilizer_main_id:t.fertilizer_main_id,fertilizer_type_id:t.fertilizer_type_id,fertilizer_other:t.fertilizer_other,color:t.color||"",formula_id:t.formula_id,fertilizer_formula:t.fertilizer_formula||"",common_name:t.common_name||"",trade_name:t.trade_name||"",trademark:t.trademark||"",manufacturer:t.manufacturer||"",manufacturer_country:t.manufacturer_country||"TH",supplier:t.supplier||"",supplier_country:t.supplier_country||"TH",composition:t.composition||"",sample_weight:t.sample_weight?parseFloat(t.sample_weight):null,sample_weight_unit:t.sample_weight_unit||"",packaging_id:t.packaging_id||null,packaging_other:t.packaging_other||"",submission_id:t.submission_id,test_items:(t.sample_submission_details||[]).map(l=>({test_item_id:l.test_item_id,test_percentage:l.test_percentage||""})),reportMethod:[t.is_self_pickup?"is_self_pickup":null,t.pdf_email?"pdf_email":null,t.is_mail_delivery?"is_mail_delivery":null].filter(Boolean),email:t.pdf_email||"",sameAddress:t.mail_delivery_location===(s==null?void 0:s.document_address),mail_delivery_location:t.mail_delivery_location||"",phone:a.phone||"",sampleDisposal:a.is_lab_dispose_sample?"is_lab_dispose_sample":a.is_collect_within_3_months?"is_collect_within_3_months":"is_return_sample",test_all_items:a.test_all_items!==null?!!a.test_all_items:!0,submitted_by:a.submitted_by||"",submitted_date:a.submission_date?new Date(a.submission_date).toISOString().split("T")[0]:"",submitted_phone:a.phone||"",other_requirements:a.other_requirements})),files:(e.service_request_documents||[]).map(t=>({name:t.file_name,path:t.file_path,document_id:t.document_id}))}},L=async e=>{try{const s=await me(e),r=await ne(s.customer_id);console.log("companyData :",r),V(r);const a=J(s,r);B(a),P(s),await ee(s.customer_id)}catch(s){console.error("Error fetching service request:",s),d("ไม่สามารถโหลดข้อมูลได้ กรุณาลองใหม่")}},K=async()=>{try{const e=await oe();$(e)}catch(e){console.error("Error fetching fertilizer types:",e)}};n.useEffect(()=>{p&&u?(L(p),K()):p||d("ไม่พบ Request ID")},[p,u]);const Q=j({analysisMethod:o().test("analysis-method-required","กรุณาเลือกวัตถุประสงค์การขอใช้บริการ",function(e){const{sample_type_id:s}=this.options.context;return s===1?e&&["is_registration_analysis","is_quality_check_analysis"].includes(e):!0}),notes:o().notRequired(),fertilizerRecords:I().min(1,"กรุณาเพิ่มข้อมูลปุ๋ยอย่างน้อยหนึ่งรายการ").of(j({fertilizer_type_id:q().required("กรุณาเลือกประเภทลักษณะปุ๋ย").typeError("กรุณาเลือกประเภทลักษณะปุ๋ย"),packaging_id:q().required("กรุณาเลือกภาชนะบรรจุ").typeError("กรุณาเลือกภาชนะบรรจุ"),color:o().required("กรุณากรอกสี"),fertilizer_formula:o().required("กรุณากรอกสูตรปุ๋ย"),common_name:o().required("กรุณากรอกชื่อสามัญ"),trade_name:o().required("กรุณากรอกชื่อการค้า"),trademark:o().required("กรุณากรอกเครื่องหมายการค้า"),manufacturer:o().required("กรุณากรอกชื่อผู้ผลิต"),manufacturer_country:o().required("กรุณากรอกประเทศของผู้ผลิต"),supplier:o().required("กรุณากรอกชื่อผู้จัดจำหน่าย"),supplier_country:o().required("กรุณากรอกประเทศของผู้จัดจำหน่าย"),composition:o().required("กรุณากรอกวัตถุส่วนประกอบของปุ๋ย"),sample_weight:q().required("กรุณากรอกปริมาณ").typeError("ปริมาณต้องเป็นตัวเลข").positive("ปริมาณต้องมากกว่า 0"),sample_weight_unit:o().required("กรุณากรอกหน่วย")})),files:I().min(1,"กรุณาอัปโหลดเอกสารอย่างน้อยหนึ่งไฟล์").required("กรุณาอัปโหลดเอกสาร")}),W=(e,s)=>e.customer_id!==s.company_id||e.is_registration_analysis!==(s.analysisMethod==="is_registration_analysis"?1:0)||e.is_quality_check_analysis!==(s.analysisMethod==="is_quality_check_analysis"?1:0)||e.sample_type_id!==s.sample_type_id||e.sr_is_self_pickup!==((s.reportMethod||[]).includes("is_self_pickup")?1:0)||e.sr_pdf_email!==((s.reportMethod||[]).includes("pdf_email")?s.email:"")||e.sr_is_mail_delivery!==((s.reportMethod||[]).includes("is_mail_delivery")?1:0)||e.notes!==s.notes,X=(e,s)=>{const r=["fertilizerCategory","fertilizer_main_id","fertilizer_type_id","color","formula_id","fertilizer_formula","common_name","trade_name","trademark","manufacturer","manufacturer_country","supplier","supplier_guest_country","composition","sample_weight","sample_weight_unit","packaging_id","packaging_other","test_all_items","sampleDisposal","submitted_by","submitted_phone","submitted_date"],a=(e.sample_submission_details||[]).map(t=>({test_item_id:t.test_item_id,test_percentage:t.test_percentage}));return r.some(t=>e[t]!==s[t])||JSON.stringify(a)!==JSON.stringify(s.test_items)},Y=async(e,s,r,a)=>{const t=e.filter(i=>!s.some(c=>c.submission_id===i.submission_id));await Promise.all(t.map(i=>ue(i.submission_id)));const l=s.map(async i=>{const c={request_id:r,is_single_fertilizer:i.fertilizerCategory==="is_single_fertilizer"?1:0,is_compound_fertilizer:i.fertilizerCategory==="is_compound_fertilizer"?1:0,is_mixed_fertilizer:i.fertilizerCategory==="is_mixed_fertilizer"?1:0,is_secondary_nutrient_fertilizer:i.fertilizerCategory==="is_secondary_nutrient_fertilizer"?1:0,fertilizer_main_id:i.fertilizer_main_id,fertilizer_type_id:i.fertilizer_type_id,fertilizer_other:i.fertilizer_other,color:i.color,fertilizer_formula:i.fertilizer_formula,common_name:i.common_name,trade_name:i.trade_name,trademark:i.trademark,manufacturer:i.manufacturer,manufacturer_country:i.manufacturer_country,supplier:i.supplier,supplier_country:i.supplier_country,composition:i.composition,sample_weight:String(i.sample_weight),sample_weight_unit:i.sample_weight_unit,packaging_id:i.packaging_id,packaging_other:i.packaging_other,is_self_pickup:(i.reportMethod||[]).includes("is_self_pickup")?1:0,pdf_email:(i.reportMethod||[]).includes("pdf_email")?i.email:"",is_mail_delivery:(i.reportMethod||[]).includes("is_mail_delivery")?1:0,mail_delivery_location:i.mail_delivery_location||"-",test_all_items:i.test_all_items?1:0,is_lab_dispose_sample:i.sampleDisposal==="is_lab_dispose_sample"?1:0,is_collect_within_3_months:i.sampleDisposal==="is_collect_within_3_months"?1:0,is_return_sample:i.sampleDisposal==="is_return_sample"?1:0,submitted_by:i.submitted_by,phone:i.submitted_phone,submission_date:i.submitted_date,formula_id:i.formula_id,other_requirements:i.other_requirements};if(i.submission_id){const h=e.find(m=>m.submission_id===i.submission_id);X(h,i)&&await fe(c,i.submission_id);const v=h.sample_submission_details||[],C=i.test_items||[],ie=v.filter(m=>!C.some(f=>f.test_item_id===m.test_item_id&&f.test_percentage===m.test_percentage));await Promise.all(ie.map(m=>ye(m.detail_id)));const F=C.filter(m=>!v.some(f=>f.test_item_id===m.test_item_id&&f.test_percentage===m.test_percentage));F.length>0&&await T({submission_id:i.submission_id,test_items:F})}else{const h=await he(c);i.test_items.length>0&&await T({submission_id:h.submission_id,test_items:i.test_items})}});await Promise.all(l)},Z=async(e,s,r)=>{const a=e.filter(l=>!s.some(i=>i.document_id===l.document_id));await Promise.all(a.map(async l=>{await ge(l.file_path),await ce(l.document_id)}));const t=s.filter(l=>!l.document_id);if(t.length>0){const l=await ze(t,"service-requests","service_");await Promise.all(l.map(i=>{const c=i.fileName.split("/").pop();return de({request_id:r,uploaded_by:u,file_name:c,file_path:i.fileName})}))}},D=async(e,{setSubmitting:s})=>{console.log("values:",e);try{const r={user_id:e.user_id,customer_id:e.company_id,is_registration_analysis:e.analysisMethod==="is_registration_analysis"?1:0,is_quality_check_analysis:e.analysisMethod==="is_quality_check_analysis"?1:0,sample_type_id:e.sample_type_id,sr_is_self_pickup:(e.reportMethod||[]).includes("is_self_pickup")?1:0,sr_pdf_email:(e.reportMethod||[]).includes("pdf_email")?e.email:"",sr_is_mail_delivery:(e.reportMethod||[]).includes("is_mail_delivery")?1:0,sr_mail_delivery_location:"-",notes:e.notes};W(S,e)&&await pe(r,p),await Y(S.sample_submissions,e.fertilizerRecords,p,e),await Z(S.service_request_documents,e.files,p),U("บันทึกการแก้ไขสำเร็จ"),d(null),setTimeout(()=>w("/request"),1e3)}catch(r){console.error("Error submitting form:",r),d("เกิดข้อผิดพลาดในการบันทึกข้อมูล")}finally{s(!1)}},ee=async e=>{try{const s=await le(e);console.log("handleGetCusSpacialCon :",s),k(Array.isArray(s)?s:[])}catch(s){console.error("Error fetching special conditions:",s),k([])}};return y?_.jsx("div",{className:"text-danger",children:y}):!z||!u?_.jsx("div",{children:"Loading..."}):_.jsx(_e,{initialValues:z,validationSchema:Q,onSubmit:D,enableReinitialize:!0,context:{sample_type_id:z.sample_type_id},children:({values:e,errors:s,touched:r,handleChange:a,handleBlur:t,setFieldValue:l,handleSubmit:i})=>_.jsx(qe,{onSubmit:i,children:_.jsxs(g,{children:[_.jsx(g.Header,{children:_.jsx("h5",{children:e.sample_type_id===1?"แก้ไขใบนำส่งตัวอย่างปุ๋ยอินทรีย์":"แก้ไขใบนำส่งตัวอย่างปุ๋ยเคมี เพื่อขึ้นทะเบียนปุ๋ย"})}),_.jsx(g.Body,{className:"p-0",children:_.jsx(Se,{values:e,errors:s,touched:r,handleChange:a,handleBlur:t,setFieldValue:l,company:A,spacialCon:H,fertilizerTypes:O,sampleType:e.sample_type_id})}),_.jsxs(g.Footer,{className:"text-start",children:[b&&_.jsx("div",{className:"text-success mb-2",children:b}),y&&_.jsx("div",{className:"text-danger mb-2",children:y}),_.jsxs(M,{variant:"primary",type:"submit",disabled:e.isSubmitting,children:[_.jsx("i",{className:"feather icon-save"})," บันทึก"]}),_.jsxs(M,{variant:"danger",onClick:()=>w("/request"),children:[_.jsx("i",{className:"feather icon-corner-up-left"})," ยกเลิก"]})]})]})})})};export{Xe as default};
