import{r as n,u as O,h as M,y as _,aE as V,j as t,R as w,C as h,B as p,i as W,k as $,F as J,w as K}from"./index-6YeC_AS5.js";import{e as Q,f as X}from"./serviceRequest-CJ15hpJs.js";import{g as Y}from"./specialConditionsRequest-B-G5iiQh.js";import{C as o}from"./Card-BhOVTKNa.js";import{S as Z}from"./Stack-DS5MSRky.js";import{F as ee}from"./Form-CGCyrcfL.js";import{B as te}from"./Badge-C_mrIdUk.js";import{D as se,B as ae}from"./DataGrid-DoczE-38.js";import"./DefaultPropsProvider-2RhE6zQB.js";import"./emotion-element-f0de968e.browser.esm-C-W82wov.js";import"./TextField-DmQ6Lsg1.js";import"./toPropertyKey-CTo9CRTC.js";import"./Transition-rt6HDaS9.js";import"./setPrototypeOf-DgZC2w_0.js";import"./Divider-mvYdwXE_.js";const ye=()=>{const[u,A]=n.useState(null),[g,T]=n.useState([]),[C,q]=n.useState([]),[y,F]=n.useState([]),[l,S]=n.useState(()=>localStorage.getItem("filterText")||""),[m,d]=n.useState(!1),j=O();n.useEffect(()=>{const e=localStorage.getItem("authToken");e&&(d(!0),M(e).then(s=>{A(s.user),z(s.user.user_id)}).catch(s=>{_.error("ไม่สามารถตรวจสอบผู้ใช้ได้"),console.error(s)}).finally(()=>d(!1)))},[]);const I=async e=>{try{return await Y(e)}catch(s){return console.error(s),null}},z=async e=>{try{const s=await V(e);if(s){const r=await Promise.all(s.filter(i=>i.status==="approved").map(async(i,f)=>{const x=await I(i.company_id);return{id:i.company_id,No:f+1,company_name:i.company_name||"ไม่ระบุชื่อบริษัท",company_code:i.company_code||"ไม่ระบุรหัส",company_address:i.company_address||"ไม่ระบุที่อยู่",document_address:i.document_address,tax_id:i.tax_id||"ไม่ระบุ",company_email:i.company_email,company_phone:i.company_phone,special_conditions:x||i.special_conditions,created_at:new Date(i.created_at).toLocaleString(),status:i.status,customer_contacts:i.customer_contacts}}));T(r);const a=r.filter(i=>i.special_conditions).flatMap(i=>Array.isArray(i.special_conditions)?i.special_conditions:[i.special_conditions]);F(a),await N(e)}}catch(s){_.error("เกิดข้อผิดพลาดในการดึงข้อมูลลูกค้า"),console.error(s)}},N=async e=>{d(!0);try{const s=await Q(e);if(s.success){const r=s.data.map((a,i)=>({id:a.request_id,No:i+1,request_date:new Date(a.request_date).toLocaleDateString("th-TH"),request_no:a.request_no||"-",user_id:a.user_id,user_name:a.user_name,customer_id:a.customer_id,customer_name:a.customer_name,sample_type_name:a.sample_type_name,is_registration_analysis:a.is_registration_analysis,is_quality_check_analysis:a.is_quality_check_analysis,sample_type_id:a.sample_type_id,special_conditions:a.special_conditions||"-",created_at:new Date(a.created_at).toLocaleDateString("th-TH"),status:a.status,quotation_id:a.quotation_id,quotation_no:a.quotation_no,quotation_date:a.quotation_date,service_status_logs:a.service_status_logs,sample_submissions:a.sample_submissions,request_id_list_by_quotation:a.request_id_list_by_quotation||null,submission_count:a.sample_submissions.length,service_request_documents:a.service_request_documents}));q(r)}else q([])}catch(s){_.error("เกิดข้อผิดพลาดในการดึงข้อมูลคำขอ"),console.error(s)}finally{d(!1)}},E=[{field:"No",headerName:"No.",width:90,headerAlign:"center",align:"center"},{field:"request_no",headerName:"เลขที่คำขอ",flex:.8},{field:"sample_type_name",headerName:"ประเภทปุ๋ย",flex:.7},{field:"request_date",headerName:"วันที่สร้าง",flex:1},{field:"quotation_no",headerName:"ออกใบเสนอราคา",flex:1,headerAlign:"center",align:"center",renderCell:e=>t.jsx(t.Fragment,{children:e.row.quotation_no?e.row.quotation_no:"-"})},{field:"submission_count",headerName:"จำนวนตัวอย่าง",flex:1,headerAlign:"center",align:"center"},{field:"status",headerName:"สถานะ",width:120,headerAlign:"center",align:"center",renderCell:e=>t.jsx(te,{pill:!0,bg:e.row.status==="pending"?"warning":e.row.status==="rejected"?"danger":"success",children:e.row.status==="pending"?"กำลังดำเนินการ":e.row.status==="rejected"?"ไม่อนุมัติ":"อนุมัติ"})},{field:"actions",headerName:"Action",width:200,headerAlign:"center",align:"center",renderCell:e=>t.jsxs(ae,{children:[t.jsx(p,{variant:"primary",size:"sm",onClick:()=>j("/request/detial",{state:{id:e.row.id}}),children:t.jsx("i",{className:"feather icon-file-text m-0"})}),t.jsx(p,{variant:"info",size:"sm",disabled:e.row.request_id_list_by_quotation||e.row.status==="rejected",onClick:()=>U(e.row),children:t.jsx(J,{})}),t.jsx(p,{variant:"outline-danger",size:"sm",disabled:e.row.request_id_list_by_quotation||e.row.status==="rejected",onClick:()=>v(e.row.id),children:t.jsx(K,{})})]})}],H=()=>{if(!l.trim())return g.map(s=>({...s,filteredRows:C.filter(r=>r.customer_id===s.id)}));const e=l.toLowerCase();return g.map(s=>{var i,f,x;const r=C.filter(c=>{var R,k,D,L,B;return c.customer_id!==s.id?!1:((R=c.request_no)==null?void 0:R.toLowerCase().includes(e))||((k=c.sample_type_name)==null?void 0:k.toLowerCase().includes(e))||((D=c.request_date)==null?void 0:D.toLowerCase().includes(e))||((L=c.notes)==null?void 0:L.toLowerCase().includes(e))||((B=c.status)==null?void 0:B.toLowerCase().includes(e))}),a=((i=s.company_name)==null?void 0:i.toLowerCase().includes(e))||((f=s.tax_id)==null?void 0:f.toLowerCase().includes(e))||((x=s.company_address)==null?void 0:x.toLowerCase().includes(e));return{...s,filteredRows:r,isVisible:a||r.length>0}}).filter(s=>s.isVisible)};n.useEffect(()=>{localStorage.setItem("filterText",l)},[l]);const P=()=>{S(""),localStorage.removeItem("filterText")},U=e=>{j("/request/edit/",{state:{id:e.id,customer:g}})},v=async e=>{if(window.confirm("คุณต้องการลบข้อมูลคำขอรับบริการ หรือไม่?")){d(!0);try{const r=await X(e);if((r==null?void 0:r.status)>=200&&(r==null?void 0:r.status)<300)_.success("ลบข้อมูลคำขอรับบริการสำเร็จ!",{autoClose:3e3}),u!=null&&u.user_id&&await N(u.user_id);else throw new Error("API ไม่สำเร็จ")}catch(r){_.error("ลบข้อมูลคำขอรับบริการไม่สำเร็จ!",{autoClose:3e3}),console.error("❌ Delete error:",r)}finally{d(!1)}}},G=e=>{j("/request/add",{state:{user:u,customer:e}})},b=H();return t.jsxs(o,{children:[t.jsx(o.Header,{children:t.jsx(w,{children:t.jsx(h,{children:t.jsx(o.Title,{as:"h5",children:"รายการคำขอรับบริการ"})})})}),t.jsxs(o.Body,{children:[t.jsxs(Z,{direction:"row",spacing:1,sx:{mb:2},children:[t.jsx(ee.Control,{type:"text",placeholder:"ค้นหาลูกค้า หรือ คำขอรับบริการ...",value:l,onChange:e=>S(e.target.value),disabled:m}),t.jsx(p,{variant:"primary",size:"sm",onClick:P,disabled:!l||m,children:t.jsx(W,{style:{fontSize:20}})})]}),m?t.jsx("div",{children:"Loading..."}):b.length>0?b.map(e=>t.jsxs(o,{className:"mb-3 rounded",children:[t.jsx(o.Header,{style:{background:"#e8f5ff"},children:t.jsxs(w,{className:"align-items-center",children:[t.jsxs(h,{children:[t.jsxs(o.Title,{as:"h6",children:[t.jsx("spen",{style:{fontWeigth:"300"},children:"รหัสลูกค้า"}),": ",e.company_code," - ",e.company_name]}),t.jsxs(w,{children:[t.jsx(h,{md:6,children:t.jsxs("p",{className:"mb-0",children:["เลขที่ผู้เสียภาษี: ",t.jsx("span",{className:"text-dark",children:e.tax_id+" "}),"ที่อยู่: ",t.jsx("span",{className:"text-dark",children:" "+e.company_address})]})}),y&&y.length>0&&t.jsx(h,{md:6,children:t.jsxs("p",{className:"mb-0",children:["เงื่อนไขพิเศษ :"," ",t.jsx("strong",{className:"text-dark",children:y.filter(s=>s.company_id===e.id).map((s,r,a)=>r+1<a.length?`${s.description}, `:s.description)})]})})]})]}),t.jsx(h,{xs:"auto",children:t.jsxs(p,{variant:"success",size:"sm",onClick:()=>G(e),disabled:m,children:[t.jsx("i",{className:"feather icon-plus-circle"})," เพิ่มคำขอ"]})})]})}),t.jsx(o.Body,{children:e.filteredRows.length>0?t.jsx(se,{rows:e.filteredRows,columns:E,pageSize:5,rowsPerPageOptions:[5,10,20],pagination:!0,disableSelectionOnClick:!0,hideFooterSelectedRowCount:!0,loading:m,autoHeight:!0}):t.jsx("div",{className:"text-center",children:t.jsx("p",{className:"mt-2",children:"ไม่พบคำขอรับบริการสำหรับบริษัทนี้"})})})]},`customer-${e.id}`)):t.jsxs("div",{className:"text-center py-4",children:[t.jsx($,{size:24}),t.jsx("p",{className:"mt-2",children:"ไม่พบข้อมูลลูกค้าหรือคำขอรับบริการที่ตรงกับคำค้นหา"})]})]})]})};export{ye as default};
