import{u as H,r as n,j as e,B as g,a as G,h as Q,R as W,C as f,y as A}from"./index-CMKGjvil.js";import{h as L,i as J,p as K}from"./serviceRequest-CJ15hpJs.js";import{b as P,c as X}from"./sampleSubmissionsRequest-bNYMIj3U.js";import{h as Y}from"./uploadFileRequest-j7nqPy1R.js";import{c as T,g as $,a as l,h as R,F as Z}from"./formik.esm-PXS3-tw9.js";import{g as ee}from"./fertilizerTypesRequest-CzftO6V-.js";import{S as se}from"./StepForm-ajKEt0C6.js";import{F as ie}from"./Form-XAT3KesX.js";import{C as p}from"./Card-ltuRbL1m.js";import{g as te}from"./specialConditionsRequest-B-G5iiQh.js";import{a as re}from"./customerRequest-D-QXhSQD.js";import{M as E}from"./Modal-KDP3gSJa.js";import"./firebaseConfig-pMHECxRz.js";import"./CountrySelect-5rKmeoAR.js";import"./react-select.esm-Df4SyQAq.js";import"./toPropertyKey-BZFHAmHd.js";import"./emotion-element-f0de968e.browser.esm-D2ySOhvj.js";import"./setPrototypeOf-DgZC2w_0.js";import"./packageingTypeRequest-CUTcv2jf.js";import"./testItemsRequest-CIY3wZGW.js";import"./index-NmPNhDG7.js";import"./tslib.es6-RU1n5ZxP.js";import"./fertilizerMainRequest-kGbpd_0A.js";import"./fertilizerFormulasRequest-DNgpnBu6.js";import"./TextField-l4tn0KBj.js";import"./DefaultPropsProvider-7CXMMYWk.js";import"./Transition-CvY6YelV.js";import"./CloseButton-DXA2z1Sn.js";const ae=({onHandleSave:x,userId:y,sampleType:d,company:j,spacialCon:S})=>{const v=H(),[b,q]=n.useState([]),a={user_id:y,company_id:j.company_id,analysisMethod:"is_registration_analysis",spacialCon:"",notes:"",sample_type_id:d,fertilizerRecords:[],files:[]},m=T({analysisMethod:l().test("analysis-method-required","กรุณาเลือกวัตถุประสงค์การขอใช้บริการ",function(r){const{sample_type_id:o}=this.options.context;return o===1?r&&["is_registration_analysis","is_quality_check_analysis"].includes(r):!0}),notes:l().notRequired(),fertilizerRecords:$().min(1,"กรุณาเพิ่มข้อมูลปุ๋ยอย่างน้อยหนึ่งรายการ").of(T({fertilizer_type_id:R().required("กรุณาเลือกประเภทลักษณะปุ๋ย").typeError("กรุณาเลือกประเภทลักษณะปุ๋ย"),packaging_id:R().required("กรุณาเลือกภาชนะบรรจุ").typeError("กรุณาเลือกภาชนะบรรจุ"),color:l().required("กรุณากรอกสี"),trade_name:l().required("กรุณากรอกชื่อการค้า"),trademark:l().required("กรุณากรอกเครื่องหมายการค้า"),manufacturer:l().required("กรุณากรอกชื่อผู้ผลิต"),manufacturer_country:l().required("กรุณากรอกประเทศของผู้ผลิต"),supplier:l().required("กรุณากรอกชื่อผู้จัดจำหน่าย"),supplier_country:l().required("กรุณากรอกประเทศของผู้จัดจำหน่าย"),composition:l().required("กรุณากรอกวัตถุส่วนประกอบของปุ๋ย"),sample_weight:R().required("กรุณากรอกปริมาณ").typeError("ปริมาณต้องเป็นตัวเลข").positive("ปริมาณต้องมากกว่า 0"),sample_weight_unit:l().required("กรุณากรอกหน่วย")})),files:$().min(1,"กรุณาอัปโหลดเอกสารอย่างน้อยหนึ่งไฟล์").required("กรุณาอัปโหลดเอกสาร")}),k=async(r,{setSubmitting:o,validateForm:_})=>{console.log("Submitting - Values:",r);const c=await _();console.log("Submitting - Errors:",c),Object.keys(c).length===0?(console.log("Form Values:",r),x(r)):console.log("Validation Errors:",c),o(!1)},z=async()=>{try{const r=await ee();q(r)}catch(r){console.error("Error fetching fertilizer types:",r)}};return n.useEffect(()=>{z()},[]),e.jsx(Z,{initialValues:a,validationSchema:m,onSubmit:k,validateOnChange:!0,validateOnBlur:!0,validationContext:{sample_type_id:d},children:({values:r,errors:o,touched:_,handleChange:c,handleBlur:w,setFieldValue:C,handleSubmit:F,validateForm:N})=>(console.log("Formik values:",r),console.log("Formik Errors:",o),e.jsx(ie,{onSubmit:F,children:e.jsxs(p,{children:[e.jsx(p.Header,{children:e.jsx("h5",{children:d===1?e.jsxs(e.Fragment,{children:["ลงทะเบียนใบนำส่งตัวอย่าง",e.jsx("strong",{style:{color:"#8B4513"},children:" ปุ๋ยอินทรีย์"})]}):e.jsxs(e.Fragment,{children:["ลงทะเบียนใบนำส่งตัวอย่าง",e.jsx("strong",{style:{color:"#28A745"},children:" ปุ๋ยเคมี"})]})})}),e.jsx(p.Body,{className:"p-0",children:e.jsx(se,{values:r,errors:o,touched:_,handleChange:c,handleBlur:w,setFieldValue:C,company:j,spacialCon:S,fertilizerTypes:b,sampleType:d,validateForm:N})}),e.jsxs(p.Footer,{className:"text-start",children:[e.jsxs(g,{variant:"primary",type:"submit",children:[e.jsx("i",{className:"feather icon-save"})," บันทึก"]}),e.jsxs(g,{variant:"danger",onClick:()=>v("/request"),children:[e.jsx("i",{className:"feather icon-corner-up-left"})," ยกเลิก"]})]})]})}))})},le="/assets/logo-fertilizer-organic-BI1yMMGv.webp",oe="/assets/logo-fertilizer-chemical-C2QnQa7w.webp",Ie=()=>{var N,I;const x=H(),[y,d]=n.useState(null),[j,S]=n.useState(null),[v,b]=n.useState(!1),q=G();(N=q.state)!=null&&N.user;const a=((I=q.state)==null?void 0:I.customer)||null,[m,k]=n.useState({}),[z,r]=n.useState({}),[o,_]=n.useState([]);n.useEffect(()=>{const i=localStorage.getItem("authToken");C(a==null?void 0:a.id),w(a==null?void 0:a.id),i&&Q(i).then(t=>{_(t.user)})},[]);const c=i=>{d(i),i==="organic"?S(1):i==="chemical"&&S(2)},w=async i=>{try{const t=await re(i);console.log("getCustomerByID:",t),r(t)}catch(t){console.error(t),r([])}},C=async i=>{try{const t=await te(i);k(Array.isArray(t)?t:[])}catch(t){console.error(t),k([])}},F=async i=>{console.log(i);const t={user_id:o.user_id,customer_id:i.company_id,is_registration_analysis:i.analysisMethod==="is_registration_analysis"?1:0,is_quality_check_analysis:i.analysisMethod==="is_quality_check_analysis"?1:0,sample_type_id:i.sample_type_id,sr_is_self_pickup:(i.reportMethod||[]).includes("is_self_pickup")?1:0,sr_pdf_email:(i.reportMethod||[]).includes("pdf_email")?i.email:"",sr_is_mail_delivery:(i.reportMethod||[]).includes("is_self_pickup")?1:0,sr_mail_delivery_location:"-",notes:i.notes};console.log(t);let M=[];i.fertilizerRecords.forEach(s=>{const B={request_id:null,is_single_fertilizer:s.fertilizer_main_id===1?1:0,is_compound_fertilizer:s.fertilizer_main_id===2?1:0,is_mixed_fertilizer:s.fertilizer_main_id===3?1:0,is_secondary_nutrient_fertilizer:s.fertilizer_main_id===4?1:0,fertilizer_type_id:s.fertilizer_type_id,fertilizer_other:s.fertilizer_other,color:s.color,fertilizer_formula:s.fertilizer_formula,packaging_other:s.packaging_other,common_name:s.common_name,trade_name:s.trade_name,trademark:s.trademark,manufacturer:s.manufacturer,manufacturer_country:s.manufacturer_country,supplier:s.supplier,supplier_country:s.supplier_country,composition:s.composition,sample_weight:s.sample_weight,sample_weight_unit:s.sample_weight_unit,packaging_id:s.packaging_id,pdf_email:(s.reportMethod||[]).includes("pdf_email")?s.email:"",is_self_pickup:(s.reportMethod||[]).includes("is_self_pickup")?1:0,is_mail_delivery:(s.reportMethod||[]).includes("pdf_email")?1:0,mail_delivery_location:s.mail_delivery_location,test_all_items:s.test_all_items,is_lab_dispose_sample:s.sampleDisposal==="is_lab_dispose_sample"?1:0,is_collect_within_3_months:s.sampleDisposal==="is_collect_within_3_months"?1:0,is_return_sample:s.sampleDisposal==="is_return_sample"?1:0,submitted_by:s.submitted_by,phone:s.submitted_phone,test_items:s.test_items,formula_id:s.formula_id,fertilizer_main_id:s.fertilizer_main_id,other_requirements:s.other_requirements};M.push(B)}),console.log(M);const O=i.files;try{console.log("step1:",t);const s=await L(t);if(s.request_id){for(const u of M){u.request_id=s.request_id;const h=await P(u);if(console.log("responseSample:",h),h.submission_id){const D={submission_id:h.submission_id,test_items:u.test_items},U=await X(D);console.log("responseTestItem:",U)}}const B=await Y(O,"service-requests","service_");for(const u of B){const h=u.fileName.split("/").pop(),D={request_id:s.request_id,uploaded_by:o.user_id,file_name:h,file_path:`/${u.fileName}`};await J(D)}const V={newStatusTracking:"requested"};await K(s.request_id,V),A.success("เพิ่มข้อมูลคำขอรับบริการสำเร็จ!",{autoClose:3e3}),x("/request/detial",{state:{id:s.request_id}}),b(!0)}}catch(s){console.log("Error:",s),A.error("เพิ่มข้อมูลคำขอรับบริการไม่สำเร็จ!",{autoClose:3e3}),alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล:",s)}};return e.jsxs(e.Fragment,{children:[y===null&&e.jsxs(p,{children:[e.jsx(p.Header,{children:e.jsx("h5",{children:"เลือกประเภทการขอรับบริการ"})}),e.jsxs(p.Body,{children:[e.jsxs(W,{className:"mb-4",children:[e.jsx(f,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["รหัสลูกค้า : ",e.jsx("strong",{className:"text-dark",children:z.company_code})," ",e.jsx("span",{className:"text-dark",children:"(กรณีมีการเปลี่ยนแปลง ชื่อ, ที่อยู่ กรุณาแจ้งห้องปฏิบัติการ)"})]})}),e.jsx(f,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ชื่อบริษัท : ",e.jsx("strong",{className:"text-dark",children:a.company_name})]})}),e.jsx(f,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["เลขที่ผู้เสียภาษี : ",e.jsx("strong",{className:"text-dark",children:a.tax_id})]})}),e.jsx(f,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ที่อยู่ : ",e.jsx("strong",{className:"text-dark",children:a.company_address})]})}),m&&m.length>0&&e.jsx(f,{md:6,children:e.jsxs("p",{className:"mb-0",children:["เงื่อนไขพิเศษ :"," ",e.jsx("strong",{className:"text-dark",children:m.map((i,t)=>e.jsxs("span",{children:[i.description,t+1<m.length&&", "]},t))})]})})]}),e.jsxs("div",{className:"d-flex justify-content-center gap-3 align-items-start",children:[e.jsxs(g,{variant:"outline",className:"py-4 d-flex align-items-center justify-content-center flex-column",style:{width:"300px",color:"#8B4513",fontSize:"18px",fontWeight:"bold"},onClick:()=>c("organic"),children:[e.jsx("div",{className:"logo-fertilizer-style",style:{border:"solid 3px #8B4513"},children:e.jsx("img",{src:le,alt:"ปุ๋ยอินทรีย์",style:{width:"175px",height:"175px",padding:"12px"}})}),"แบบฟอร์มนำส่งตัวอย่างปุ๋ยอินทรีย์"]}),e.jsxs(g,{variant:"outline",className:"py-4 d-flex align-items-center justify-content-center flex-column",style:{width:"300px",color:"#28A745",fontSize:"18px",fontWeight:"bold"},onClick:()=>c("chemical"),children:[e.jsx("div",{className:"logo-fertilizer-style",style:{border:"solid 3px #28A745"},children:e.jsx("img",{src:oe,alt:"ปุ๋ยเคมี",style:{width:"175px",height:"175px",padding:"12px"}})}),e.jsxs("div",{children:["แบบฟอร์มนำส่งตัวอย่างปุ๋ยเคมี",e.jsx("br",{}),"(เพื่อขึ้นทะเบียนปุ๋ย)"]})]})]})]})]}),y!==null&&e.jsx(ae,{userId:o.user_id,onHandleSave:F,sampleType:j,company:z,spacialCon:m}),e.jsxs(E,{show:v,onHide:()=>b(!1),centered:!0,children:[e.jsxs(E.Body,{className:"text-center",children:[e.jsx("i",{className:"text-success",style:{fontSize:"3rem"},children:"✔"}),e.jsx("h5",{className:"mt-3",children:"ลงทะเบียนขอรับบริการสำเร็จ"}),e.jsx("p",{children:"กรุณารอผลการตรวจสอบคำขอใช้บริการ"})]}),e.jsx(E.Footer,{children:e.jsx(g,{variant:"success",onClick:()=>x("/request/"),children:"ปิด"})})]})]})};export{Ie as default};
