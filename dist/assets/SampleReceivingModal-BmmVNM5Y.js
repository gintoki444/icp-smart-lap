import{G as C,r as v,j as e,B as k,y as _}from"./index-CMKGjvil.js";import{c as Q,e as W,d as X,a as H,F as Y}from"./formik.esm-PXS3-tw9.js";import"./firebaseConfig-pMHECxRz.js";import{a as M}from"./trackingRequest-nQukaRQe.js";import{F as z,I as Z}from"./FirebaseImage-D-uA0S8P.js";import{a as ee,g as te}from"./sampleSubmissionsRequest-bNYMIj3U.js";import{c as se,a as ae,p as w,d as B}from"./serviceRequest-CJ15hpJs.js";import{T as ie}from"./Table-Co_68gz0.js";import{B as re}from"./Badge-Degbu7BZ.js";import{B as ne,b as O}from"./DataGrid-BSrFaLwh.js";import{M as j}from"./Modal-KDP3gSJa.js";import{F as i}from"./Form-XAT3KesX.js";function oe(o){return C({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"m12 5.5 6 4.5v1c.7 0 1.37.1 2 .29V9l-8-6-8 6v12h7.68c-.3-.62-.5-1.29-.6-2H6v-9l6-4.5z"},child:[]},{tag:"path",attr:{d:"M18 13c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm3 5.5h-2.5V21h-1v-2.5H15v-1h2.5V15h1v2.5H21v1z"},child:[]}]})(o)}function Le(o){return C({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0V0z"},child:[]},{tag:"path",attr:{d:"M18 2h-8L4 8v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 2v16H6V8.83L10.83 4H18z"},child:[]},{tag:"path",attr:{d:"m16 13-4 4-4-4 1.41-1.41L11 13.17V9.02L13 9v4.17l1.59-1.59L16 13z"},child:[]}]})(o)}function ce(o){return C({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0V0z",opacity:".87"},child:[]},{tag:"path",attr:{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"},child:[]}]})(o)}const q="https://apiav2-jlp2nagalq-as.a.run.app/api",le=async o=>{const l=new Headers;l.append("Content-Type","application/json"),console.log("postSampleStatus",o);const b=JSON.stringify(o),f={method:"POST",headers:l,body:b,redirect:"follow"};try{const u=await fetch(q+"/sample-status-array",f);if(!u.ok){const L=await u.json();throw new Error(L.message||`HTTP Error: ${u.status}`)}return await u.json()}catch(u){throw console.error("Save SampleStatus data Error:",u),u}},de=async o=>{const l=new Headers;l.append("Content-Type","application/json");const b={method:"DELETE",headers:l,redirect:"follow"};return await(await fetch(q+"/sample-status/"+o,b)).json()},Ne=({serviceData:o,submissionId:l,handleTracking:b,trackingData:f,reviewBy:u,sampleNo:L,reloadData:F,sampleStatus:A,serviceRequestId:h})=>{const[me,ue]=v.useState(o),[pe,he]=v.useState(!1),[G,S]=v.useState(!1),[y,V]=v.useState(f),[x,P]=v.useState(null),[T,$]=v.useState([]);v.useEffect(()=>{(()=>{V(f),$(A.sample_status_tracking)})()},[F]);const R=Q({carrier_name:H().required("กรุณาเลือกผู้ให้บริการจัดส่ง"),tracking_number:H().required("กรุณากรอกหมายเลข Tracking"),proof_image:X().nullable(),deliveredToLab:W().oneOf([!0],'กรุณาเลือก "ตัวอย่างจัดส่งถึงแลป"')}),N=async()=>{try{const t=await te(h),s=t.length,n=(await ae(h)).service_status_logs||{},r=t.reduce((c,E)=>{const I=(E.sample_tracking||[]).some(D=>D.submission_id===E.submission_id&&D.received_by!==null);return c+(I?1:0)},0)===s,g=t.flatMap(c=>c.sample_status_tracking||[]),a=g.some(c=>c.status==="delivered_to_lab");console.log("isSampleSentComplete",r),console.log("hasDeliveredToLab",a),console.log("statusLogs.sample_sent",n.sample_sent),r&&a&&n.sample_sent===null&&(await w(h,{newStatusTracking:"sample_sent"}),_.success("สถานะอัปเดต: ตัวอย่างถูกส่งครบแล้ว",{autoClose:3e3}));const p=g.filter(c=>c.status==="delivered_to_lab").length;p>=s&&n.sample_arrived_lab===null?(await w(h,{newStatusTracking:"sample_arrived_lab"}),_.success("สถานะอัปเดต: ตัวอย่างจัดส่งถึงแลปครบแล้ว",{autoClose:3e3})):p<s&&n.sample_arrived_lab!==null&&(await B(h,{StatusTracking:"sample_arrived_lab"}),_.info("สถานะถูกลบ: ตัวอย่างยังไม่ถึงแลปครบ",{autoClose:3e3}));const m=g.filter(c=>c.status==="received_in_system").length;m>=s&&n.sample_received===null?(await w(h,{newStatusTracking:"sample_received"}),_.success("สถานะอัปเดต: รับตัวอย่างเข้าระบบครบแล้ว",{autoClose:3e3})):m<s&&n.sample_received!==null&&(await B(h,{StatusTracking:"sample_received"}),_.info("สถานะถูกลบ: ตัวอย่างยังไม่ถูกรับเข้าระบบครบ",{autoClose:3e3}))}catch(t){console.error("Error in checkAndUpdateStatus:",t),_.error("เกิดข้อผิดพลาดในการอัปเดตสถานะ",{autoClose:3e3})}},U=async(t,{setSubmitting:s,setErrors:n})=>{var d;try{let r=[];const g=(d=o.sample_submissions.find(a=>a.submission_id===l))==null?void 0:d.submission_no;if(console.log("serviceData.sample_submissions.find:",o.sample_submissions.find(a=>a.submission_id===l)),console.log("submissionNo:",g),g||await ee(l),o.request_no||await se(h),t.deliveredToLab){const a={submission_id:l,status:"delivered_to_lab",notes:"ตัวอย่างจัดส่งถึงแล็บ"};T.some(m=>m.submission_id===a.submission_id&&m.status===a.status)||r.push({...a,id:r.length+1})}if(t.receiveOption==="received"){const a={submission_id:l,status:"received_in_system",notes:"รับตัวอย่างเข้าระบบ"};T.some(m=>m.submission_id===a.submission_id&&m.status===a.status)||r.push({...a,id:r.length+1})}if(r.length>0){const a=await le(r);console.log("postSampleStatusArray:",a)}if(l&&!t.received_by){const a={status:"in_processing",received_by:u},p=await M(x.tracking_id,a);console.log("responseSampleTracking:",p),b(!0),S(!1)}await N()}catch(r){console.error("Error updating tracking data:",r),n({submit:"เกิดข้อผิดพลาดในการแก้ไขข้อมูล กรุณาลองใหม่"}),s(!1)}},J=t=>{const s=y.find(n=>n.tracking_id===t);console.log("dataToEdit:",s),P(s),S(!0)},K=async t=>{if(window.confirm("คุณต้องการลบข้อมูลการจัดส่งตัวอย่าง หรือไม่?"))try{T.map(r=>{(r.status==="received_in_system"||r.status==="delivered_to_lab")&&de(r.id)}),await M(t,{status:"received",received_by:null})&&(_.success("ยกเลิกการรับตัวอย่างสำเร็จ!",{autoClose:3e3}),b(!0)),await N()}catch(n){_.error("ยกเลิกการรับตัวอย่างไม่สำเร็จ! :"+n,{autoClose:3e3})}};return e.jsxs(e.Fragment,{children:[e.jsx("h6",{className:"mb-3 mt-3",children:"ข้อมูลการจัดส่งตัวอย่าง"}),e.jsxs(ie,{striped:!0,bordered:!0,hover:!0,className:"mt-2",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{width:80,className:"text-center",children:"#"}),e.jsx("th",{children:"ผู้ให้บริการจัดส่ง"}),e.jsx("th",{children:"หมายเลข Tracking"}),e.jsx("th",{className:"text-center",width:180,children:"สถานะ"}),e.jsx("th",{className:"text-center",children:"หลักฐานการส่ง"}),e.jsx("th",{className:"text-center",children:"Action"})]})}),e.jsx("tbody",{children:y.length>0?y.map((t,s)=>e.jsxs("tr",{children:[e.jsx("td",{className:"text-center",children:s+1}),e.jsx("td",{children:t.carrier_name}),e.jsx("td",{children:t.tracking_number}),e.jsx("td",{className:"text-center",children:e.jsx(re,{pill:!0,bg:t.status==="received"?"info":t.status==="in_processing"?"warning":t.status==="completed"?"primary":"success",children:t.status==="received"?"ดำเนินการจัดส่ง":t.status==="in_processing"?"กำลังทดสอบ":t.status==="completed"?"ทดสอบเสร็จสิ้น":"จัดส่งสำเร็จ"})}),e.jsx("td",{className:"text-center",children:e.jsx(z,{imagePath:t.proof_image,alt:`Proof for ${t.tracking_number}`,style:{maxHeight:"100px"},thumbnail:!0})}),e.jsx("td",{className:"text-center",width:200,children:e.jsx(ne,{children:t.received_by?e.jsx(O,{title:"ยกเลิกรับตัวอย่าง",placement:"bottom",arrow:!0,children:e.jsxs(k,{variant:"danger",size:"sm",onClick:()=>K(t.tracking_id),children:[e.jsx(ce,{})," ยกเลิกรับตัวอย่าง"]})}):e.jsx(O,{title:"รับตัวอย่าง",placement:"bottom",arrow:!0,children:e.jsxs(k,{variant:"success",size:"sm",onClick:()=>J(t.tracking_id),children:[e.jsx(oe,{className:"me-2",style:{fontSize:16}})," รับตัวอย่าง"]})})})})]},`${t.tracking_number}-${t.id}`)):e.jsx("tr",{children:e.jsx("th",{width:80,className:"text-center",colSpan:6,children:"ไม่มีข้อมูล"})})})]}),x&&e.jsxs(j,{show:G,onHide:()=>S(!1),centered:!0,children:[e.jsx(j.Header,{closeButton:!0,children:e.jsx(j.Title,{children:e.jsx("h6",{children:"ยืนยันการรับตัวอย่าง"})})}),e.jsx(Y,{initialValues:{carrier_name:x.carrier_name,tracking_number:x.tracking_number,proof_image:null,status:x.status,received_by:x.received_by,deliveredToLab:!1,receiveOption:"not_received"},validationSchema:R,onSubmit:U,children:({values:t,errors:s,touched:n,handleChange:d,handleBlur:r,handleSubmit:g,setFieldValue:a,isSubmitting:p})=>e.jsxs(i,{onSubmit:g,children:[e.jsxs(j.Body,{children:[s.submit&&e.jsx("div",{className:"text-danger mb-3",children:s.submit}),e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"ผู้ให้บริการจัดส่ง"}),e.jsxs(i.Select,{name:"carrier_name",value:t.carrier_name,onChange:d,onBlur:r,isInvalid:n.carrier_name&&!!s.carrier_name,children:[e.jsx("option",{value:"",children:"เลือกผู้ให้บริการจัดส่ง"}),e.jsx("option",{value:"ไปรษณีย์ไทย",children:"ไปรษณีย์ไทย"}),e.jsx("option",{value:"Kerry Express",children:"Kerry Express"}),e.jsx("option",{value:"J&T Express",children:"J&T Express"}),e.jsx("option",{value:"DHL",children:"DHL"})]}),e.jsx(i.Control.Feedback,{type:"invalid",children:s.carrier_name})]}),e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"หมายเลข Tracking"}),e.jsx(i.Control,{type:"text",name:"tracking_number",placeholder:"กรอกหมายเลข Tracking",value:t.tracking_number,onChange:d,onBlur:r,isInvalid:n.tracking_number&&!!s.tracking_number}),e.jsx(i.Control.Feedback,{type:"invalid",children:s.tracking_number})]}),e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"หลักฐานการส่ง (ถ้าต้องการเปลี่ยน)"}),e.jsx(i.Control,{type:"file",accept:"image/*",onChange:m=>a("proof_image",m.target.files[0]),isInvalid:n.proof_image&&!!s.proof_image}),e.jsx("div",{className:"mt-3",children:t.proof_image?e.jsx(Z,{src:URL.createObjectURL(t.proof_image),alt:"New Proof",thumbnail:!0,style:{maxHeight:"200px"}}):e.jsx(z,{imagePath:x.proof_image,alt:"Current Proof",style:{maxHeight:"200px"},thumbnail:!0})}),e.jsx(i.Control.Feedback,{type:"invalid",children:s.proof_image})]}),e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Check,{type:"checkbox",label:"ตัวอย่างจัดส่งถึงแลป",name:"deliveredToLab",checked:t.deliveredToLab,onChange:d,onBlur:r,isInvalid:n.deliveredToLab&&!!s.deliveredToLab}),e.jsx(i.Control.Feedback,{type:"invalid",children:s.deliveredToLab})]}),e.jsxs(i.Group,{className:"mb-3",children:[e.jsx(i.Label,{children:"รับตัวอย่างเข้าระบบ"}),e.jsxs("div",{children:[e.jsx(i.Check,{type:"radio",label:"รับสินค้าเข้าระบบ",name:"receiveOption",value:"received",checked:t.receiveOption==="received",onChange:d,inline:!0}),e.jsx(i.Check,{type:"radio",label:"ไม่รับ",name:"receiveOption",value:"not_received",checked:t.receiveOption==="not_received",onChange:d,inline:!0})]})]})]}),e.jsxs(j.Footer,{children:[e.jsx(k,{variant:"success",type:"submit",disabled:p,children:"ยืนยัน"}),e.jsx(k,{variant:"secondary",onClick:()=>S(!1),disabled:p,children:"ยกเลิก"})]})]})})]})]})};export{Le as M,Ne as S,de as d,le as p};
