import{r as o,u as B,h as z,y as S,j as s,R as b,C as _,B as N,i as O,k as P}from"./index-CMKGjvil.js";import{g as G}from"./serviceRequest-CJ15hpJs.js";import{g as H}from"./customerRequest-D-QXhSQD.js";import{A as M,a as U,E as V,b as W}from"./ExpandMore-CBhrzDGN.js";import{C as f}from"./Card-ltuRbL1m.js";import{S as $}from"./Stack-_RiFjssk.js";import{F as J}from"./Form-XAT3KesX.js";import{B as q}from"./Badge-Degbu7BZ.js";import{D as K,T as v,B as Q}from"./DataGrid-BSrFaLwh.js";import"./DefaultPropsProvider-7CXMMYWk.js";import"./emotion-element-f0de968e.browser.esm-D2ySOhvj.js";import"./TextField-l4tn0KBj.js";import"./toPropertyKey-BZFHAmHd.js";import"./Transition-CvY6YelV.js";import"./setPrototypeOf-DgZC2w_0.js";import"./Divider-Rbts8ePN.js";const fe=()=>{const[X,I]=o.useState(null),[c,A]=o.useState([]),[d,x]=o.useState([]),[i,w]=o.useState(()=>localStorage.getItem("filterText")||""),[m,g]=o.useState(!1),[h,L]=o.useState(!1),E=B();o.useEffect(()=>{const t=localStorage.getItem("authToken");t&&(g(!0),z(t).then(r=>(I(r.user),F())).catch(r=>{S.error("ไม่สามารถตรวจสอบผู้ใช้ได้"),console.error(r)}).finally(()=>{g(!1),L(!0)}))},[]);const F=async()=>{try{const[t,r]=await Promise.all([H(),G()]);if(t){const a=t.map((e,n)=>({id:e.company_id,No:n+1,company_code:e.company_code,company_name:e.company_name,tax_id:e.tax_id,company_address:e.company_address}));A(a),console.log("Formatted Customers:",a)}if(r){const a=r.map((e,n)=>({id:e.request_id,No:n+1,request_date:new Date(e.request_date).toLocaleString(),request_date_raw:e.request_date,request_no:e.request_no||"-",user_id:e.user_id,user_name:e.user_name,customer_id:e.customer_id,customer_name:e.customer_name,sample_type_name:e.sample_type_name,status:e.status,notes:e.notes||"-",created_at:new Date(e.created_at).toLocaleString(),sample_submissions:e.sample_submissions,service_request_documents:e.service_request_documents}));x(a),console.log("Formatted Service Requests:",a)}else x([])}catch(t){S.error("เกิดข้อผิดพลาดในการดึงข้อมูล"),console.error(t)}},T=[{field:"No",headerName:"No.",width:90,headerAlign:"center",align:"center"},{field:"request_no",headerName:"เลขที่คำขอ",flex:.8},{field:"sample_type_name",headerName:"ประเภทคำขอ",flex:.7},{field:"request_date",headerName:"วันที่สร้าง",flex:1},{field:"notes",headerName:"เงื่อนไขพิเศษ",flex:1.2},{field:"status",headerName:"สถานะ",width:120,headerAlign:"center",align:"center",renderCell:t=>s.jsx(q,{pill:!0,bg:t.row.status==="pending"?"warning":t.row.status==="rejected"?"danger":"success",children:t.row.status==="pending"?"กำลังดำเนินการ":t.row.status==="rejected"?"ไม่อนุมัติ":"อนุมัติ"})},{field:"actions",headerName:"Action",width:200,headerAlign:"center",align:"center",renderCell:t=>s.jsx(Q,{children:s.jsx(N,{variant:"primary",size:"sm",onClick:()=>{E("/admin/request/verify",{state:{id:t.row.id}})},children:s.jsx("i",{className:"feather icon-file-text m-0"})})})}],p=o.useMemo(()=>{if(!d.length||!c.length)return[];let t={};if(!i.trim())d.forEach(a=>{const e=a.customer_id;t[e]||(t[e]={customer_id:e,customer_name:a.customer_name,serviceCount:0,filteredRows:[],earliestRequestDate:a.request_date_raw}),t[e].serviceCount+=1,t[e].filteredRows.push(a),new Date(a.request_date_raw)<new Date(t[e].earliestRequestDate)&&(t[e].earliestRequestDate=a.request_date_raw)});else{const a=i.toLowerCase();d.forEach(e=>{var u,y,j,R,C,D;if(((u=e.request_no)==null?void 0:u.toLowerCase().includes(a))||((y=e.sample_type_name)==null?void 0:y.toLowerCase().includes(a))||((j=e.request_date)==null?void 0:j.toLowerCase().includes(a))||((R=e.notes)==null?void 0:R.toLowerCase().includes(a))||((C=e.status)==null?void 0:C.toLowerCase().includes(a))||((D=e.customer_name)==null?void 0:D.toLowerCase().includes(a))){const l=e.customer_id;t[l]||(t[l]={customer_id:l,customer_name:e.customer_name,serviceCount:0,filteredRows:[],earliestRequestDate:e.request_date_raw}),t[l].serviceCount+=1,t[l].filteredRows.push(e),new Date(e.request_date_raw)<new Date(t[l].earliestRequestDate)&&(t[l].earliestRequestDate=e.request_date_raw)}})}let r=Object.values(t).map(a=>{const e=c.find(n=>n.id===a.customer_id)||{};return{...a,company_name:e.company_name||a.customer_name,tax_id:e.tax_id||"-",company_address:e.company_address||"-",isVisible:!0}});return r=r.sort((a,e)=>new Date(e.earliestRequestDate)-new Date(a.earliestRequestDate)),r=r.map(a=>{const e=a.filteredRows.map((n,u)=>({...n,No:u+1}));return{...a,filteredRows:e}}),r.filter(a=>a.isVisible)},[d,c,i]);o.useEffect(()=>{h&&(d.length>0||c.length>0)},[h,d,c]),o.useEffect(()=>{localStorage.setItem("filterText",i)},[i]);const k=()=>{w(""),localStorage.removeItem("filterText")};return console.log("Filtered Groups:",p),s.jsxs(f,{children:[s.jsx(f.Header,{children:s.jsx(b,{children:s.jsx(_,{children:s.jsx(f.Title,{as:"h5",children:"รายการคำขอรับบริการ"})})})}),s.jsxs(f.Body,{className:"pt-3 pb-3",children:[s.jsxs($,{direction:"row",spacing:1,sx:{mb:2},children:[s.jsx(J.Control,{type:"text",placeholder:"ค้นหาลูกค้า หรือ คำขอรับบริการ...",value:i,onChange:t=>w(t.target.value),disabled:m}),s.jsx(N,{variant:"primary",size:"sm",onClick:k,disabled:!i||m,children:s.jsx(O,{style:{fontSize:20}})})]}),s.jsx(s.Fragment,{children:m||!h?s.jsx("div",{children:"Loading..."}):p.length>0?p.map(t=>s.jsx(_,{md:12,className:"mb-3",style:{border:"1px solid #f8f9fa",borderRadius:10},children:s.jsxs(M,{defaultExpanded:!0,sx:{boxShadow:"none"},children:[s.jsx(U,{expandIcon:s.jsx(V,{}),sx:{backgroundColor:"#e8f5ff",borderRadius:0},children:s.jsxs(b,{className:"align-items-center w-100",children:[s.jsxs(_,{children:[s.jsxs("h6",{children:["รหัสลูกค้า : ",t.company_code,t.company_name]}),s.jsxs("p",{className:"mb-0",children:["เลขที่ผู้เสียภาษี: ",s.jsx("span",{style:{color:"#343a40"},children:t.tax_id+" "}),"ที่อยู่: ",s.jsx("span",{style:{color:"#343a40"},children:" "+t.company_address})]})]}),s.jsx(_,{xs:"auto",children:s.jsxs(q,{pill:!0,bg:"danger",style:{padding:"8px 12px"},children:[t.serviceCount," คำขอ"]})})]})}),s.jsx(W,{children:t.filteredRows.length>0?s.jsx(K,{rows:t.filteredRows,columns:T,pageSize:5,rowsPerPageOptions:[5,10,20],pagination:!0,disableSelectionOnClick:!0,hideFooterSelectedRowCount:!0,loading:m,autoHeight:!0}):s.jsx(v,{variant:"body2",align:"center",children:"ไม่พบคำขอรับบริการสำหรับลูกค้านี้"})})]})},`customer-${t.customer_id}`)):s.jsxs("div",{className:"text-center py-4",children:[s.jsx(P,{size:24}),s.jsx(v,{variant:"body2",className:"mt-2",children:"ไม่พบข้อมูลคำขอรับบริการที่ตรงกับคำค้นหา"})]})})]})]})};export{fe as default};
