import{r as l,j as e,o as ue,B as R,R as L,C as n,y as P,u as _e,h as pe,q as xe,l as je,a as fe,t as be,L as ge}from"./index-6YeC_AS5.js";import{p as ye,d as te,a as he,b as ve}from"./serviceRequest-CJ15hpJs.js";import{g as Ne}from"./packageingTypeRequest-CUTcv2jf.js";import{g as we}from"./fertilizerTypesRequest-CzftO6V-.js";import{c as Se,a as W,e as G,F as Ce}from"./formik.esm-C0GtiMNK.js";import{p as re,g as ke}from"./sampleSubmissionsRequest-bNYMIj3U.js";import{M as T}from"./Modal-D05P99kH.js";import{F as t}from"./Form-CGCyrcfL.js";import{u as qe,e as Te,T as ne}from"./TextField-DmQ6Lsg1.js";import{A as Be,a as Re,E as ze,b as De}from"./ExpandMore-BGXL0BaM.js";import{S as Fe}from"./SampleReceivingModal-B8vlIHN5.js";import{a as Ee}from"./customerRequest-D-QXhSQD.js";import{g as Ie}from"./specialConditionsRequest-B-G5iiQh.js";import{g as Le}from"./fertilizerMainRequest-kGbpd_0A.js";import{C as ie}from"./CountrySelect-DQQwKg9k.js";import{C as E}from"./Card-BhOVTKNa.js";import{B as le}from"./Badge-C_mrIdUk.js";import{D as Me,C as Ge}from"./DataGrid-DoczE-38.js";import{p as Pe}from"./emailRequest-DbDPYP9A.js";import{h as Ae}from"./uploadFileRequest-j7nqPy1R.js";import{p as $e,D as He,P as We,S as Ue,V as U,T as D,I as Oe,F as Ye}from"./react-pdf.browser-C9xYBYWs.js";import{T as Qe}from"./index-DpgziKTs.js";import{s as Je,a as Ke,g as Xe,T as Ze,C as Ve,c as es}from"./DefaultPropsProvider-2RhE6zQB.js";import{S as oe,b as ce,c as de,e as ss}from"./trackingRequest-wN0MMLEF.js";import"./CloseButton-BYF_v0Zl.js";import"./Transition-rt6HDaS9.js";import"./setPrototypeOf-DgZC2w_0.js";import"./emotion-element-f0de968e.browser.esm-C-W82wov.js";import"./toPropertyKey-CTo9CRTC.js";import"./firebaseConfig-pMHECxRz.js";import"./FirebaseImage-DiJQPKTY.js";import"./Table-WM_kTK7U.js";import"./react-select.esm-jYPj7h1v.js";import"./Divider-mvYdwXE_.js";import"./tslib.es6-RU1n5ZxP.js";function as(_={}){const{themeId:g,defaultTheme:x,defaultClassName:p="MuiBox-root",generateClassName:h}=_,d=Je("div",{shouldForwardProp:S=>S!=="theme"&&S!=="sx"&&S!=="as"})(Ke);return l.forwardRef(function(M,z){const y=qe(x),{className:a,component:i="div",...u}=Te(M);return e.jsx(d,{as:i,ref:z,className:ue(a,h?h(p):p),theme:g&&y[g]||y,...u})})}const ts=Xe("MuiBox",["root"]),rs=es(),ns=as({themeId:Ze,defaultTheme:rs,defaultClassName:ts.root,generateClassName:Ve.generate}),is=({sampleSubmissions:_,onSubmitReview:g,serviceRequestId:x})=>{const[p,h]=l.useState(!1),[d,B]=l.useState(null),S=Se({is_sample_normal:G().required("กรุณาเลือกสถานะตัวอย่าง"),is_sample_abnormal:G().required("กรุณาเลือกสถานะตัวอย่าง"),sample_abnormal_desc:W().test("abnormal-desc-required","กรุณาระบุเหตุผลที่ตัวอย่างผิดปกติ",function(a){return!this.parent.is_sample_abnormal||a!==void 0&&a.trim()!==""}),is_staff_ready:G().required("กรุณาเลือกสถานะบุคลากร"),is_staff_not_ready:G().required("กรุณาเลือกสถานะบุคลากร"),is_equipment_ready:G().required("กรุณาเลือกสถานะเครื่องมือ"),is_equipment_not_ready:G().required("กรุณาเลือกสถานะเครื่องมือ"),is_job_accepted:G().required("กรุณาเลือกสถานะสรุปความพร้อม"),is_job_rejected:G().required("กรุณาเลือกสถานะสรุปความพร้อม"),has_change_request:G(),change_agreement:W().test("change-agreement-required","กรุณาระบุข้อตกลงการเปลี่ยนแปลง",function(a){return!this.parent.has_change_request||a!==void 0&&a.trim()!==""}),reviewed_by:W().test("reviewed-by-required","กรุณาระบุผู้ทบทวน",function(a){return!this.parent.has_change_request||a!==void 0&&a.trim()!==""}),review_date:W().test("review-date-required","กรุณาระบุวันที่ทบทวน",function(a){return!this.parent.has_change_request||a!==void 0&&a.trim()!==""}),approved_by:W().test("approved-by-required","กรุณาระบุผู้อนุมัติ",function(a){return!this.parent.has_change_request||a!==void 0&&a.trim()!==""}),approved_date:W().test("approved-date-required","กรุณาระบุวันที่อนุมัติ",function(a){return!this.parent.has_change_request||a!==void 0&&a.trim()!==""})}),M={is_sample_normal:!0,is_sample_abnormal:!1,sample_abnormal_desc:"",is_staff_ready:!0,is_staff_not_ready:!1,is_equipment_ready:!0,is_equipment_not_ready:!1,is_job_accepted:!0,is_job_rejected:!1,has_change_request:!1,change_agreement:"",reviewed_by:"",review_date:"",approved_by:"",approved_date:"",verification_status:_.verification_status||"No"},z=async(a,{setSubmitting:i,setErrors:u})=>{try{await S.validate(a,{abortEarly:!1});const v={is_sample_normal:a.is_sample_normal?1:0,is_sample_abnormal:a.is_sample_abnormal?1:0,sample_abnormal_desc:a.sample_abnormal_desc||"",is_staff_ready:a.is_staff_ready?1:0,is_staff_not_ready:a.is_staff_not_ready?1:0,is_equipment_ready:a.is_equipment_ready?1:0,is_equipment_not_ready:a.is_equipment_not_ready?1:0,is_job_accepted:a.is_job_accepted?1:0,is_job_rejected:a.is_job_rejected?1:0};console.log("reviewData",v),console.log("sampleSubmissions.submission_id",_.submission_id);const m=await re(v,_.submission_id);if(m.message==="อัปเดตข้อมูลตัวอย่างสำเร็จ"){const C=await ke(x),o=C.length;C.reduce((f,N)=>f+(N.verification_status==="Yes"?1:0),0)>=o&&(await ye(x,{newStatusTracking:"request_reviewed"}),P.success("สถานะอัปเดต: การทบทวนคำขอเสร็จสิ้น",{autoClose:3e3})),a.is_job_rejected&&(await te(x,{StatusTracking:"request_reviewed"}),P.info("สถานะถูกลบ: การทบทวนคำขอถูกยกเลิก",{autoClose:3e3})),i(!1),h(!1),g(!0),P.success("อัปเดตข้อมูลตัวอย่างสำเร็จ!",{autoClose:3e3})}else P.error(m.message,{autoClose:3e3})}catch(v){if(P.error("Validation error:"+v,{autoClose:3e3}),console.error("Validation error:",v),v.name==="ValidationError"){const m={};v.inner.forEach(C=>{m[C.path]=C.message}),u(m),B("กรุณากรอกข้อมูลให้ครบถ้วน")}else B("เกิดข้อผิดพลาดในการบันทึก");i(!1)}},y=async()=>{if(window.confirm("คุณต้องการยกเลิกการทบทวนคำขอนี้หรือไม่?"))try{const i={is_sample_normal:null,is_sample_abnormal:null,sample_abnormal_desc:null,is_staff_ready:null,is_staff_not_ready:null,is_equipment_ready:null,is_equipment_not_ready:null,is_job_accepted:null,is_job_rejected:null};console.log("reviewData",i),await re(i,_.submission_id),await te(x,{StatusTracking:"request_reviewed"}),P.success("ยกเลิกการทบทวนสำเร็จ!",{autoClose:3e3}),g(!0),h(!1)}catch(i){P.error("เกิดข้อผิดพลาดในการยกเลิกการทบทวน: "+i,{autoClose:3e3})}};return e.jsxs(e.Fragment,{children:[_.verification_status==="Yes"?e.jsxs(R,{variant:"warning",onClick:()=>h(!0),children:[e.jsx("i",{className:"feather icon-edit"})," ยกเลิก/แก้ไขการทบทวน"]}):e.jsxs(R,{variant:"info",onClick:()=>h(!0),children:[e.jsx("i",{className:"feather icon-eye"})," ทบทวนคำขอ"]}),e.jsxs(T,{show:p,onHide:()=>h(!1),size:"lg",centered:!0,children:[e.jsx(T.Header,{closeButton:!0,children:e.jsx(T.Title,{children:e.jsx("h6",{children:"การทวนคำขอรับบริการ"})})}),e.jsx(Ce,{initialValues:M,validationSchema:S,onSubmit:z,children:({values:a,errors:i,touched:u,handleChange:v,handleBlur:m,handleSubmit:C,setFieldValue:o,isSubmitting:j})=>e.jsxs(t,{onSubmit:C,children:[e.jsxs(T.Body,{children:[d&&e.jsx("div",{className:"text-danger mb-3",children:d}),e.jsx("h6",{children:"สถานะการขอรับบริการ"}),e.jsxs(L,{className:"ps-4 pe-4",children:[e.jsx(n,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"สถานะตัวอย่าง"}),e.jsxs("div",{children:[e.jsx(t.Check,{id:"is_sample_normal",inline:!0,type:"radio",name:"is_sample_normal",label:"ปกติ",checked:a.is_sample_normal,onChange:()=>{o("is_sample_normal",!0),o("is_sample_abnormal",!1),o("sample_abnormal_desc","")},isInvalid:u.is_sample_normal&&!!i.is_sample_normal}),e.jsx(t.Check,{id:"is_sample_abnormal",inline:!0,type:"radio",name:"is_sample_abnormal",label:"ผิดปกติ",checked:a.is_sample_abnormal,onChange:()=>{o("is_sample_normal",!1),o("is_sample_abnormal",!0)},isInvalid:u.is_sample_abnormal&&!!i.is_sample_abnormal}),a.is_sample_abnormal&&e.jsx(t.Control,{className:"mt-2",as:"textarea",name:"sample_abnormal_desc",placeholder:"ระบุเหตุผลที่ผิดปกติ",value:a.sample_abnormal_desc,onChange:v,onBlur:m,isInvalid:u.sample_abnormal_desc&&!!i.sample_abnormal_desc})]}),e.jsx(t.Control.Feedback,{type:"invalid",children:i.sample_abnormal_desc||i.is_sample_normal})]})}),e.jsx(n,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"สถานะบุคลากร"}),e.jsxs("div",{children:[e.jsx(t.Check,{id:"is_staff_ready",inline:!0,type:"radio",name:"is_staff_ready",label:"พร้อมปฏิบัติงาน",checked:a.is_staff_ready,onChange:()=>{o("is_staff_ready",!0),o("is_staff_not_ready",!1)},isInvalid:u.is_staff_ready&&!!i.is_staff_ready}),e.jsx(t.Check,{id:"is_staff_not_ready",inline:!0,type:"radio",name:"is_staff_not_ready",label:"ไม่พร้อมปฏิบัติงาน",checked:a.is_staff_not_ready,onChange:()=>{o("is_staff_ready",!1),o("is_staff_not_ready",!0)},isInvalid:u.is_staff_not_ready&&!!i.is_staff_not_ready})]}),e.jsx(t.Control.Feedback,{type:"invalid",children:i.is_staff_ready})]})}),e.jsx(n,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"สถานะเครื่องมือ"}),e.jsxs("div",{children:[e.jsx(t.Check,{id:"is_equipment_ready",inline:!0,type:"radio",name:"is_equipment_ready",label:"พร้อมใช้งาน",checked:a.is_equipment_ready,onChange:()=>{o("is_equipment_ready",!0),o("is_equipment_not_ready",!1)},isInvalid:u.is_equipment_ready&&!!i.is_equipment_ready}),e.jsx(t.Check,{id:"is_equipment_not_ready",inline:!0,type:"radio",name:"is_equipment_not_ready",label:"ไม่พร้อมใช้งาน",checked:a.is_equipment_not_ready,onChange:()=>{o("is_equipment_ready",!1),o("is_equipment_not_ready",!0)},isInvalid:u.is_equipment_not_ready&&!!i.is_equipment_not_ready})]}),e.jsx(t.Control.Feedback,{type:"invalid",children:i.is_equipment_ready})]})}),e.jsx(n,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"สรุปความพร้อม"}),e.jsxs("div",{children:[e.jsx(t.Check,{id:"is_job_accepted",inline:!0,type:"radio",name:"is_job_accepted",label:"รับงาน",checked:a.is_job_accepted,onChange:()=>{o("is_job_accepted",!0),o("is_job_rejected",!1)},isInvalid:u.is_job_accepted&&!!i.is_job_accepted}),e.jsx(t.Check,{id:"is_job_rejected",inline:!0,type:"radio",name:"is_job_rejected",label:"ไม่รับงาน",checked:a.is_job_rejected,onChange:()=>{o("is_job_accepted",!1),o("is_job_rejected",!0)},isInvalid:u.is_job_rejected&&!!i.is_job_rejected})]}),e.jsx(t.Control.Feedback,{type:"invalid",children:i.is_job_accepted})]})})]}),e.jsx("h6",{children:"เปลี่ยนแปลงคำขอ"}),e.jsxs(L,{className:"ps-4 pe-4",children:[e.jsx(n,{md:12,children:e.jsx(t.Group,{children:e.jsx(t.Check,{id:"has_change_request",type:"checkbox",name:"has_change_request",label:"กรณีเปลี่ยนแปลงคำขอ?",checked:a.has_change_request,onChange:f=>o("has_change_request",f.target.checked)})})}),a.has_change_request&&e.jsx(n,{md:12,children:e.jsxs(L,{children:[e.jsxs(n,{md:12,className:"mb-3",children:[e.jsx(t.Control,{className:"mt-2",as:"textarea",name:"change_agreement",placeholder:"ระบุข้อตกลงการเปลี่ยนแปลง",value:a.change_agreement,onChange:v,onBlur:m,isInvalid:u.change_agreement&&!!i.change_agreement}),e.jsx(t.Control.Feedback,{type:"invalid",children:i.change_agreement})]}),e.jsx(n,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"ผู้ทบทวน"}),e.jsx(t.Control,{type:"text",name:"reviewed_by",placeholder:"ระบุผู้ทบทวน",value:a.reviewed_by,onChange:v,onBlur:m,isInvalid:u.reviewed_by&&!!i.reviewed_by}),e.jsx(t.Control.Feedback,{type:"invalid",children:i.reviewed_by})]})}),e.jsx(n,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"วันที่ทบทวน"}),e.jsx(ne,{fullWidth:!0,type:"date",name:"review_date",value:a.review_date,onChange:v,onBlur:m,error:u.review_date&&!!i.review_date,helperText:u.review_date&&i.review_date})]})}),e.jsx(n,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"ผู้อนุมัติ"}),e.jsx(t.Control,{type:"text",name:"approved_by",placeholder:"ระบุผู้อนุมัติ",value:a.approved_by,onChange:v,onBlur:m,isInvalid:u.approved_by&&!!i.approved_by}),e.jsx(t.Control.Feedback,{type:"invalid",children:i.approved_by})]})}),e.jsx(n,{md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"วันที่อนุมัติ"}),e.jsx(ne,{fullWidth:!0,type:"date",name:"approved_date",value:a.approved_date,onChange:v,onBlur:m,error:u.approved_date&&!!i.approved_date,helperText:u.approved_date&&i.approved_date})]})})]})})]})]}),e.jsxs(T.Footer,{className:"justify-content-center",children:[_.verification_status==="Yes"&&e.jsx(R,{variant:"danger",onClick:y,disabled:j,children:"ยกเลิกการทบทวน"}),e.jsx(R,{variant:"secondary",onClick:()=>h(!1),disabled:j,children:"ปิด"}),e.jsx(R,{variant:"primary",type:"submit",disabled:j,children:"บันทึกการทบทวน"})]})]})})]})]})},me=({serviceId:_,handleReload:g,handleSetCustomer:x})=>{_e();const[p,h]=l.useState([]),[d,B]=l.useState(!1),[S,M]=l.useState([]),[z,y]=l.useState({}),[a,i]=l.useState({}),[u,v]=l.useState([]),[m,C]=l.useState({}),[o,j]=l.useState([]),[f,N]=l.useState([]);l.useEffect(()=>{const s=localStorage.getItem("authToken");s&&pe(s).then(r=>{h(r.user)}),_&&O(_),F()},[_,d]);const O=async s=>{const r=await he(s),w=await ve(s);r&&(await $(r.customer_id),await A(r.customer_id),r.sample_submissions=r.sample_submissions.map(c=>({...c,reportMethod:[c.is_self_pickup?"is_self_pickup":null,c.pdf_email?"pdf_email":null,c.is_mail_delivery?"is_mail_delivery":null].filter(Boolean)})),C(r),j(r.sample_submissions),M(w))},$=async s=>{try{const r=await Ie(s);y(Array.isArray(r)?r:[])}catch(r){console.error(r),y([])}},F=async()=>{try{const r=(await Le()).map(w=>({value:w.fertilizer_main_id,label:w.fertilizer_main_name_th}));console.log("formattedOptions",r),N(r)}catch(s){console.error("Error fetching fertilizer formulas:",s),N([])}},A=async s=>{try{const r=await Ee(s);i(r),x(r)}catch(r){console.error(r)}};l.useEffect(()=>{H(),ee()},[]);const H=async()=>{const s=await Ne();v(s)},[V,Q]=l.useState([]),ee=async()=>{try{const s=await we();Q(s)}catch(s){console.log(s)}},J=[{field:"no",headerName:"#",width:90,headerAlign:"center",align:"center"},{field:"test_code",headerName:"ทดสอบ",flex:1,renderCell:s=>{if(!s||!s.row)return"-";const{test_code:r,test_percentage:w}=s.row;return`${r||""}${w?` (${w})`:""}`.trim()}},{field:"status",headerName:"สถานะ",headerAlign:"center",align:"center",flex:1,renderCell:s=>e.jsx(le,{pill:!0,bg:s.row.status==="pending"?"warning":s.row.status==="rejected"?"danger":"success",children:s.row.status==="pending"?"รออนุมัติ":s.row.status==="rejected"?"ไม่อนุมัติ":"อนุมัติ"})},{field:"test_value",headerName:"ผลที่ได้",flex:1,renderCell:s=>{var r;return((r=s==null?void 0:s.row)==null?void 0:r.test_value)||"-"}},{field:"test_date",headerName:"วันที่ทดสอบ",flex:1,valueGetter:s=>{var r;return((r=s==null?void 0:s.row)==null?void 0:r.created_at)||"-"}}],K=s=>s.map((w,c)=>({id:w.detail_id,no:c+1,...w})),Y=[{value:"g",label:"กรัม"},{value:"kg",label:"กิโลกรัม"},{value:"oz",label:"ออนซ์"},{value:"ml",label:"มิลลิลิตร"},{value:"L",label:"ลิตร"}],X=[{value:"is_self_pickup",label:"รับด้วยตนเอง"},{value:"pdf_email",label:"ต้องการไฟล์ pdf เพิ่มเติมทาง E-mail"},{value:"is_mail_delivery",label:"ส่งทางไปรษณีย์"}],se=s=>s.map(r=>{var w;return((w=X.find(c=>c.value===r))==null?void 0:w.label)||r}).join(", ");return e.jsx("div",{children:e.jsx(E,{style:{borderRadius:10,marginBottom:0},children:e.jsxs(E.Body,{style:{paddingBottom:20,paddingTop:20},children:[e.jsxs(L,{children:[e.jsx(n,{md:12,children:e.jsxs("h5",{className:"mb-4",children:["เลขที่คำขอรับบริการ : ",e.jsx("span",{style:{fontSize:18},children:m.request_no||"-"})]})}),e.jsx(n,{md:12,children:e.jsx("h6",{className:"mb-3",children:"ข้อมูลผู้ขอขึ้นทะเบียน"})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["รหัสลูกค้า : ",e.jsx("strong",{className:"text-dark",children:a.company_code})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ชื่อบริษัท : ",e.jsx("strong",{className:"text-dark",children:a.company_name})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["เลขที่ผู้เสียภาษี : ",e.jsx("strong",{className:"text-dark",children:a.tax_id})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ที่อยู่ : ",e.jsx("strong",{className:"text-dark",children:a.company_address})]})}),e.jsx(n,{md:6,children:e.jsxs("p",{className:"mb-0",children:["เงื่อนไขพิเศษ :"," ",e.jsx("strong",{className:"text-dark",children:z.length>0?z.map((s,r)=>`${s.description}${r<z.length-1?", ":""}`):"-"})]})}),m.sample_type_id===1&&e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["วัตถุประสงค์การขอรับบริการ :"," ",e.jsx("strong",{className:"text-dark",children:m.is_quality_check_analysis===1?"วิเคราะห์เพื่อตรวจสอบคุณภาพ":"วิเคราะห์ขึ้นทะเบียน"})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ประเภทคำขอ : ",e.jsx("strong",{className:"text-dark",children:m.sample_type_name})]})})]}),e.jsx("h6",{className:"mt-3 mb-2",children:"ข้อมูลตัวอย่างปุ๋ย"}),o.map((s,r)=>{var w,c,b,k,Z;return e.jsx(e.Fragment,{children:e.jsxs(e.Fragment,{children:[e.jsx(L,{children:e.jsxs(n,{md:12,className:"ms-2 ps-0 pe-0",style:{border:"1px solid #f8f9fa"},children:[e.jsxs(Be,{className:"mb-0",sx:{boxShadow:"none"},children:[e.jsx(Re,{expandIcon:e.jsx(ze,{}),"aria-controls":`panel${r}-content`,id:`panel${r}-header`,sx:{backgroundColor:"#f8f9fa",borderRadius:0},children:e.jsxs("p",{className:"mb-0",children:["ตัวอย่างที่ ",r+1," ",e.jsxs(e.Fragment,{children:["เลขที่ :"," ",e.jsx("strong",{className:"text-dark",style:{fontWeight:"bold"},children:s.submission_no||"-"})," "]}),s.sample_type_id===2&&e.jsxs(e.Fragment,{children:["สูตรปุ๋ย : ",e.jsx("strong",{className:"text-dark",children:s.fertilizer_formula||"-"})," ( ชื่อสามัญ :"," ",e.jsx("strong",{className:"text-dark",style:{fontWeight:"bold"},children:s.common_name||"-"}),")"]})," ","สถานะ :",e.jsx(le,{pill:!0,bg:s.verification_status==="No"&&s.is_job_accepted||s.verification_status==="No"&&!s.is_job_accepted||s.verification_status==="Yes"&&!s.is_job_accepted?"warning":s.verification_status==="Yes"&&s.is_job_accepted?"success":"danger",style:{marginLeft:12},children:s.verification_status==="No"&&s.is_job_accepted||s.verification_status==="No"&&!s.is_job_accepted||s.verification_status==="Yes"&&!s.is_job_accepted?"รอการตรวจสอบ":s.verification_status==="Yes"&&s.is_job_accepted?"รับงาน":" ไม่อนุมัติ"})]})}),e.jsx(De,{className:"pb-0",children:e.jsxs(L,{children:[s.fertilizer_main_id&&e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ประเภทของปุ๋ย :"," ",e.jsx("strong",{className:"text-dark",children:(w=f.find(q=>q.value===s.fertilizer_main_id))==null?void 0:w.label})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ลักษณะปุ๋ย :"," ",e.jsx("strong",{className:"text-dark",children:((c=V.find(q=>q.fertilizer_type_id===s.fertilizer_type_id))==null?void 0:c.fertilizer_type_name)||"-"})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["สี : ",e.jsx("strong",{className:"text-dark",children:s.color||"-"})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ภาชนะบรรจุ :"," ",e.jsx("strong",{className:"text-dark",children:((b=u.find(q=>q.packaging_type_id===s.packaging_id))==null?void 0:b.packaging_type_name)||"-"})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ชื่อการค้า : ",e.jsx("strong",{className:"text-dark",children:s.trade_name||"-"})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ผู้ผลิต (บริษัท/ห้าง/ร้าน) : ",e.jsx("strong",{className:"text-dark",children:s.manufacturer||"-"}),"ประเทศ :"," ",e.jsx(ie,{name:"country",label:"ประเทศ",value:s.manufacturer_country||"-",onChange:(q,ae)=>console.log(q,ae),showText:!0})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["สั่งจาก (บริษัท/ห้าง/ร้าน) : ",e.jsx("strong",{className:"text-dark",children:s.supplier||"-"}),"ประเทศ :"," ",e.jsx(ie,{name:"country",label:"ประเทศ",value:s.supplier_country||"-",onChange:(q,ae)=>console.log(q,ae),showText:!0})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ปริมาณ : ",e.jsx("strong",{className:"text-dark",children:s.sample_weight||"-"})," ",e.jsx("strong",{className:"text-dark",children:((k=Y.find(q=>q.value===s.sample_weight_unit))==null?void 0:k.label)||"-"})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["วัตถุส่วนประกอบของปุ๋ย : ",e.jsx("strong",{className:"text-dark",children:s.composition||"-"})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ผู้ส่งตัวอย่าง : ",e.jsx("strong",{className:"text-dark",children:s.submitted_by||"-"})]})}),e.jsx(n,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["เบอร์โทรศัพท์ผู้ส่ง : ",e.jsx("strong",{className:"text-dark",children:s.phone||"-"})]})}),e.jsx(n,{md:6,className:"mb-3",children:e.jsxs("p",{className:"mb-0",children:["วันที่ส่ง :"," ",e.jsx("strong",{className:"text-dark",children:new Date(s.submission_date).toLocaleDateString("th-TH")||"-"})]})}),e.jsxs(n,{md:12,className:"mb-3",children:[e.jsx("h6",{className:"mb-3",children:"ข้อมูลการขอรับผลการตรวจ"}),e.jsxs("p",{className:"mb-1",children:["วิธีการรับรายงาน : ",e.jsx("strong",{className:"text-dark",children:se(s.reportMethod)})]}),s.reportMethod.includes("pdf_email")&&e.jsxs("p",{className:"mb-1",children:["E-mail สำหรับรับผลตรวจ : ",e.jsx("strong",{className:"text-dark",children:s.pdf_email||"-"})]}),s.reportMethod.includes("is_mail_delivery")&&e.jsxs("p",{className:"mb-1",children:["ที่อยู่จัดส่ง : ",e.jsx("strong",{className:"text-dark",children:s.mail_delivery_location||"-"})]})]}),e.jsxs(n,{md:12,className:"mb-2",children:[e.jsx("h6",{className:"mb-3",children:"รายการทดสอบ"}),e.jsx("div",{style:{width:"100%"},children:e.jsx(Me,{rows:K(s.sample_submission_details),columns:J,pageSize:5,rowsPerPageOptions:[5,10,20],pagination:!0,disableSelectionOnClick:!0,hideFooterSelectedRowCount:!0})})]})]})})]}),e.jsx(n,{style:{padding:"0px 16px "},children:e.jsx(Fe,{serviceData:m,submissionId:s.submission_id,handleTracking:g,trackingData:s.sample_tracking,reviewBy:p.user_id,sampleNo:s.submission_no,reloadData:d,sampleStatus:S.sample_submissions.find(q=>q.submission_id===s.submission_id),serviceRequestId:m.request_id})}),((Z=m.service_status_logs)==null?void 0:Z.sample_arrived_lab)&&e.jsx(n,{style:{padding:"0px 16px 16px"},children:e.jsx(is,{sampleSubmissions:s,onSubmitReview:g,serviceRequestId:m.request_id})})]})},`Accordion-${r}`),r<o.length-1&&e.jsx("hr",{className:"mt-4 mb-2"})]})})})]})})})},ls=({buttonTitle:_="ส่งอีเมล",icon:g,serviceData:x})=>{const[p,h]=l.useState(!1);console.log("serviceData:",x);const[d,B]=l.useState({toEmail:x.sr_pdf_email,subject:"",message:"",username:x.customer_name,files:null}),[S,M]=l.useState(!1),[z,y]=l.useState(null),[a,i]=l.useState(!1);l.useEffect(()=>{(async()=>{try{const j=localStorage.getItem("authToken");if(console.log("token:",j),j){const f=await xe(x.user_id);console.log("response:",f),f&&f.user_id?B(N=>({...N,username:f.first_name+" "+f.last_name})):y("ไม่สามารถดึงข้อมูลผู้ใช้ได้")}else y("กรุณาเข้าสู่ระบบก่อนส่งอีเมล")}catch(j){y("เกิดข้อผิดพลาดในการตรวจสอบผู้ใช้: "+j.message)}})()},[]);const u=o=>{const{name:j,value:f}=o.target;B(N=>({...N,[j]:f}))},v=o=>{const j=o.target.files;if(j&&j.length>0){for(let N=0;N<j.length;N++)if(j[N].size>10485760){y("ไฟล์ขนาดเกิน 10MB ไม่สามารถอัปโหลดได้");return}}B(f=>({...f,files:j}))},m=()=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d.toEmail)?d.subject.trim()?d.message.trim()?d.username?!0:(y("ไม่พบข้อมูลผู้ใช้ กรุณาเข้าสู่ระบบ"),!1):(y("กรุณากรอกรายละเอียด"),!1):(y("กรุณากรอกหัวข้อ"),!1):(y("กรุณากรอกอีเมลให้ถูกต้อง"),!1),C=async o=>{if(o.preventDefault(),i(!0),y(null),!!m()){M(!0);try{let j=[];if(d.files&&d.files.length>0){const $=Array.from(d.files),F=await Ae($,"email-attachments",`${d.username}-${Date.now()}`);if(!F||F.length===0)throw new Error("การอัปโหลดไฟล์ล้มเหลว");console.log("uploadResults:",F),j=F.map(A=>A.fileName)}const f={toEmail:d.toEmail,subject:d.subject,message:d.message,username:d.username,filePath:j.length>0?j[0]:null};console.log("Email Data to Send:",f);const N=localStorage.getItem("authToken");if(!N)throw new Error("ไม่พบ token กรุณาเข้าสู่ระบบ");const O=await Pe(f,N);P.success(O.message),console.log("postSendEmail:",O),B({toEmail:"",subject:"",message:"",username:d.username,files:null}),h(!1),i(!1)}catch{P.error(response.message||"เกิดข้อผิดพลาดในการส่งอีเมล")}finally{M(!1)}}};return e.jsxs(e.Fragment,{children:[e.jsxs(R,{variant:"primary",onClick:()=>h(!0),disabled:!d.username||S,children:[g&&g,_]}),e.jsxs(T,{show:p,onHide:()=>h(!1),size:"lg",centered:!0,children:[e.jsx(T.Header,{closeButton:!0,children:e.jsx("h5",{className:"mb-0",children:_})}),e.jsx(T.Body,{children:e.jsx(E,{children:e.jsx(E.Body,{children:e.jsxs(t,{noValidate:!0,validated:a,onSubmit:C,children:[e.jsx(L,{children:e.jsx(n,{md:12,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"อีเมลผู้รับ"}),e.jsx(t.Control,{type:"email",name:"toEmail",value:d.toEmail,onChange:u,placeholder:"เช่น email@gmail.com",required:!0,isInvalid:a&&!d.toEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)}),e.jsx(t.Control.Feedback,{type:"invalid",children:"กรุณากรอกอีเมลให้ถูกต้อง"})]})})}),e.jsx(L,{children:e.jsx(n,{md:12,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"หัวข้อ"}),e.jsx(t.Control,{type:"text",name:"subject",value:d.subject,onChange:u,placeholder:"หัวข้ออีเมล",required:!0,isInvalid:a&&!d.subject.trim()}),e.jsx(t.Control.Feedback,{type:"invalid",children:"กรุณากรอกหัวข้อ"})]})})}),e.jsx(L,{children:e.jsx(n,{md:12,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"รายละเอียด"}),e.jsx(t.Control,{as:"textarea",rows:4,name:"message",value:d.message,onChange:u,placeholder:"พิมพ์ข้อความของคุณที่นี่",required:!0,isInvalid:a&&!d.message.trim()}),e.jsx(t.Control.Feedback,{type:"invalid",children:"กรุณากรอกรายละเอียด"})]})})}),e.jsx(L,{children:e.jsx(n,{md:12,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"แนบไฟล์หรือรูปภาพ"}),e.jsx(t.Control,{type:"file",multiple:!0,onChange:v,accept:".pdf,.jpg,.jpeg,.png"}),e.jsx(t.Text,{className:"text-muted",children:"รองรับไฟล์ PDF และรูปภาพ (JPG, PNG) ขนาดไม่เกิน 10MB"})]})})}),z&&e.jsx("div",{className:"alert alert-danger",role:"alert",children:z})]})})})}),e.jsxs(T.Footer,{children:[e.jsx(R,{variant:"secondary",onClick:()=>h(!1),disabled:S,children:"ปิด"}),e.jsx(R,{variant:"primary",onClick:C,disabled:S,children:S?"กำลังส่ง...":"ส่งอีเมล"})]})]})]})};Ye.register({family:"THSarabunNew",fonts:[{src:"/assets/fonts/THSarabunNew.ttf"},{src:"/assets/fonts/THSarabunNew-Bold.ttf",fontWeight:"bold"}]});const I=Ue.create({page:{padding:"10px 30px",fontFamily:"THSarabunNew",fontSize:14},headerContainer:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",marginBottom:10},logo:{width:60,height:60},title:{fontSize:20,fontWeight:"bold"},formCode:{fontSize:12},section:{marginBottom:10},sectionTitle:{fontSize:14,fontWeight:"bold",marginBottom:5},textRow:{flexDirection:"row",marginBottom:5},value:{flex:1},checkboxRow:{flexDirection:"row",flexWrap:"wrap"},checkboxItem:{width:"50%",marginBottom:5}}),os=({serviceData:_,submissionIndex:g,totalSubmissions:x})=>e.jsxs(U,{style:I.headerContainer,children:[e.jsx(U,{style:{width:"10%"},children:e.jsx(Oe,{src:je,style:I.logo})}),e.jsx(D,{style:I.title,children:_.sample_type_id?"แบบฟอร์มนำส่งตัวอย่างปุ๋ยอินทรีย์":"แบบฟอร์มนำส่งตัวอย่างปุ๋ยเคมี เพื่อขึ้นทะเบียนปุ๋ย"}),e.jsxs(D,{style:[I.formCode,{width:"10%"}],children:["FM-LB-46 Rev.07 (01/12/23) P ",g+1,"/",x]})]}),cs=({serviceData:_,submission:g,customerData:x,submissionIndex:p,totalSubmissions:h})=>e.jsxs(We,{size:"A4",style:I.page,children:[e.jsx(os,{serviceData:_,submissionIndex:p,totalSubmissions:h}),e.jsxs(U,{style:I.section,children:[e.jsx(D,{style:I.sectionTitle,children:"ข้อมูลผู้ขอขึ้นทะเบียน"}),e.jsxs(U,{style:I.textRow,children:[e.jsx(D,{style:{width:100},children:"รหัสลูกค้า : "}),e.jsx(D,{children:x.company_code||"000"}),e.jsxs(D,{style:{marginLeft:10},children:["ชื่อลูกค้า : ",x.company_name]})]}),_.sample_type_id===1&&e.jsxs(U,{style:{},children:[e.jsx(D,{style:{width:100,fontWeight:"bold"},children:"วัตถุประสงค์การขอรับบริการ : "}),e.jsx(D,{children:_.is_quality_check_analysis===1?"วิเคราะห์เพื่อตรวจสอบคุณภาพ":"วิเคราะห์ขึ้นทะเบียน"})]}),e.jsx(D,{style:I.sectionTitle,children:"ข้อมูลตัวอย่าง"}),e.jsx(U,{style:I.textRow,children:e.jsx(D,{style:{width:100,fontWeight:"bold"},children:"ประเภทของปุ๋ย : "})}),e.jsx(D,{children:"วัตถุประสงค์การขอรับบริการ:"})]})]}),ds=({serviceData:_,customerData:g})=>{const x=_.sample_submissions||[];return e.jsx(He,{children:x.map((p,h)=>e.jsx(cs,{serviceData:_,submission:p,customerData:g,submissionIndex:h,totalSubmissions:x.length},p.submission_id||h))})},ms=({serviceData:_,customerData:g})=>{const[x,p]=l.useState(!1),h=async()=>{const d=await $e(e.jsx(ds,{serviceData:_,customerData:g})).toBlob(),B=URL.createObjectURL(d);window.open(B),p(!1)};return e.jsxs(e.Fragment,{children:[e.jsxs(R,{variant:"primary",onClick:()=>p(!0),disabled:!_,children:[e.jsx(Qe,{className:"me-2"})," สร้างฟอร์มนำส่ง"]}),e.jsxs(T,{show:x,onHide:()=>p(!1),size:"lg",centered:!0,children:[e.jsx(T.Header,{closeButton:!0,children:e.jsx("h6",{children:"ตัวอย่างฟอร์มนำส่งตัวอย่างปุ๋ยอินทรีย์"})}),e.jsx(T.Body,{children:e.jsx("p",{children:'คลิก "สร้าง PDF" เพื่อดูตัวอย่างฟอร์มที่สร้างจากข้อมูลปัจจุบัน'})}),e.jsxs(T.Footer,{children:[e.jsx(R,{variant:"primary",onClick:h,children:"สร้าง PDF"}),e.jsx(R,{variant:"secondary",onClick:()=>p(!1),children:"ปิด"})]})]})]})},_s=({title:_})=>{var w;const g=fe(),{id:x}=be(),p=x||((w=g.state)==null?void 0:w.id)||null,h=_e(),[d,B]=l.useState(1),[S,M]=l.useState(!1),[z,y]=l.useState(!1),[a,i]=l.useState(!1),[u,v]=l.useState(!1),[m,C]=l.useState("horizontal"),[o,j]=l.useState(0),[f,N]=l.useState(!0),[O,$]=l.useState(0);l.useEffect(()=>{console.log("request id :",p),p?J(p):(h("/admin/request"),N(!1))},[p,h]);const F=()=>{$(c=>{const b=c+1;return N(b>0),b})},A=()=>{$(c=>{const b=Math.max(c-1,0);return N(b>0),b})};l.useEffect(()=>{const c=()=>{window.innerWidth<=768?C("vertical"):C("horizontal")};return c(),window.addEventListener("resize",c),()=>window.removeEventListener("resize",c)},[]);const[H,V]=l.useState({}),[Q,ee]=l.useState([]),J=async c=>{try{F();const b=await he(c);console.log("response",b),ee(b.sample_submissions||[]),V(b)}catch(b){console.error("Error fetching service request:",b),h("/admin/request")}finally{A()}},K=c=>{c&&J(p)},Y=[{label:"คำขอรับบริการ",status:"requested"},{label:"ลูกค้าส่งตัวอย่าง",status:"sample_sent"},{label:"ทบทวนคำขอ",status:"request_reviewed"},{label:"ตัวอย่างจัดส่งถึงแล็บ",status:"sample_arrived_lab"},{label:"รับตัวอย่างเข้าระบบ",status:"sample_received"},{label:"รอทดสอบบางรายการ",status:"partial_testing"},{label:"ออกใบเสนอราคา",status:"quotation_issued"},{label:"ขอใบแจ้งหนี้",status:"invoice_requested"},{label:"รับชำระเงิน",status:"payment_received"},{label:"หัก ณ ที่จ่าย",status:"tax_withheld"},{label:"ออกใบเสร็จรับเงิน/ใบกำกับภาษี",status:"receipt_issued"}],X=(c,b,k)=>{const Z=b.length;switch(Y[c].status,c){case 0:return k.requested!==null;case 1:return Z===0?!1:k.sample_sent!==null;case 2:return k.request_reviewed!==null;case 3:return k.sample_arrived_lab!==null;case 4:return k.sample_received!==null;case 5:return k.partial_testing!==null;case 6:return k.quotation_issued!==null;case 7:return k.invoice_requested!==null;case 8:return k.payment_received!==null;case 9:return k.tax_withheld!==null;case 10:return k.receipt_issued!==null;default:return!1}},[se,s]=l.useState({}),r=async c=>{console.log("handleSetCustomer data",c),s(c)};return e.jsx("div",{children:f?e.jsx(ns,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh"},children:e.jsx(Ge,{size:60})}):e.jsxs(E,{children:[e.jsx(E.Header,{children:e.jsx("h5",{children:_})}),e.jsx(E.Body,{children:e.jsx("div",{children:m==="vertical"?e.jsx(oe,{activeStep:o,orientation:m,alternativeLabel:m==="horizontal",sx:{width:"100%",margin:"0 auto",padding:"20px 0"},children:Y.map((c,b)=>e.jsxs(ce,{completed:X(b,Q,H.service_status_logs||{}),children:[e.jsx(de,{children:c.label}),m==="vertical"&&e.jsx(ss,{children:e.jsx(me,{serviceId:p,handleReload:K,startLoading:F,stopLoading:A,handleSetCustomer:r})})]},b))}):e.jsxs(e.Fragment,{children:[e.jsx(E,{style:{borderRadius:10,marginBottom:10},children:e.jsx(E.Body,{style:{padding:"8px 20px 3px"},children:e.jsx(oe,{activeStep:o,orientation:m,alternativeLabel:m==="horizontal",sx:{width:"100%",margin:"0 auto",padding:"20px 0"},children:Y.map((c,b)=>e.jsx(ce,{completed:X(b,Q,H.service_status_logs||{}),children:e.jsx(de,{children:c.label})},b))})})}),e.jsx(me,{serviceId:p,handleReload:K,startLoading:F,stopLoading:A,handleSetCustomer:r})]})})}),e.jsxs(E.Footer,{className:"text-start",children:[e.jsx(ls,{buttonTitle:"แจ้งแก้ไขข้อมูล",icon:e.jsx(ge,{style:{marginRight:8}}),serviceData:H}),e.jsx(ms,{serviceData:H,customerData:se}),e.jsxs(R,{variant:"danger",onClick:()=>h("/admin/request/"),children:[e.jsx("i",{className:"feather icon-corner-up-left"}),"กลับหน้าหลัก"]})]})]})})},Qs=()=>e.jsx(_s,{title:"รายละเอียดคำขอรับบริการ"});export{Qs as default};
