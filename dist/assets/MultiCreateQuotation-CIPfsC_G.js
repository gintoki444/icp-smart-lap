import{u as at,a as st,r as i,j as t,R as d,C as c,B as T,y as k}from"./index-6YeC_AS5.js";import{Q as nt}from"./QuotationTypeSelect-D_xhK8U0.js";import{d as rt}from"./index-DpgziKTs.js";import{a as ot}from"./customerRequest-D-QXhSQD.js";import{e as ct,f as lt,g as it}from"./quotationRequest-BTgCnPa-.js";import{C as p}from"./Card-BhOVTKNa.js";import{F as s}from"./Form-CGCyrcfL.js";import{T as dt}from"./Table-WM_kTK7U.js";const bt=()=>{const F=at(),w=st(),[x,_]=i.useState([]),[j,b]=i.useState(0),[N,D]=i.useState("percentage"),[ut,A]=i.useState([]),[C,q]=i.useState([]),[y,M]=i.useState({}),[f,L]=i.useState(""),[S,R]=i.useState(null),[E,mt]=i.useState(new Date().toISOString().split("T")[0]),[I,G]=i.useState("30 วัน"),[Q,P]=i.useState("2025-12-31");i.useEffect(()=>{var o;const e=new URLSearchParams(w.search),r=((o=e.get("request_ids"))==null?void 0:o.split(","))||[],a=parseInt(e.get("customer_id"))||null,l=parseFloat(e.get("discount_percentage"))||0,h=parseInt(e.get("created_by"))||null;b(l),(async()=>{try{const u=await ct(r.join(","),a,l,h),tt=await ot(u.customer_id);R(u);const v=u["test-items-for-quotation"].map(m=>({id:m.test_item_id,name:m.name_for_quotation,price:parseFloat(m.unit_price),quantity:m.quantity,maxQuantity:m.quantity,summary:parseFloat(m.unit_price)*m.quantity,testCode:m.test_code,quotation_type_id:u.quotation_type_id}));v.push({id:49,name:"ค่าตรวจสอบด่วนพิเศษ",price:2e3,quantity:1,maxQuantity:1,summary:2e3,testCode:"EXP006",quotation_type_id:u.quotation_type_id},{id:50,name:"ค่าบริการอื่นๆ",price:1e3,quantity:1,maxQuantity:1,summary:1e3,testCode:"EXP007",quotation_type_id:u.quotation_type_id}),q(v);const et=v.filter(m=>m.id!==49&&m.id!==50);_(et),M(tt),B(r)}catch(u){console.error("Error fetching quotation data:",u)}})()},[w.search]);const B=async e=>{try{const r=await it(e.join(","));A(r||[])}catch(r){console.error("Error fetching sample remain:",r)}},U=()=>{const e=x.reduce((n,o)=>n+o.price*o.quantity,0);let r;N==="percentage"?r=e*(j/100):r=parseFloat(j)||0;const a=e-r,l=a*.07,h=a+l;return{totalAmount:e,discountAmount:r,netTotal:a,vatAmount:l,grandTotal:h}},{totalAmount:V,discountAmount:H,netTotal:W,vatAmount:X,grandTotal:Y}=U(),g=e=>e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),$=e=>{const r=x.find(l=>l.id===e.id);let a;r?a=x.filter(l=>l.id!==e.id):a=[...x,{...e}],_(a)},z=(e,r)=>{const a=parseInt(r)||0,l=C.map(n=>n.id===e?{...n,quantity:Math.max(1,Math.min(n.maxQuantity,a)),summary:n.price*Math.max(1,Math.min(n.maxQuantity,a))}:n);q(l);const h=x.map(n=>n.id===e?{...n,quantity:Math.max(1,Math.min(n.maxQuantity,a)),summary:n.price*Math.max(1,Math.min(n.maxQuantity,a))}:n);_(h)},O=(e,r)=>{const a=parseFloat(r)||0,l=C.map(n=>n.id===e?{...n,price:a,summary:a*n.quantity}:n);q(l);const h=x.map(n=>n.id===e?{...n,price:a,summary:a*n.quantity}:n);_(h)},J=e=>{const r=parseFloat(e)||0;b(N==="percentage"?Math.max(0,Math.min(100,r)):Math.max(0,r))},K=e=>{D(e),b(0)},Z=async()=>{if(x.length===0){alert("กรุณาเลือกอย่างน้อย 1 รายการเพื่อสร้างใบเสนอราคา");return}if(!f){alert("กรุณาเลือกประเภทใบเสนอราคา");return}const e=x.reduce((o,u)=>o+u.price*u.quantity,0);let r;N==="percentage"?r=e*(j/100):r=parseFloat(j)||0;const a=e-r,l=a*.07,h=a+l,n={customer_id:S.customer_id,request_ids:S.request_ids,total_amount:parseFloat(e.toFixed(2)),discount_percentage:N==="percentage"?parseFloat(j.toFixed(2)):0,discount_amount:parseFloat(r.toFixed(2)),net_total:parseFloat(a.toFixed(2)),vat_amount:parseFloat(l.toFixed(2)),grand_total:parseFloat(h.toFixed(2)),valid_until:Q,payment_terms:I,status:"pending",created_by:S.created_by,approved_by:null,quotation_type_id:parseInt(f),"test-items-for-quotation":x.map(o=>({test_item_id:o.id,quantity:o.quantity,unit_price:parseFloat(o.price.toFixed(2)).toString(),name_for_quotation:o.name,test_code:o.testCode}))};try{const o=await lt(n);if(o&&o.quotation_id)k.success("สร้างใบเสนอราคาสำเร็จ!",{autoClose:3e3}),F("/admin/issue-quotation/detail",{state:{id:o.quotation_id}});else throw k.error("สร้างใบเสนอราคาไม่สำเร็จ! :",{autoClose:3e3}),new Error("Failed to get quotation ID")}catch(o){console.error("Error generating quotation:",o),k.error("เกิดข้อผิดพลาดในการสร้างใบเสนอราคา! :"+o,{autoClose:3e3}),alert("เกิดข้อผิดพลาดในการสร้างใบเสนอราคา กรุณาลองใหม่")}};return t.jsx(t.Fragment,{children:t.jsx(d,{children:t.jsxs(p,{children:[t.jsx(p.Header,{children:t.jsx(d,{children:t.jsx(c,{children:t.jsx(p.Title,{as:"h5",children:"สร้างใบเสนอราคา"})})})}),t.jsxs(p.Body,{children:[t.jsx(p,{className:"mb-3",children:t.jsx(p.Body,{className:"pt-3 pb-2",children:t.jsxs(d,{children:[t.jsx(c,{md:12,children:t.jsx("h6",{className:"mb-3",children:"ข้อมูลลูกค้า/บริษัท"})}),t.jsx(c,{md:6,className:"mb-2",children:t.jsxs(s.Group,{as:d,className:"align-items-center",children:[t.jsx(s.Label,{column:!0,xs:4,className:"text-dark",children:"รหัสลูกค้า:"}),t.jsx(c,{xs:8,children:t.jsx(s.Control,{type:"text",value:y.company_code||"-",disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(c,{md:6,className:"mb-2",children:t.jsxs(s.Group,{as:d,className:"align-items-center",children:[t.jsx(s.Label,{column:!0,xs:4,className:"text-dark",children:"ชื่อบริษัท:"}),t.jsx(c,{xs:8,children:t.jsx(s.Control,{type:"text",value:y.company_name||"-",disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(c,{md:6,className:"mb-2",children:t.jsxs(s.Group,{as:d,className:"align-items-center",children:[t.jsx(s.Label,{column:!0,xs:4,className:"text-dark",children:"เลขที่ผู้เสียภาษี:"}),t.jsx(c,{xs:8,children:t.jsx(s.Control,{type:"text",value:y.tax_id||"-",disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(c,{md:6,className:"mb-2",children:t.jsxs(s.Group,{as:d,className:"align-items-center",children:[t.jsx(s.Label,{column:!0,xs:4,className:"text-dark",children:"ที่อยู่:"}),t.jsx(c,{xs:8,children:t.jsx(s.Control,{type:"text",value:y.company_address||"-",disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(c,{md:6,className:"mb-2",children:t.jsxs(s.Group,{as:d,className:"align-items-center",children:[t.jsx(s.Label,{column:!0,xs:4,className:"text-dark",children:"เงื่อนไขพิเศษ:"}),t.jsx(c,{xs:8,children:t.jsx(s.Control,{type:"text",value:y.customer_special_conditions&&y.customer_special_conditions.length>0?y.customer_special_conditions.map(e=>e.description).join(", "):"-",disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(c,{md:6,className:"mb-2",children:t.jsxs(s.Group,{as:d,className:"align-items-center",children:[t.jsx(s.Label,{column:!0,xs:4,className:"text-dark",children:"วันที่เอกสาร:"}),t.jsx(c,{xs:8,children:t.jsx(s.Control,{type:"date",value:E,disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(c,{md:6,className:"mb-2",children:t.jsxs(s.Group,{as:d,className:"align-items-center",children:[t.jsx(s.Label,{column:!0,xs:4,className:"text-dark",children:"เงื่อนไขการชำระเงิน:"}),t.jsx(c,{xs:8,children:t.jsx(s.Control,{type:"text",value:I,onChange:e=>G(e.target.value),placeholder:"เช่น 30 วัน"})})]})}),t.jsx(c,{md:6,className:"mb-2",children:t.jsxs(s.Group,{as:d,className:"align-items-center",children:[t.jsx(s.Label,{column:!0,xs:4,className:"text-dark",children:"ใช้ได้ถึงวันที่:"}),t.jsx(c,{xs:8,children:t.jsx(s.Control,{type:"date",value:Q,onChange:e=>P(e.target.value)})})]})})]})})}),t.jsx(p,{className:"mb-0",children:t.jsxs(p.Body,{className:"pt-3 pb-2",children:[t.jsx(d,{children:t.jsx(c,{className:"ps-3 pe-3",children:t.jsx(nt,{name:"quotation_type_id",value:f,onSelect:e=>L(e)})})}),t.jsxs(dt,{striped:!0,bordered:!0,hover:!0,children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{width:80,className:"text-center",children:"เลือก"}),t.jsx("th",{children:"ชื่อตัวอย่าง"}),t.jsx("th",{className:"text-center",children:"Code"}),t.jsx("th",{width:120,className:"text-center",children:"จำนวน"}),t.jsx("th",{width:150,className:"text-center",children:"ราคาต่อหน่วย"}),t.jsx("th",{width:150,className:"text-end",children:"รวม"})]})}),t.jsxs("tbody",{children:[C.map((e,r)=>t.jsxs("tr",{children:[t.jsx("td",{className:"text-center",children:t.jsx(s.Check,{type:"checkbox",checked:x.some(a=>a.id===e.id),onChange:()=>$(e)})}),t.jsx("td",{style:{whiteSpace:"normal",wordWrap:"break-word",maxHeight:"100px",overflowY:"auto"},children:e.name}),t.jsx("td",{className:"text-center",style:{whiteSpace:"normal",wordWrap:"break-word",maxHeight:"100px",overflowY:"auto"},children:e.testCode}),t.jsx("td",{children:t.jsx(s.Control,{type:"number",value:e.quantity,min:1,max:e.maxQuantity,onChange:a=>z(e.id,a.target.value),style:{width:"100px",margin:"auto"}})}),t.jsx("td",{children:t.jsx(s.Control,{type:"number",value:e.price,step:"1",onChange:a=>O(e.id,a.target.value),style:{width:"100px",margin:"auto"}})}),t.jsx("td",{className:"text-end",children:g(e.summary)})]},e.id)),f==="3"&&t.jsxs("tr",{children:[t.jsx("td",{colSpan:4,className:"text-end",children:"ส่วนลด"}),t.jsx("td",{className:"text-center",children:t.jsx(s.Control,{type:"number",value:j,min:0,step:"0.01",onChange:e=>J(e.target.value),style:{width:"100px",margin:"auto"}})}),t.jsx("td",{children:t.jsxs(s.Select,{value:N,onChange:e=>K(e.target.value),style:{width:"100px",margin:"auto"},children:[t.jsx("option",{value:"percentage",children:"%"}),t.jsx("option",{value:"amount",children:"บาท"})]})})]}),t.jsxs("tr",{children:[t.jsx("td",{colSpan:5,className:"text-end",children:t.jsx("p",{className:"mb-0 text-dark",children:"ราคารวมก่อนส่วนลด:"})}),t.jsx("td",{className:"text-end",children:t.jsxs("p",{className:"mb-0 text-dark",children:[g(V)," บาท"]})})]}),t.jsxs("tr",{children:[t.jsx("td",{colSpan:5,className:"text-end",children:t.jsxs("p",{className:"mb-0 text-dark",children:["ส่วนลด (",N==="percentage"?`${j}%`:`${g(j)} บาท`,"):"]})}),t.jsx("td",{className:"text-end",children:t.jsxs("p",{className:"mb-0 text-dark",children:[g(H)," บาท"]})})]}),t.jsxs("tr",{children:[t.jsx("td",{colSpan:5,className:"text-end",children:t.jsx("p",{className:"mb-0 text-dark",children:"ราคาสุทธิ :"})}),t.jsx("td",{className:"text-end",children:t.jsxs("p",{className:"mb-0 text-dark",children:[g(W)," บาท"]})})]}),t.jsxs("tr",{children:[t.jsx("td",{colSpan:5,className:"text-end",children:t.jsx("p",{className:"mb-2 text-dark",children:"VAT 7%:"})}),t.jsx("td",{className:"text-end",children:t.jsxs("p",{className:"mb-2 text-dark",children:[g(X)," บาท"]})})]}),t.jsxs("tr",{children:[t.jsx("td",{colSpan:5,className:"text-end",children:t.jsx("h6",{className:"mb-0",children:"ยอดรวมทั้งหมด :"})}),t.jsx("td",{className:"text-end",children:t.jsxs("h6",{children:[g(Y)," บาท"]})})]})]})]})]})})]}),t.jsxs(p.Footer,{children:[t.jsxs(T,{variant:"success",onClick:Z,children:[t.jsx(rt,{style:{fontSize:18,marginRight:6}})," สร้างใบเสนอราคา"]}),t.jsxs(T,{variant:"danger",onClick:()=>F("/admin/issue-quotation"),children:[t.jsx("i",{className:"feather icon-corner-up-left"})," ยกเลิก"]})]})]})})})};export{bt as default};
