import{u as Z,a as tt,r as d,j as t,R as c,C as i,B as L,y as _}from"./index-6YeC_AS5.js";import{Q as et}from"./QuotationTypeSelect-D_xhK8U0.js";import{b as at,h as st,a as nt,i as ot}from"./quotationRequest-BTgCnPa-.js";import{d as rt}from"./index-DpgziKTs.js";import{C as x}from"./Card-BhOVTKNa.js";import{F as n}from"./Form-CGCyrcfL.js";import{T as it}from"./Table-WM_kTK7U.js";const jt=()=>{var M;const f=Z(),g=((M=tt().state)==null?void 0:M.id)||null,[u,q]=d.useState([]),[h,C]=d.useState(0),[N,S]=d.useState("percentage"),[F,k]=d.useState([]),[p,G]=d.useState({}),[v,T]=d.useState(""),[j,E]=d.useState(null),[U,V]=d.useState(""),[D,Q]=d.useState(""),[I,A]=d.useState("");d.useEffect(()=>{(async()=>{if(!g){_.error("ไม่พบ ID ใบเสนอราคา"),f("/admin/issue-quotation");return}try{const a=await at(g);E(a);const r=a.customer_info[0]||{};G({company_code:r.company_code||"-",company_name:r.company_name||"-",tax_id:r.tax_id||"-",company_address:r.company_address||"-",customer_special_conditions:r.special_conditions?[{description:r.special_conditions}]:[]});const m=a.quotation_details.map(s=>({id:s.quotation_detail_id,quotation_detail_id:s.quotation_detail_id,test_item_id:s.test_item_id,name:s.name_for_quotation,price:parseFloat(s.unit_price),quantity:s.quantity,maxQuantity:s.quantity,summary:parseFloat(s.total_price),testCode:s.test_code}));k(m),q(m),parseFloat(a.discount_percentage)>0?(S("percentage"),C(parseFloat(a.discount_percentage))):parseFloat(a.discount_amount)>0&&(S("amount"),C(parseFloat(a.discount_amount))),V(new Date(a.quotation_date).toISOString().split("T")[0]),Q(a.payment_terms||"30 วัน"),A(new Date(a.valid_until).toISOString().split("T")[0]),T(a.quotation_type_id.toString())}catch(o){console.error("Error fetching quotation data:",o),_.error("เกิดข้อผิดพลาดในการดึงข้อมูลใบเสนอราคา"),f("/admin/issue-quotation")}})()},[g,f]);const B=()=>{const e=u.reduce((s,w)=>s+w.price*w.quantity,0);let o;N==="percentage"?o=e*(h/100):o=parseFloat(h)||0;const a=e-o,r=a*.07,m=a+r;return{totalAmount:e,discountAmount:o,netTotal:a,vatAmount:r,grandTotal:m}},{totalAmount:P,discountAmount:R,netTotal:H,vatAmount:O,grandTotal:W}=B(),y=e=>e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),Y=e=>{const o=u.find(r=>r.id===e.id);let a;o?a=u.filter(r=>r.id!==e.id):a=[...u,{...e}],q(a)},$=(e,o)=>{const a=parseInt(o)||0,r=F.map(s=>s.id===e?{...s,quantity:Math.max(1,Math.min(s.maxQuantity,a)),summary:s.price*Math.max(1,Math.min(s.maxQuantity,a))}:s);k(r);const m=u.map(s=>s.id===e?{...s,quantity:Math.max(1,Math.min(s.maxQuantity,a)),summary:s.price*Math.max(1,Math.min(s.maxQuantity,a))}:s);q(m)},z=(e,o)=>{const a=parseFloat(o)||0,r=F.map(s=>s.id===e?{...s,price:a,summary:a*s.quantity}:s);k(r);const m=u.map(s=>s.id===e?{...s,price:a,summary:a*s.quantity}:s);q(m)},J=e=>{const o=parseFloat(e)||0;C(N==="percentage"?Math.max(0,Math.min(100,o)):Math.max(0,o))},K=e=>{S(e),C(0)},X=async()=>{if(u.length===0){_.error("กรุณาเลือกอย่างน้อย 1 รายการเพื่อแก้ไขใบเสนอราคา");return}if(!v){_.error("กรุณาเลือกประเภทใบเสนอราคา");return}try{const e=u.reduce((l,b)=>l+b.price*b.quantity,0);let o;N==="percentage"?o=e*(h/100):o=parseFloat(h)||0;const a=e-o,r=a*.07,m=a+r;for(const l of u){const b={test_item_id:l.test_item_id||null,quantity:l.quantity,unit_price:parseFloat(l.price.toFixed(2)).toString(),subtotal_price:(l.quantity*l.price).toFixed(2),discount_amount:"0.00",total_price:(l.quantity*l.price).toFixed(2)};console.log("quotationDetailPayload:",b),console.log("item.quotation_detail_id:",l.quotation_detail_id),l.quotation_detail_id?await st(l.quotation_detail_id,b):await nt(g,b)}const s={customer_id:j.customer_id,total_amount:parseFloat(e.toFixed(2)),discount_percentage:N==="percentage"?parseFloat(h.toFixed(2)):0,discount_amount:parseFloat(o.toFixed(2)),net_total:parseFloat(a.toFixed(2)),vat_amount:parseFloat(r.toFixed(2)),grand_total:parseFloat(m.toFixed(2)),valid_until:I,payment_terms:D,status:j.status,created_by:j.created_by,approved_by:j.approved_by,quotation_type_id:parseInt(v)};if(await ot(g,s))_.success("แก้ไขใบเสนอราคาสำเร็จ!",{autoClose:3e3}),f("/admin/issue-quotation/detail",{state:{id:g}});else throw new Error("Failed to update quotation")}catch(e){console.error("Error updating quotation:",e),_.error("เกิดข้อผิดพลาดในการแก้ไขใบเสนอราคา! :"+e,{autoClose:3e3}),_.error("เกิดข้อผิดพลาดในการแก้ไขใบเสนอราคา กรุณาลองใหม่")}};return t.jsx(t.Fragment,{children:t.jsx(c,{children:t.jsxs(x,{children:[t.jsx(x.Header,{children:t.jsx(c,{children:t.jsx(i,{children:t.jsxs(x.Title,{as:"h5",children:["แก้ไขใบเสนอราคา (เลขที่: ",(j==null?void 0:j.quotation_no)||"-",")"]})})})}),t.jsxs(x.Body,{children:[t.jsx(x,{className:"mb-3",children:t.jsx(x.Body,{className:"pt-3 pb-2",children:t.jsxs(c,{children:[t.jsx(i,{md:12,children:t.jsx("h6",{className:"mb-3",children:"ข้อมูลลูกค้า/บริษัท"})}),t.jsx(i,{md:6,className:"mb-2",children:t.jsxs(n.Group,{as:c,className:"align-items-center",children:[t.jsx(n.Label,{column:!0,xs:4,className:"text-dark",children:"รหัสลูกค้า:"}),t.jsx(i,{xs:8,children:t.jsx(n.Control,{type:"text",value:p.company_code||"-",disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(i,{md:6,className:"mb-2",children:t.jsxs(n.Group,{as:c,className:"align-items-center",children:[t.jsx(n.Label,{column:!0,xs:4,className:"text-dark",children:"ชื่อบริษัท:"}),t.jsx(i,{xs:8,children:t.jsx(n.Control,{type:"text",value:p.company_name||"-",disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(i,{md:6,className:"mb-2",children:t.jsxs(n.Group,{as:c,className:"align-items-center",children:[t.jsx(n.Label,{column:!0,xs:4,className:"text-dark",children:"เลขที่ผู้เสียภาษี:"}),t.jsx(i,{xs:8,children:t.jsx(n.Control,{type:"text",value:p.tax_id||"-",disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(i,{md:6,className:"mb-2",children:t.jsxs(n.Group,{as:c,className:"align-items-center",children:[t.jsx(n.Label,{column:!0,xs:4,className:"text-dark",children:"ที่อยู่:"}),t.jsx(i,{xs:8,children:t.jsx(n.Control,{type:"text",value:p.company_address||"-",disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(i,{md:6,className:"mb-2",children:t.jsxs(n.Group,{as:c,className:"align-items-center",children:[t.jsx(n.Label,{column:!0,xs:4,className:"text-dark",children:"เงื่อนไขพิเศษ:"}),t.jsx(i,{xs:8,children:t.jsx(n.Control,{type:"text",value:p.customer_special_conditions&&p.customer_special_conditions.length>0?p.customer_special_conditions.map(e=>e.description).join(", "):"-",disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(i,{md:6,className:"mb-2",children:t.jsxs(n.Group,{as:c,className:"align-items-center",children:[t.jsx(n.Label,{column:!0,xs:4,className:"text-dark",children:"วันที่เอกสาร:"}),t.jsx(i,{xs:8,children:t.jsx(n.Control,{type:"date",value:U,disabled:!0,style:{backgroundColor:"#f8f9fa"}})})]})}),t.jsx(i,{md:6,className:"mb-2",children:t.jsxs(n.Group,{as:c,className:"align-items-center",children:[t.jsx(n.Label,{column:!0,xs:4,className:"text-dark",children:"เงื่อนไขการชำระเงิน:"}),t.jsx(i,{xs:8,children:t.jsx(n.Control,{type:"text",value:D,onChange:e=>Q(e.target.value),placeholder:"เช่น 30 วัน"})})]})}),t.jsx(i,{md:6,className:"mb-2",children:t.jsxs(n.Group,{as:c,className:"align-items-center",children:[t.jsx(n.Label,{column:!0,xs:4,className:"text-dark",children:"ใช้ได้ถึงวันที่:"}),t.jsx(i,{xs:8,children:t.jsx(n.Control,{type:"date",value:I,onChange:e=>A(e.target.value)})})]})})]})})}),t.jsx(x,{className:"mb-0",children:t.jsxs(x.Body,{className:"pt-3 pb-2",children:[t.jsx(c,{children:t.jsx(i,{className:"ps-3 pe-3",children:t.jsx(et,{name:"quotation_type_id",value:v,onSelect:e=>T(e)})})}),t.jsxs(it,{striped:!0,bordered:!0,hover:!0,children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{width:80,className:"text-center",children:"เลือก"}),t.jsx("th",{children:"ชื่อตัวอย่าง"}),t.jsx("th",{className:"text-center",children:"Code"}),t.jsx("th",{width:120,className:"text-center",children:"จำนวน"}),t.jsx("th",{width:150,className:"text-center",children:"ราคาต่อหน่วย"}),t.jsx("th",{width:150,className:"text-end",children:"รวม"})]})}),t.jsxs("tbody",{children:[F.map((e,o)=>t.jsxs("tr",{children:[t.jsx("td",{className:"text-center",children:t.jsx(n.Check,{type:"checkbox",checked:u.some(a=>a.id===e.id),onChange:()=>Y(e)})}),t.jsx("td",{style:{whiteSpace:"normal",wordWrap:"break-word",maxHeight:"100px",overflowY:"auto"},children:e.name}),t.jsx("td",{className:"text-center",style:{whiteSpace:"normal",wordWrap:"break-word",maxHeight:"100px",overflowY:"auto"},children:e.testCode}),t.jsx("td",{children:t.jsx(n.Control,{type:"number",value:e.quantity,min:1,max:e.maxQuantity,onChange:a=>$(e.id,a.target.value),style:{width:"100px",margin:"auto"}})}),t.jsx("td",{children:t.jsx(n.Control,{type:"number",value:e.price,step:"1",onChange:a=>z(e.id,a.target.value),style:{width:"100px",margin:"auto"}})}),t.jsx("td",{className:"text-end",children:y(e.summary)})]},e.id)),v==="3"&&t.jsxs("tr",{children:[t.jsx("td",{colSpan:4,className:"text-end",children:"ส่วนลด"}),t.jsx("td",{className:"text-center",children:t.jsx(n.Control,{type:"number",value:h,min:0,step:"0.01",onChange:e=>J(e.target.value),style:{width:"100px",margin:"auto"}})}),t.jsx("td",{children:t.jsxs(n.Select,{value:N,onChange:e=>K(e.target.value),style:{width:"100px",margin:"auto"},children:[t.jsx("option",{value:"percentage",children:"%"}),t.jsx("option",{value:"amount",children:"บาท"})]})})]}),t.jsxs("tr",{children:[t.jsx("td",{colSpan:5,className:"text-end",children:t.jsx("p",{className:"mb-0 text-dark",children:"ราคารวมก่อนส่วนลด:"})}),t.jsx("td",{className:"text-end",children:t.jsxs("p",{className:"mb-0 text-dark",children:[y(P)," บาท"]})})]}),t.jsxs("tr",{children:[t.jsx("td",{colSpan:5,className:"text-end",children:t.jsxs("p",{className:"mb-0 text-dark",children:["ส่วนลด (",N==="percentage"?`${h}%`:`${y(h)} บาท`,"):"]})}),t.jsx("td",{className:"text-end",children:t.jsxs("p",{className:"mb-0 text-dark",children:[y(R)," บาท"]})})]}),t.jsxs("tr",{children:[t.jsx("td",{colSpan:5,className:"text-end",children:t.jsx("p",{className:"mb-0 text-dark",children:"ราคาสุทธิ :"})}),t.jsx("td",{className:"text-end",children:t.jsxs("p",{className:"mb-0 text-dark",children:[y(H)," บาท"]})})]}),t.jsxs("tr",{children:[t.jsx("td",{colSpan:5,className:"text-end",children:t.jsx("p",{className:"mb-0 text-dark",children:"VAT 7%:"})}),t.jsx("td",{className:"text-end",children:t.jsxs("p",{className:"mb-0 text-dark",children:[y(O)," บาท"]})})]}),t.jsxs("tr",{children:[t.jsx("td",{colSpan:5,className:"text-end",children:t.jsx("h6",{className:"mb-0",children:"ยอดรวมทั้งหมด :"})}),t.jsx("td",{className:"text-end",children:t.jsxs("h6",{className:"mb-0",children:[y(W)," บาท"]})})]})]})]})]})})]}),t.jsxs(x.Footer,{children:[t.jsxs(L,{variant:"success",onClick:X,children:[t.jsx(rt,{style:{fontSize:18,marginRight:6}})," บันทึกการแก้ไข"]}),t.jsxs(L,{variant:"danger",onClick:()=>f("/admin/issue-quotation"),children:[t.jsx("i",{className:"feather icon-corner-up-left"})," ยกเลิก"]})]})]})})})};export{jt as default};
