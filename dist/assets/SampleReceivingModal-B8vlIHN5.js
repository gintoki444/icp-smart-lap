import{r as x,j as e,B as k,ar as Q,as as W,y as _}from"./index-6YeC_AS5.js";import{c as X,e as Y,d as Z,a as D,F as I}from"./formik.esm-C0GtiMNK.js";import"./firebaseConfig-pMHECxRz.js";import{a as q}from"./trackingRequest-wN0MMLEF.js";import{F as O,I as ee}from"./FirebaseImage-DiJQPKTY.js";import{a as se,g as te}from"./sampleSubmissionsRequest-bNYMIj3U.js";import{c as ae,a as re,p as w,d as H}from"./serviceRequest-CJ15hpJs.js";import{T as ie}from"./Table-WM_kTK7U.js";import{B as ne}from"./Badge-C_mrIdUk.js";import{B as oe,b as B}from"./DataGrid-DoczE-38.js";import{M as S}from"./Modal-D05P99kH.js";import{F as r}from"./Form-CGCyrcfL.js";const F="https://apiav2-jlp2nagalq-as.a.run.app/api",ce=async m=>{const c=new Headers;c.append("Content-Type","application/json"),console.log("postSampleStatus",m);const j=JSON.stringify(m),v={method:"POST",headers:c,body:j,redirect:"follow"};try{const u=await fetch(F+"/sample-status-array",v);if(!u.ok){const C=await u.json();throw new Error(C.message||`HTTP Error: ${u.status}`)}return await u.json()}catch(u){throw console.error("Save SampleStatus data Error:",u),u}},le=async m=>{const c=new Headers;c.append("Content-Type","application/json");const j={method:"DELETE",headers:c,redirect:"follow"};return await(await fetch(F+"/sample-status/"+m,j)).json()},Ce=({serviceData:m,submissionId:c,handleTracking:j,trackingData:v,reviewBy:u,sampleNo:C,reloadData:A,sampleStatus:M,serviceRequestId:h})=>{const[de,me]=x.useState(m),[ue,pe]=x.useState(!1),[G,f]=x.useState(!1),[y,P]=x.useState(v),[b,$]=x.useState(null),[T,R]=x.useState([]);x.useEffect(()=>{(()=>{P(v),R(M.sample_status_tracking)})()},[A]);const U=X({carrier_name:D().required("กรุณาเลือกผู้ให้บริการจัดส่ง"),tracking_number:D().required("กรุณากรอกหมายเลข Tracking"),proof_image:Z().nullable(),deliveredToLab:Y().oneOf([!0],'กรุณาเลือก "ตัวอย่างจัดส่งถึงแลป"')}),N=async()=>{try{const s=await te(h),t=s.length,n=(await re(h)).service_status_logs||{},i=s.reduce((o,E)=>{const V=(E.sample_tracking||[]).some(L=>L.submission_id===E.submission_id&&L.received_by!==null);return o+(V?1:0)},0)===t,g=s.flatMap(o=>o.sample_status_tracking||[]),a=g.some(o=>o.status==="delivered_to_lab");console.log("isSampleSentComplete",i),console.log("hasDeliveredToLab",a),console.log("statusLogs.sample_sent",n.sample_sent),i&&a&&n.sample_sent===null&&(await w(h,{newStatusTracking:"sample_sent"}),_.success("สถานะอัปเดต: ตัวอย่างถูกส่งครบแล้ว",{autoClose:3e3}));const p=g.filter(o=>o.status==="delivered_to_lab").length;p>=t&&n.sample_arrived_lab===null?(await w(h,{newStatusTracking:"sample_arrived_lab"}),_.success("สถานะอัปเดต: ตัวอย่างจัดส่งถึงแลปครบแล้ว",{autoClose:3e3})):p<t&&n.sample_arrived_lab!==null&&(await H(h,{StatusTracking:"sample_arrived_lab"}),_.info("สถานะถูกลบ: ตัวอย่างยังไม่ถึงแลปครบ",{autoClose:3e3}));const d=g.filter(o=>o.status==="received_in_system").length;d>=t&&n.sample_received===null?(await w(h,{newStatusTracking:"sample_received"}),_.success("สถานะอัปเดต: รับตัวอย่างเข้าระบบครบแล้ว",{autoClose:3e3})):d<t&&n.sample_received!==null&&(await H(h,{StatusTracking:"sample_received"}),_.info("สถานะถูกลบ: ตัวอย่างยังไม่ถูกรับเข้าระบบครบ",{autoClose:3e3}))}catch(s){console.error("Error in checkAndUpdateStatus:",s),_.error("เกิดข้อผิดพลาดในการอัปเดตสถานะ",{autoClose:3e3})}},z=async(s,{setSubmitting:t,setErrors:n})=>{var l;try{let i=[];const g=(l=m.sample_submissions.find(a=>a.submission_id===c))==null?void 0:l.submission_no;if(console.log("serviceData.sample_submissions.find:",m.sample_submissions.find(a=>a.submission_id===c)),console.log("submissionNo:",g),g||await se(c),m.request_no||await ae(h),s.deliveredToLab){const a={submission_id:c,status:"delivered_to_lab",notes:"ตัวอย่างจัดส่งถึงแล็บ"};T.some(d=>d.submission_id===a.submission_id&&d.status===a.status)||i.push({...a,id:i.length+1})}if(s.receiveOption==="received"){const a={submission_id:c,status:"received_in_system",notes:"รับตัวอย่างเข้าระบบ"};T.some(d=>d.submission_id===a.submission_id&&d.status===a.status)||i.push({...a,id:i.length+1})}if(i.length>0){const a=await ce(i);console.log("postSampleStatusArray:",a)}if(c&&!s.received_by){const a={status:"in_processing",received_by:u},p=await q(b.tracking_id,a);console.log("responseSampleTracking:",p),j(!0),f(!1)}await N()}catch(i){console.error("Error updating tracking data:",i),n({submit:"เกิดข้อผิดพลาดในการแก้ไขข้อมูล กรุณาลองใหม่"}),t(!1)}},J=s=>{const t=y.find(n=>n.tracking_id===s);console.log("dataToEdit:",t),$(t),f(!0)},K=async s=>{if(window.confirm("คุณต้องการลบข้อมูลการจัดส่งตัวอย่าง หรือไม่?"))try{T.map(i=>{(i.status==="received_in_system"||i.status==="delivered_to_lab")&&le(i.id)}),await q(s,{status:"received",received_by:null})&&(_.success("ยกเลิกการรับตัวอย่างสำเร็จ!",{autoClose:3e3}),j(!0)),await N()}catch(n){_.error("ยกเลิกการรับตัวอย่างไม่สำเร็จ! :"+n,{autoClose:3e3})}};return e.jsxs(e.Fragment,{children:[e.jsx("h6",{className:"mb-3 mt-3",children:"ข้อมูลการจัดส่งตัวอย่าง"}),e.jsxs(ie,{striped:!0,bordered:!0,hover:!0,className:"mt-2",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{width:80,className:"text-center",children:"#"}),e.jsx("th",{children:"ผู้ให้บริการจัดส่ง"}),e.jsx("th",{children:"หมายเลข Tracking"}),e.jsx("th",{className:"text-center",width:180,children:"สถานะ"}),e.jsx("th",{className:"text-center",children:"หลักฐานการส่ง"}),e.jsx("th",{className:"text-center",children:"Action"})]})}),e.jsx("tbody",{children:y.length>0?y.map((s,t)=>e.jsxs("tr",{children:[e.jsx("td",{className:"text-center",children:t+1}),e.jsx("td",{children:s.carrier_name}),e.jsx("td",{children:s.tracking_number}),e.jsx("td",{className:"text-center",children:e.jsx(ne,{pill:!0,bg:s.status==="received"?"info":s.status==="in_processing"?"warning":s.status==="completed"?"primary":"success",children:s.status==="received"?"ดำเนินการจัดส่ง":s.status==="in_processing"?"กำลังทดสอบ":s.status==="completed"?"ทดสอบเสร็จสิ้น":"จัดส่งสำเร็จ"})}),e.jsx("td",{className:"text-center",children:e.jsx(O,{imagePath:s.proof_image,alt:`Proof for ${s.tracking_number}`,style:{maxHeight:"100px"},thumbnail:!0})}),e.jsx("td",{className:"text-center",width:200,children:e.jsx(oe,{children:s.received_by?e.jsx(B,{title:"ยกเลิกรับตัวอย่าง",placement:"bottom",arrow:!0,children:e.jsxs(k,{variant:"danger",size:"sm",onClick:()=>K(s.tracking_id),children:[e.jsx(W,{})," ยกเลิกรับตัวอย่าง"]})}):e.jsx(B,{title:"รับตัวอย่าง",placement:"bottom",arrow:!0,children:e.jsxs(k,{variant:"success",size:"sm",onClick:()=>J(s.tracking_id),children:[e.jsx(Q,{className:"me-2",style:{fontSize:16}})," รับตัวอย่าง"]})})})})]},`${s.tracking_number}-${s.id}`)):e.jsx("tr",{children:e.jsx("th",{width:80,className:"text-center",colSpan:6,children:"ไม่มีข้อมูล"})})})]}),b&&e.jsxs(S,{show:G,onHide:()=>f(!1),centered:!0,children:[e.jsx(S.Header,{closeButton:!0,children:e.jsx(S.Title,{children:e.jsx("h6",{children:"ยืนยันการรับตัวอย่าง"})})}),e.jsx(I,{initialValues:{carrier_name:b.carrier_name,tracking_number:b.tracking_number,proof_image:null,status:b.status,received_by:b.received_by,deliveredToLab:!0,receiveOption:"received"},validationSchema:U,onSubmit:z,children:({values:s,errors:t,touched:n,handleChange:l,handleBlur:i,handleSubmit:g,setFieldValue:a,isSubmitting:p})=>e.jsxs(r,{onSubmit:g,children:[e.jsxs(S.Body,{children:[t.submit&&e.jsx("div",{className:"text-danger mb-3",children:t.submit}),e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"ผู้ให้บริการจัดส่ง"}),e.jsxs(r.Select,{name:"carrier_name",value:s.carrier_name,onChange:l,disabled:!0,onBlur:i,isInvalid:n.carrier_name&&!!t.carrier_name,children:[e.jsx("option",{value:"",children:"เลือกผู้ให้บริการจัดส่ง"}),e.jsx("option",{value:"ไปรษณีย์ไทย",children:"ไปรษณีย์ไทย"}),e.jsx("option",{value:"Kerry Express",children:"Kerry Express"}),e.jsx("option",{value:"J&T Express",children:"J&T Express"}),e.jsx("option",{value:"DHL",children:"DHL"})]}),e.jsx(r.Control.Feedback,{type:"invalid",children:t.carrier_name})]}),e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"หมายเลข Tracking"}),e.jsx(r.Control,{type:"text",name:"tracking_number",placeholder:"กรอกหมายเลข Tracking",disabled:!0,value:s.tracking_number,onChange:l,onBlur:i,isInvalid:n.tracking_number&&!!t.tracking_number}),e.jsx(r.Control.Feedback,{type:"invalid",children:t.tracking_number})]}),e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"หลักฐานการส่ง (ถ้าต้องการเปลี่ยน)"}),e.jsx(r.Control,{type:"file",accept:"image/*",disabled:!0,onChange:d=>a("proof_image",d.target.files[0]),isInvalid:n.proof_image&&!!t.proof_image}),e.jsx("div",{className:"mt-3",children:s.proof_image?e.jsx(ee,{src:URL.createObjectURL(s.proof_image),alt:"New Proof",thumbnail:!0,style:{maxHeight:"200px"}}):e.jsx(O,{imagePath:b.proof_image,alt:"Current Proof",style:{maxHeight:"200px"},thumbnail:!0})}),e.jsx(r.Control.Feedback,{type:"invalid",children:t.proof_image})]}),e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Check,{type:"checkbox",label:"ตัวอย่างจัดส่งถึงแลป",name:"deliveredToLab",checked:s.deliveredToLab,onChange:l,onBlur:i,isInvalid:n.deliveredToLab&&!!t.deliveredToLab}),e.jsx(r.Control.Feedback,{type:"invalid",children:t.deliveredToLab})]}),e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"รับตัวอย่างเข้าระบบ"}),e.jsxs("div",{children:[e.jsx(r.Check,{type:"radio",label:"รับสินค้าเข้าระบบ",name:"receiveOption",value:"received",checked:s.receiveOption==="received",onChange:l,inline:!0}),e.jsx(r.Check,{type:"radio",label:"ไม่รับ",name:"receiveOption",value:"not_received",checked:s.receiveOption==="not_received",onChange:l,inline:!0})]})]})]}),e.jsxs(S.Footer,{children:[e.jsx(k,{variant:"success",type:"submit",disabled:p,children:"ยืนยัน"}),e.jsx(k,{variant:"secondary",onClick:()=>f(!1),disabled:p,children:"ยกเลิก"})]})]})})]})]})};export{Ce as S,le as d,ce as p};
