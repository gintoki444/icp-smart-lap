import{r as n,u as O,h as M,y as _,aA as V,j as s,R as C,C as p,B as h,i as W,k as $,F as J,v as K}from"./index-CMKGjvil.js";import{e as Q,f as X}from"./serviceRequest-CJ15hpJs.js";import{g as Y}from"./specialConditionsRequest-B-G5iiQh.js";import{C as o}from"./Card-ltuRbL1m.js";import{S as Z}from"./Stack-_RiFjssk.js";import{F as ee}from"./Form-XAT3KesX.js";import{B as se}from"./Badge-Degbu7BZ.js";import{D as te,B as ae}from"./DataGrid-BSrFaLwh.js";import"./DefaultPropsProvider-7CXMMYWk.js";import"./emotion-element-f0de968e.browser.esm-D2ySOhvj.js";import"./TextField-l4tn0KBj.js";import"./toPropertyKey-BZFHAmHd.js";import"./Transition-CvY6YelV.js";import"./setPrototypeOf-DgZC2w_0.js";import"./Divider-Rbts8ePN.js";const ye=()=>{const[m,T]=n.useState(null),[g,z]=n.useState([]),[w,S]=n.useState([]),[y,A]=n.useState([]),[l,N]=n.useState(()=>localStorage.getItem("filterText")||""),[u,c]=n.useState(!1),j=O();n.useEffect(()=>{const e=localStorage.getItem("authToken");e&&(c(!0),M(e).then(t=>{T(t.user),I(t.user.user_id)}).catch(t=>{_.error("ไม่สามารถตรวจสอบผู้ใช้ได้"),console.error(t)}).finally(()=>c(!1)))},[]);const F=async e=>{try{return await Y(e)}catch(t){return console.error(t),null}},I=async e=>{try{const t=await V(e);if(console.log("result:",t),t){const i=await Promise.all(t.map(async(a,f)=>{const x=await F(a.company_id);return{id:a.company_id,No:f+1,company_name:a.company_name||"ไม่ระบุชื่อบริษัท",company_code:a.company_code||"ไม่ระบุรหัส",company_address:a.company_address||"ไม่ระบุที่อยู่",document_address:a.document_address,tax_id:a.tax_id||"ไม่ระบุ",company_email:a.company_email,company_phone:a.company_phone,special_conditions:x||a.special_conditions,created_at:new Date(a.created_at).toLocaleString(),status:a.status,customer_contacts:a.customer_contacts}}));console.log("formattedCustomers:",i),z(i);const r=i.filter(a=>a.special_conditions).flatMap(a=>Array.isArray(a.special_conditions)?a.special_conditions:[a.special_conditions]);A(r),await q(e)}}catch(t){_.error("เกิดข้อผิดพลาดในการดึงข้อมูลลูกค้า"),console.error(t)}},q=async e=>{c(!0);try{const t=await Q(e);if(t.success){const i=t.data.map((r,a)=>({id:r.request_id,No:a+1,request_date:new Date(r.request_date).toLocaleDateString("th-TH"),request_no:r.request_no||"-",user_id:r.user_id,user_name:r.user_name,customer_id:r.customer_id,customer_name:r.customer_name,sample_type_name:r.sample_type_name,is_registration_analysis:r.is_registration_analysis,is_quality_check_analysis:r.is_quality_check_analysis,sample_type_id:r.sample_type_id,special_conditions:r.special_conditions||"-",created_at:new Date(r.created_at).toLocaleDateString("th-TH"),status:r.status,sample_submissions:r.sample_submissions,service_request_documents:r.service_request_documents}));S(i)}else S([])}catch(t){_.error("เกิดข้อผิดพลาดในการดึงข้อมูลคำขอ"),console.error(t)}finally{c(!1)}},v=[{field:"No",headerName:"No.",width:90,headerAlign:"center",align:"center"},{field:"request_no",headerName:"เลขที่คำขอ",flex:.8},{field:"sample_type_name",headerName:"ประเภทปุ๋ย",flex:.7},{field:"request_date",headerName:"วันที่สร้าง",flex:1},{field:"status",headerName:"สถานะ",width:120,headerAlign:"center",align:"center",renderCell:e=>s.jsx(se,{pill:!0,bg:e.row.status==="pending"?"warning":e.row.status==="rejected"?"danger":"success",children:e.row.status==="pending"?"กำลังดำเนินการ":e.row.status==="rejected"?"ไม่อนุมัติ":"อนุมัติ"})},{field:"actions",headerName:"การจัดการ",width:200,headerAlign:"center",align:"center",renderCell:e=>s.jsxs(ae,{children:[s.jsx(h,{variant:"primary",size:"sm",onClick:()=>j("/request/detial",{state:{id:e.row.id}}),children:s.jsx("i",{className:"feather icon-file-text m-0"})}),s.jsx(h,{variant:"info",size:"sm",onClick:()=>U(e.row),children:s.jsx(J,{})}),s.jsx(h,{variant:"outline-danger",size:"sm",onClick:()=>P(e.row.id),children:s.jsx(K,{})})]})}],E=()=>{if(!l.trim())return g.map(t=>({...t,filteredRows:w.filter(i=>i.customer_id===t.id)}));const e=l.toLowerCase();return g.map(t=>{var a,f,x;const i=w.filter(d=>{var k,L,b,D,B;return d.customer_id!==t.id?!1:((k=d.request_no)==null?void 0:k.toLowerCase().includes(e))||((L=d.sample_type_name)==null?void 0:L.toLowerCase().includes(e))||((b=d.request_date)==null?void 0:b.toLowerCase().includes(e))||((D=d.notes)==null?void 0:D.toLowerCase().includes(e))||((B=d.status)==null?void 0:B.toLowerCase().includes(e))}),r=((a=t.company_name)==null?void 0:a.toLowerCase().includes(e))||((f=t.tax_id)==null?void 0:f.toLowerCase().includes(e))||((x=t.company_address)==null?void 0:x.toLowerCase().includes(e));return{...t,filteredRows:i,isVisible:r||i.length>0}}).filter(t=>t.isVisible)};n.useEffect(()=>{localStorage.setItem("filterText",l)},[l]);const H=()=>{N(""),localStorage.removeItem("filterText")},U=e=>{j("/request/edit/",{state:{id:e.id,customer:g}})},P=async e=>{if(window.confirm("คุณต้องการลบข้อมูลคำขอรับบริการ หรือไม่?")){c(!0);try{await X(e)&&(_.success("ลบข้อมูลคำขอรับบริการสำเร็จ!",{autoClose:3e3}),m!=null&&m.user_id&&await q(m.user_id))}catch(i){_.error("ลบข้อมูลคำขอรับบริการไม่สำเร็จ!",{autoClose:3e3}),console.error(i)}finally{c(!1)}}},G=e=>{j("/request/add",{state:{user:m,customer:e}})},R=E();return s.jsxs(o,{children:[s.jsx(o.Header,{children:s.jsx(C,{children:s.jsx(p,{children:s.jsx(o.Title,{as:"h5",children:"รายการคำขอรับบริการ"})})})}),s.jsxs(o.Body,{children:[s.jsxs(Z,{direction:"row",spacing:1,sx:{mb:2},children:[s.jsx(ee.Control,{type:"text",placeholder:"ค้นหาลูกค้า หรือ คำขอรับบริการ...",value:l,onChange:e=>N(e.target.value),disabled:u}),s.jsx(h,{variant:"primary",size:"sm",onClick:H,disabled:!l||u,children:s.jsx(W,{style:{fontSize:20}})})]}),u?s.jsx("div",{children:"Loading..."}):R.length>0?R.map(e=>s.jsxs(o,{className:"mb-3 rounded",children:[s.jsx(o.Header,{style:{background:"#e8f5ff"},children:s.jsxs(C,{className:"align-items-center",children:[s.jsxs(p,{children:[s.jsxs(o.Title,{as:"h6",children:[s.jsx("spen",{style:{fontWeigth:"300"},children:"รหัสลูกค้า"}),": ",e.company_code," - ",e.company_name]}),s.jsxs(C,{children:[s.jsx(p,{md:6,children:s.jsxs("p",{className:"mb-0",children:["เลขที่ผู้เสียภาษี: ",s.jsx("span",{className:"text-dark",children:e.tax_id+" "}),"ที่อยู่: ",s.jsx("span",{className:"text-dark",children:" "+e.company_address})]})}),y&&y.length>0&&s.jsx(p,{md:6,children:s.jsxs("p",{className:"mb-0",children:["เงื่อนไขพิเศษ :"," ",s.jsx("strong",{className:"text-dark",children:y.filter(t=>t.company_id===e.id).map((t,i,r)=>i+1<r.length?`${t.description}, `:t.description)})]})})]})]}),s.jsx(p,{xs:"auto",children:s.jsxs(h,{variant:"success",size:"sm",onClick:()=>G(e),disabled:u,children:[s.jsx("i",{className:"feather icon-plus-circle"})," เพิ่มคำขอ"]})})]})}),s.jsx(o.Body,{children:e.filteredRows.length>0?s.jsx(te,{rows:e.filteredRows,columns:v,pageSize:5,rowsPerPageOptions:[5,10,20],pagination:!0,disableSelectionOnClick:!0,hideFooterSelectedRowCount:!0,loading:u,autoHeight:!0}):s.jsx("div",{className:"text-center",children:s.jsx("p",{className:"mt-2",children:"ไม่พบคำขอรับบริการสำหรับบริษัทนี้"})})})]},`customer-${e.id}`)):s.jsxs("div",{className:"text-center py-4",children:[s.jsx($,{size:24}),s.jsx("p",{className:"mt-2",children:"ไม่พบข้อมูลลูกค้าหรือคำขอรับบริการที่ตรงกับคำค้นหา"})]})]})]})};export{ye as default};
