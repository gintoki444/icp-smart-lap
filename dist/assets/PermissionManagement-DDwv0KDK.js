import{r as o,j as n,R as x,C as _,F as d,B as N,z as B,D,y as j,g as I}from"./index-DZpC_pHZ.js";import{g as P}from"./menusRequest-Bj_jsQPR.js";import{g as z}from"./rolesRequest-Bh-L4AxF.js";import{C as l}from"./Card-ZCMDsCmS.js";import{D as A}from"./Divider-BV326Lun.js";import"./DefaultPropsProvider-LyYhFUFs.js";const J=()=>{const[g,C]=o.useState([]),[H,p]=o.useState(!1),[R,$]=o.useState([]),[m,f]=o.useState([]),[h,k]=o.useState("");o.useEffect(()=>{b(),S()},[]);const b=async()=>{try{const e=await z();C(e)}catch(e){console.error("Error fetching roles:",e)}},S=async()=>{try{const e=await P();$(y(e))}catch(e){console.error("Error fetching menus:",e)}},v=async e=>{try{const a=await I(e);f(a)}catch(a){console.error("Error fetching role menus:",a)}},w=e=>{const a=e.target.value;k(a),v(a)},u=(e,a)=>{f(t=>{const s=t.findIndex(c=>c.menu_id===e);if(s===-1)return[...t,{role_id:h,menu_id:e,can_view:0,can_create:0,can_edit:0,can_delete:0,[a]:1}];const r=[...t];return r[s]={...r[s],[a]:r[s][a]===1?0:1},console.log("updatedMenus :",r),r})},E=async()=>{if(!h){alert("กรุณาเลือก Role ก่อนบันทึก");return}p(!0);for(const e of m){const{menu_id:a,can_view:t,can_create:s,can_edit:r,can_delete:c}=e;if(t===0&&s===0&&r===0&&c===0)try{await B(h,a)}catch(i){console.error("Error deleting permissions:",i)}else try{await D({role_id:h,menu_id:a,can_view:t,can_create:s,can_edit:r,can_delete:c})}catch(i){j.error(`Error saving permissions: ${i}`,{autoClose:2e3})}}p(!1),j.success("บันทึกสิทธิ์ของ Role สำเร็จ!",{autoClose:3e3})},y=e=>{const a={};e.forEach(s=>a[s.menu_id]={...s,children:[]});const t=[];return e.forEach(s=>{s.parent_id===null?t.push(a[s.menu_id]):a[s.parent_id]&&a[s.parent_id].children.push(a[s.menu_id])}),t};return n.jsx(x,{children:n.jsx(_,{md:12,children:n.jsxs(l,{children:[n.jsx(l.Header,{children:n.jsx("h5",{children:"จัดการเมนู Permission"})}),n.jsxs(l.Body,{children:[n.jsxs(d.Group,{className:"mb-3",children:[n.jsx(d.Label,{children:"เลือก Role"}),n.jsxs(d.Select,{value:h,onChange:w,children:[n.jsx("option",{value:"",children:"-- เลือก Role --"}),g.map(e=>n.jsx("option",{value:e.role_id,children:e.role_name},e.role_id))]})]}),R.map(e=>{const a=m.find(t=>t.menu_id===e.menu_id)||{};return n.jsxs(l,{className:"mb-3 text-dark",children:[n.jsx(l.Header,{style:{cursor:"pointer",fontWeight:"bold",background:"#d1defa",padding:"12px 25px"},children:e.menu_name}),n.jsxs(l.Body,{style:{padding:"15px 25px"},children:[n.jsx(x,{children:n.jsxs(_,{md:12,children:[n.jsxs("p",{className:"text-dark",style:{fontSize:16},children:["สิทธิ์ของเมนู: ",n.jsx("b",{children:e.menu_name})]}),["can_view","can_create","can_edit","can_delete"].map(t=>n.jsx(d.Check,{inline:!0,id:`${e.menu_id}-${t}`,type:"checkbox",label:t.replace("can_","").toUpperCase(),checked:a[t]===1,onChange:()=>u(e.menu_id,t)},`${e.menu_id}-${t}`)),e.children.length>0&&n.jsx(A,{className:"mt-2"})]})}),e.children.length>0&&e.children.map(t=>n.jsxs(x,{className:"mt-3 ms-3",children:[n.jsxs(_,{md:12,children:[n.jsxs("p",{className:"text-dark",style:{fontSize:16},children:["เมนู : ",n.jsx("b",{children:t.menu_name})]}),["can_view","can_create","can_edit","can_delete"].map(s=>{var r;return n.jsx(d.Check,{inline:!0,id:`${t.menu_id}-${s}`,type:"checkbox",label:s.replace("can_","").toUpperCase(),checked:((r=m.find(c=>c.menu_id===t.menu_id))==null?void 0:r[s])===1,onChange:()=>u(t.menu_id,s)},`${t.menu_id}-${s}`)})]}),t.children.length>0&&t.children.map(s=>n.jsxs(_,{md:12,className:"ms-4 mb-2",children:[n.jsx("h6",{children:n.jsx("b",{children:s.menu_name})}),["can_view","can_create","can_edit","can_delete"].map(r=>{var c;return n.jsx(d.Check,{inline:!0,id:`${s.menu_id}-${r}`,type:"checkbox",label:r.replace("can_","").toUpperCase(),checked:((c=m.find(i=>i.menu_id===s.menu_id))==null?void 0:c[r])===1,onChange:()=>u(s.menu_id,r)},`${s.menu_id}-${r}`)})]},`childmenu-${s.menu_id}`))]},`submenu-${t.menu_id}`))]})]},`menu-${e.menu_id}`)}),n.jsx(N,{variant:"primary",onClick:E,children:"บันทึก"})]})]})})})};export{J as default};
