import{u as k,r as d,j as e,R as S,C as o,B as v,y as h}from"./index-Bq0BSIrC.js";import{p as E,a as w}from"./fertilizerFormulasRequest-CtobAFDH.js";import{g as B}from"./baseFertilizersRequest-jsJdYFIk.js";import{T as G}from"./TestItemMultiSelect-C9rZHrAm.js";import{C as p}from"./Card-C7kDYjR9.js";import{A as L}from"./Alert-C8ltoKJ3.js";import{F as r}from"./Form-C1nYDdO8.js";import"./react-select.esm-CGHZA8pU.js";import"./toPropertyKey-KGmwFxs9.js";import"./emotion-element-f0de968e.browser.esm-xSVEHtue.js";import"./setPrototypeOf-DgZC2w_0.js";import"./testItemsRequest-CIY3wZGW.js";import"./CloseButton-DJdHSP0V.js";import"./Transition-DABJrq3x.js";const W=()=>{const x=k(),[i,j]=d.useState({formula_name:"",formula_code:"",base_fertilizer_id:"",formula_description:"",fertilizer_main_id:1,nutrient_ratio:"",is_rice_fertilizer:0,recommended_tests:"",test_item_id:[],fertilizer_type_id:""}),[C,g]=d.useState([]),[a,c]=d.useState({}),[b,_]=d.useState(null),[u,z]=d.useState(!1);d.useEffect(()=>{(async()=>{try{const s=await B();g(s)}catch(s){_("เกิดข้อผิดพลาดในการดึงข้อมูลปุ๋ยพื้นฐาน"),console.error("Error fetching base fertilizers:",s)}})()},[]);const y=()=>{const t={};return i.formula_name.trim()||(t.formula_name="กรุณากรอกชื่อสูตรปุ๋ย"),i.formula_code.trim()||(t.formula_code="กรุณากรอกรหัสสูตรปุ๋ย"),i.base_fertilizer_id||(t.base_fertilizer_id="กรุณาเลือกปุ๋ยพื้นฐาน"),i.formula_description.trim()||(t.formula_description="กรุณากรอกคำอธิบายสูตรปุ๋ย"),i.nutrient_ratio.trim()||(t.nutrient_ratio="กรุณากรอกสัดส่วนธาตุอาหาร"),i.test_item_id.length===0&&(t.test_item_id="กรุณาเลือกรายการทดสอบอย่างน้อย 1 รายการ"),c(t),Object.keys(t).length===0},l=t=>{const{name:s,value:n,type:f,checked:m}=t.target;j({...i,[s]:f==="checkbox"?m?1:0:n}),c({...a,[s]:""})},F=(t,s,n)=>{j({...i,[t]:s,recommended_tests:n.join(", ")}),c({...a,[t]:""})},I=async t=>{if(t.preventDefault(),!!y()){z(!0),_(null);try{const s={...i,fertilizer_main_id:Number(i.fertilizer_main_id),base_fertilizer_id:Number(i.base_fertilizer_id),is_rice_fertilizer:Number(i.is_rice_fertilizer)},n=await E(s);if(n.formula_id){if(h.success("เพิ่มสูตรปุ๋ยสำเร็จ!",{autoClose:3e3}),i.test_item_id.length>0){const f=i.test_item_id.map((m,N)=>({formula_id:n.formula_id,test_item_id:Number(i.test_item_id[N])}));await Promise.all(f.map(m=>{console.log("data:",m),w(m)})),h.success("บันทึกการทดสอบที่เกี่ยวข้องสำเร็จ!",{autoClose:3e3})}x("/admin/fertilizer-formulas")}else throw new Error("No formula_id returned")}catch(s){s.response&&s.response.status===500?h.error("รหัสสูตรปุ๋ยนี้ถูกใช้งานแล้ว กรุณาใช้รหัสอื่น",{autoClose:5e3}):(_("เกิดข้อผิดพลาดในการเพิ่มสูตรปุ๋ย กรุณาลองใหม่"),console.error("Error adding fertilizer formula:",s))}finally{z(!1)}}};return e.jsx("div",{children:e.jsxs(p,{children:[e.jsx(p.Header,{children:e.jsx("h5",{children:"เพิ่มสูตรปุ๋ย"})}),e.jsxs(p.Body,{children:[b&&e.jsx(L,{variant:"danger",children:b}),e.jsxs(r,{onSubmit:I,children:[e.jsxs(S,{children:[e.jsx(o,{md:6,className:"mb-3",children:e.jsxs(r.Group,{controlId:"formula_name",children:[e.jsx(r.Label,{children:"ชื่อสูตรปุ๋ย"}),e.jsx(r.Control,{type:"text",name:"formula_name",value:i.formula_name,placeholder:"กรอกชื่อสูตรปุ๋ย",onChange:l,isInvalid:!!a.formula_name}),e.jsx(r.Control.Feedback,{type:"invalid",children:a.formula_name})]})}),e.jsx(o,{md:6,className:"mb-3",children:e.jsxs(r.Group,{controlId:"formula_code",children:[e.jsx(r.Label,{children:"รหัสสูตรปุ๋ย"}),e.jsx(r.Control,{type:"text",name:"formula_code",value:i.formula_code,placeholder:"กรอกรหัสสูตรปุ๋ย",onChange:l,isInvalid:!!a.formula_code}),e.jsx(r.Control.Feedback,{type:"invalid",children:a.formula_code})]})}),e.jsx(o,{md:6,className:"mb-3",children:e.jsxs(r.Group,{controlId:"base_fertilizer_id",children:[e.jsx(r.Label,{children:"ปุ๋ยพื้นฐาน"}),e.jsxs(r.Select,{name:"base_fertilizer_id",value:i.base_fertilizer_id,style:{padding:"10.5px 22px",fontSize:14},onChange:l,isInvalid:!!a.base_fertilizer_id,children:[e.jsx("option",{value:"",children:"เลือกปุ๋ยพื้นฐาน"}),C.map(t=>e.jsx("option",{value:t.base_fertilizer_id,children:t.common_name_th},t.base_fertilizer_id))]}),e.jsx(r.Control.Feedback,{type:"invalid",children:a.base_fertilizer_id})]})}),e.jsx(o,{md:6,className:"mb-3",children:e.jsxs(r.Group,{controlId:"nutrient_ratio",children:[e.jsx(r.Label,{children:"สัดส่วนธาตุอาหาร"}),e.jsx(r.Control,{type:"text",name:"nutrient_ratio",value:i.nutrient_ratio,placeholder:"กรอกสัดส่วนธาตุอาหาร",onChange:l,isInvalid:!!a.nutrient_ratio}),e.jsx(r.Control.Feedback,{type:"invalid",children:a.nutrient_ratio})]})}),e.jsx(o,{md:6,className:"mb-3",children:e.jsx(G,{name:"test_item_id",value:i.test_item_id,onSelect:F})}),e.jsx(o,{md:6,className:"mb-3",children:e.jsxs(r.Group,{controlId:"recommended_tests",children:[e.jsx(r.Label,{children:"รายการทดสอบที่แนะนำ"}),e.jsx(r.Control,{type:"text",name:"recommended_tests",value:i.recommended_tests,placeholder:"กรอกรายการทดสอบที่แนะนำ",readOnly:!0})]})}),e.jsx(o,{md:12,className:"mb-3",children:e.jsxs(r.Group,{controlId:"formula_description",children:[e.jsx(r.Label,{children:"คำอธิบายสูตรปุ๋ย"}),e.jsx(r.Control,{as:"textarea",rows:3,name:"formula_description",value:i.formula_description,placeholder:"กรอกคำอธิบายสูตรปุ๋ย",onChange:l,isInvalid:!!a.formula_description}),e.jsx(r.Control.Feedback,{type:"invalid",children:a.formula_description})]})}),e.jsx(o,{md:6,className:"mb-3",children:e.jsx(r.Group,{controlId:"is_rice_fertilizer",children:e.jsx(r.Check,{inline:!0,type:"checkbox",label:"เหมาะสำหรับปุ๋ยข้าว",name:"is_rice_fertilizer",checked:i.is_rice_fertilizer===1,onChange:l})})})]}),e.jsx(v,{variant:"primary",type:"submit",disabled:u,children:u?"กำลังบันทึก...":"บันทึก"}),e.jsx(v,{variant:"danger",className:"ms-2",onClick:()=>x("/admin/fertilizer-formulas"),disabled:u,children:"กลับ"})]})]})]})})};export{W as default};
