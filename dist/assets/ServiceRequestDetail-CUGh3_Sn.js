import{r as o,j as e,o as he,B,R as I,C as i,y as P,u as me,h as ue,q as pe,l as xe,a as je,L as fe}from"./index-CMKGjvil.js";import{p as be,d as te,a as _e,b as ge}from"./serviceRequest-CJ15hpJs.js";import{c as ye,a as $,e as M,F as ve}from"./formik.esm-PXS3-tw9.js";import{g as we}from"./packageingTypeRequest-CUTcv2jf.js";import{g as Ne}from"./fertilizerTypesRequest-CzftO6V-.js";import{p as ae,g as Se}from"./sampleSubmissionsRequest-bNYMIj3U.js";import{M as q}from"./Modal-KDP3gSJa.js";import{F as a}from"./Form-XAT3KesX.js";import{u as Ce,e as ke,T as re}from"./TextField-l4tn0KBj.js";import{A as qe,a as Te,E as Be,b as Re}from"./ExpandMore-CBhrzDGN.js";import{S as De}from"./SampleReceivingModal-BmmVNM5Y.js";import{a as Ee}from"./customerRequest-D-QXhSQD.js";import{g as ze}from"./specialConditionsRequest-B-G5iiQh.js";import{g as Fe}from"./fertilizerMainRequest-kGbpd_0A.js";import{C as ne}from"./CountrySelect-5rKmeoAR.js";import{C as z}from"./Card-ltuRbL1m.js";import{B as ie}from"./Badge-Degbu7BZ.js";import{D as Ie,C as Le}from"./DataGrid-BSrFaLwh.js";import{h as Me}from"./uploadFileRequest-j7nqPy1R.js";import{p as Pe,D as Ge,P as Ae,S as He,V as O,T as D,I as $e,F as Oe}from"./react-pdf.browser-5GpL1MH3.js";import{T as We}from"./index-7N6s0NQG.js";import{s as Ue,a as Ye,g as Je,T as Qe,C as Ke,c as Xe}from"./DefaultPropsProvider-7CXMMYWk.js";import{S as le,b as oe,c as ce,e as Ze}from"./trackingRequest-nQukaRQe.js";import"./CloseButton-DXA2z1Sn.js";import"./Transition-CvY6YelV.js";import"./setPrototypeOf-DgZC2w_0.js";import"./emotion-element-f0de968e.browser.esm-D2ySOhvj.js";import"./toPropertyKey-BZFHAmHd.js";import"./firebaseConfig-pMHECxRz.js";import"./FirebaseImage-D-uA0S8P.js";import"./Table-Co_68gz0.js";import"./react-select.esm-Df4SyQAq.js";import"./Divider-Rbts8ePN.js";import"./tslib.es6-RU1n5ZxP.js";function Ve(h={}){const{themeId:y,defaultTheme:c,defaultClassName:j="MuiBox-root",generateClassName:m}=h,d=Ue("div",{shouldForwardProp:N=>N!=="theme"&&N!=="sx"&&N!=="as"})(Ye);return o.forwardRef(function(L,R){const v=Ce(c),{className:t,component:n="div",...p}=ke(L);return e.jsx(d,{as:n,ref:R,className:he(t,m?m(j):j),theme:y&&v[y]||v,...p})})}const es=Je("MuiBox",["root"]),ss=Xe(),ts=Ve({themeId:Qe,defaultTheme:ss,defaultClassName:es.root,generateClassName:Ke.generate}),as=({sampleSubmissions:h,onSubmitReview:y,serviceRequestId:c})=>{const[j,m]=o.useState(!1),[d,T]=o.useState(null),N=ye({is_sample_normal:M().required("กรุณาเลือกสถานะตัวอย่าง"),is_sample_abnormal:M().required("กรุณาเลือกสถานะตัวอย่าง"),sample_abnormal_desc:$().test("abnormal-desc-required","กรุณาระบุเหตุผลที่ตัวอย่างผิดปกติ",function(t){return!this.parent.is_sample_abnormal||t!==void 0&&t.trim()!==""}),is_staff_ready:M().required("กรุณาเลือกสถานะบุคลากร"),is_staff_not_ready:M().required("กรุณาเลือกสถานะบุคลากร"),is_equipment_ready:M().required("กรุณาเลือกสถานะเครื่องมือ"),is_equipment_not_ready:M().required("กรุณาเลือกสถานะเครื่องมือ"),is_job_accepted:M().required("กรุณาเลือกสถานะสรุปความพร้อม"),is_job_rejected:M().required("กรุณาเลือกสถานะสรุปความพร้อม"),has_change_request:M(),change_agreement:$().test("change-agreement-required","กรุณาระบุข้อตกลงการเปลี่ยนแปลง",function(t){return!this.parent.has_change_request||t!==void 0&&t.trim()!==""}),reviewed_by:$().test("reviewed-by-required","กรุณาระบุผู้ทบทวน",function(t){return!this.parent.has_change_request||t!==void 0&&t.trim()!==""}),review_date:$().test("review-date-required","กรุณาระบุวันที่ทบทวน",function(t){return!this.parent.has_change_request||t!==void 0&&t.trim()!==""}),approved_by:$().test("approved-by-required","กรุณาระบุผู้อนุมัติ",function(t){return!this.parent.has_change_request||t!==void 0&&t.trim()!==""}),approved_date:$().test("approved-date-required","กรุณาระบุวันที่อนุมัติ",function(t){return!this.parent.has_change_request||t!==void 0&&t.trim()!==""})}),L={is_sample_normal:!0,is_sample_abnormal:!1,sample_abnormal_desc:"",is_staff_ready:!0,is_staff_not_ready:!1,is_equipment_ready:!0,is_equipment_not_ready:!1,is_job_accepted:!0,is_job_rejected:!1,has_change_request:!1,change_agreement:"",reviewed_by:"",review_date:"",approved_by:"",approved_date:"",verification_status:h.verification_status||"No"},R=async(t,{setSubmitting:n,setErrors:p})=>{try{await N.validate(t,{abortEarly:!1});const f={is_sample_normal:t.is_sample_normal?1:0,is_sample_abnormal:t.is_sample_abnormal?1:0,sample_abnormal_desc:t.sample_abnormal_desc||"",is_staff_ready:t.is_staff_ready?1:0,is_staff_not_ready:t.is_staff_not_ready?1:0,is_equipment_ready:t.is_equipment_ready?1:0,is_equipment_not_ready:t.is_equipment_not_ready?1:0,is_job_accepted:t.is_job_accepted?1:0,is_job_rejected:t.is_job_rejected?1:0};console.log("reviewData",f),console.log("sampleSubmissions.submission_id",h.submission_id);const b=await ae(f,h.submission_id);if(b.message==="อัปเดตข้อมูลตัวอย่างสำเร็จ"){const S=await Se(c),_=S.length;S.reduce((g,w)=>g+(w.verification_status==="Yes"?1:0),0)>=_&&(await be(c,{newStatusTracking:"request_reviewed"}),P.success("สถานะอัปเดต: การทบทวนคำขอเสร็จสิ้น",{autoClose:3e3})),t.is_job_rejected&&(await te(c,{StatusTracking:"request_reviewed"}),P.info("สถานะถูกลบ: การทบทวนคำขอถูกยกเลิก",{autoClose:3e3})),n(!1),m(!1),y(!0),P.success("อัปเดตข้อมูลตัวอย่างสำเร็จ!",{autoClose:3e3})}else P.error(b.message,{autoClose:3e3})}catch(f){if(P.error("Validation error:"+f,{autoClose:3e3}),console.error("Validation error:",f),f.name==="ValidationError"){const b={};f.inner.forEach(S=>{b[S.path]=S.message}),p(b),T("กรุณากรอกข้อมูลให้ครบถ้วน")}else T("เกิดข้อผิดพลาดในการบันทึก");n(!1)}},v=async()=>{if(window.confirm("คุณต้องการยกเลิกการทบทวนคำขอนี้หรือไม่?"))try{const n={is_sample_normal:null,is_sample_abnormal:null,sample_abnormal_desc:null,is_staff_ready:null,is_staff_not_ready:null,is_equipment_ready:null,is_equipment_not_ready:null,is_job_accepted:null,is_job_rejected:null};console.log("reviewData",n),await ae(n,h.submission_id),await te(c,{StatusTracking:"request_reviewed"}),P.success("ยกเลิกการทบทวนสำเร็จ!",{autoClose:3e3}),y(!0),m(!1)}catch(n){P.error("เกิดข้อผิดพลาดในการยกเลิกการทบทวน: "+n,{autoClose:3e3})}};return e.jsxs(e.Fragment,{children:[h.verification_status==="Yes"?e.jsxs(B,{variant:"warning",onClick:()=>m(!0),children:[e.jsx("i",{className:"feather icon-edit"})," ยกเลิก/แก้ไขการทบทวน"]}):e.jsxs(B,{variant:"info",onClick:()=>m(!0),children:[e.jsx("i",{className:"feather icon-eye"})," ทบทวนคำขอ"]}),e.jsxs(q,{show:j,onHide:()=>m(!1),size:"lg",centered:!0,children:[e.jsx(q.Header,{closeButton:!0,children:e.jsx(q.Title,{children:e.jsx("h6",{children:"การทวนคำขอรับบริการ"})})}),e.jsx(ve,{initialValues:L,validationSchema:N,onSubmit:R,children:({values:t,errors:n,touched:p,handleChange:f,handleBlur:b,handleSubmit:S,setFieldValue:_,isSubmitting:x})=>e.jsxs(a,{onSubmit:S,children:[e.jsxs(q.Body,{children:[d&&e.jsx("div",{className:"text-danger mb-3",children:d}),e.jsx("h6",{children:"สถานะการขอรับบริการ"}),e.jsxs(I,{className:"ps-4 pe-4",children:[e.jsx(i,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"สถานะตัวอย่าง"}),e.jsxs("div",{children:[e.jsx(a.Check,{id:"is_sample_normal",inline:!0,type:"radio",name:"is_sample_normal",label:"ปกติ",checked:t.is_sample_normal,onChange:()=>{_("is_sample_normal",!0),_("is_sample_abnormal",!1),_("sample_abnormal_desc","")},isInvalid:p.is_sample_normal&&!!n.is_sample_normal}),e.jsx(a.Check,{id:"is_sample_abnormal",inline:!0,type:"radio",name:"is_sample_abnormal",label:"ผิดปกติ",checked:t.is_sample_abnormal,onChange:()=>{_("is_sample_normal",!1),_("is_sample_abnormal",!0)},isInvalid:p.is_sample_abnormal&&!!n.is_sample_abnormal}),t.is_sample_abnormal&&e.jsx(a.Control,{className:"mt-2",as:"textarea",name:"sample_abnormal_desc",placeholder:"ระบุเหตุผลที่ผิดปกติ",value:t.sample_abnormal_desc,onChange:f,onBlur:b,isInvalid:p.sample_abnormal_desc&&!!n.sample_abnormal_desc})]}),e.jsx(a.Control.Feedback,{type:"invalid",children:n.sample_abnormal_desc||n.is_sample_normal})]})}),e.jsx(i,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"สถานะบุคลากร"}),e.jsxs("div",{children:[e.jsx(a.Check,{id:"is_staff_ready",inline:!0,type:"radio",name:"is_staff_ready",label:"พร้อมปฏิบัติงาน",checked:t.is_staff_ready,onChange:()=>{_("is_staff_ready",!0),_("is_staff_not_ready",!1)},isInvalid:p.is_staff_ready&&!!n.is_staff_ready}),e.jsx(a.Check,{id:"is_staff_not_ready",inline:!0,type:"radio",name:"is_staff_not_ready",label:"ไม่พร้อมปฏิบัติงาน",checked:t.is_staff_not_ready,onChange:()=>{_("is_staff_ready",!1),_("is_staff_not_ready",!0)},isInvalid:p.is_staff_not_ready&&!!n.is_staff_not_ready})]}),e.jsx(a.Control.Feedback,{type:"invalid",children:n.is_staff_ready})]})}),e.jsx(i,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"สถานะเครื่องมือ"}),e.jsxs("div",{children:[e.jsx(a.Check,{id:"is_equipment_ready",inline:!0,type:"radio",name:"is_equipment_ready",label:"พร้อมใช้งาน",checked:t.is_equipment_ready,onChange:()=>{_("is_equipment_ready",!0),_("is_equipment_not_ready",!1)},isInvalid:p.is_equipment_ready&&!!n.is_equipment_ready}),e.jsx(a.Check,{id:"is_equipment_not_ready",inline:!0,type:"radio",name:"is_equipment_not_ready",label:"ไม่พร้อมใช้งาน",checked:t.is_equipment_not_ready,onChange:()=>{_("is_equipment_ready",!1),_("is_equipment_not_ready",!0)},isInvalid:p.is_equipment_not_ready&&!!n.is_equipment_not_ready})]}),e.jsx(a.Control.Feedback,{type:"invalid",children:n.is_equipment_ready})]})}),e.jsx(i,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"สรุปความพร้อม"}),e.jsxs("div",{children:[e.jsx(a.Check,{id:"is_job_accepted",inline:!0,type:"radio",name:"is_job_accepted",label:"รับงาน",checked:t.is_job_accepted,onChange:()=>{_("is_job_accepted",!0),_("is_job_rejected",!1)},isInvalid:p.is_job_accepted&&!!n.is_job_accepted}),e.jsx(a.Check,{id:"is_job_rejected",inline:!0,type:"radio",name:"is_job_rejected",label:"ไม่รับงาน",checked:t.is_job_rejected,onChange:()=>{_("is_job_accepted",!1),_("is_job_rejected",!0)},isInvalid:p.is_job_rejected&&!!n.is_job_rejected})]}),e.jsx(a.Control.Feedback,{type:"invalid",children:n.is_job_accepted})]})})]}),e.jsx("h6",{children:"เปลี่ยนแปลงคำขอ"}),e.jsxs(I,{className:"ps-4 pe-4",children:[e.jsx(i,{md:12,children:e.jsx(a.Group,{children:e.jsx(a.Check,{id:"has_change_request",type:"checkbox",name:"has_change_request",label:"กรณีเปลี่ยนแปลงคำขอ?",checked:t.has_change_request,onChange:g=>_("has_change_request",g.target.checked)})})}),t.has_change_request&&e.jsx(i,{md:12,children:e.jsxs(I,{children:[e.jsxs(i,{md:12,className:"mb-3",children:[e.jsx(a.Control,{className:"mt-2",as:"textarea",name:"change_agreement",placeholder:"ระบุข้อตกลงการเปลี่ยนแปลง",value:t.change_agreement,onChange:f,onBlur:b,isInvalid:p.change_agreement&&!!n.change_agreement}),e.jsx(a.Control.Feedback,{type:"invalid",children:n.change_agreement})]}),e.jsx(i,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"ผู้ทบทวน"}),e.jsx(a.Control,{type:"text",name:"reviewed_by",placeholder:"ระบุผู้ทบทวน",value:t.reviewed_by,onChange:f,onBlur:b,isInvalid:p.reviewed_by&&!!n.reviewed_by}),e.jsx(a.Control.Feedback,{type:"invalid",children:n.reviewed_by})]})}),e.jsx(i,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"วันที่ทบทวน"}),e.jsx(re,{fullWidth:!0,type:"date",name:"review_date",value:t.review_date,onChange:f,onBlur:b,error:p.review_date&&!!n.review_date,helperText:p.review_date&&n.review_date})]})}),e.jsx(i,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"ผู้อนุมัติ"}),e.jsx(a.Control,{type:"text",name:"approved_by",placeholder:"ระบุผู้อนุมัติ",value:t.approved_by,onChange:f,onBlur:b,isInvalid:p.approved_by&&!!n.approved_by}),e.jsx(a.Control.Feedback,{type:"invalid",children:n.approved_by})]})}),e.jsx(i,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"วันที่อนุมัติ"}),e.jsx(re,{fullWidth:!0,type:"date",name:"approved_date",value:t.approved_date,onChange:f,onBlur:b,error:p.approved_date&&!!n.approved_date,helperText:p.approved_date&&n.approved_date})]})})]})})]})]}),e.jsxs(q.Footer,{className:"justify-content-center",children:[h.verification_status==="Yes"&&e.jsx(B,{variant:"danger",onClick:v,disabled:x,children:"ยกเลิกการทบทวน"}),e.jsx(B,{variant:"secondary",onClick:()=>m(!1),disabled:x,children:"ปิด"}),e.jsx(B,{variant:"primary",type:"submit",disabled:x,children:"บันทึกการทบทวน"})]})]})})]})]})},de=({serviceId:h,handleReload:y,handleSetCustomer:c})=>{me();const[j,m]=o.useState([]),[d,T]=o.useState(!1),[N,L]=o.useState([]),[R,v]=o.useState({}),[t,n]=o.useState({}),[p,f]=o.useState([]),[b,S]=o.useState({}),[_,x]=o.useState([]),[g,w]=o.useState([]);o.useEffect(()=>{const s=localStorage.getItem("authToken");s&&ue(s).then(r=>{m(r.user)}),h&&A(h),E()},[h,d]);const A=async s=>{const r=await _e(s),l=await ge(s);r&&(await H(r.customer_id),await G(r.customer_id),r.sample_submissions=r.sample_submissions.map(u=>({...u,reportMethod:[u.is_self_pickup?"is_self_pickup":null,u.pdf_email?"pdf_email":null,u.is_mail_delivery?"is_mail_delivery":null].filter(Boolean)})),S(r),x(r.sample_submissions),L(l))},H=async s=>{try{const r=await ze(s);v(Array.isArray(r)?r:[])}catch(r){console.error(r),v([])}},E=async()=>{try{const r=(await Fe()).map(l=>({value:l.fertilizer_main_id,label:l.fertilizer_main_name_th}));console.log("formattedOptions",r),w(r)}catch(s){console.error("Error fetching fertilizer formulas:",s),w([])}},G=async s=>{try{const r=await Ee(s);n(r),c(r)}catch(r){console.error(r)}};o.useEffect(()=>{X(),Y()},[]);const X=async()=>{const s=await we();f(s)},[U,Z]=o.useState([]),Y=async()=>{try{const s=await Ne();Z(s)}catch(s){console.log(s)}},J=[{field:"no",headerName:"#",width:90,headerAlign:"center",align:"center"},{field:"test_code",headerName:"ทดสอบ",flex:1,renderCell:s=>{if(!s||!s.row)return"-";const{test_code:r,test_percentage:l}=s.row;return`${r||""}${l?` (${l})`:""}`.trim()}},{field:"status",headerName:"สถานะ",headerAlign:"center",align:"center",flex:1,renderCell:s=>e.jsx(ie,{pill:!0,bg:s.row.status==="pending"?"warning":s.row.status==="rejected"?"danger":"success",children:s.row.status==="pending"?"รออนุมัติ":s.row.status==="rejected"?"ไม่อนุมัติ":"อนุมัติ"})},{field:"test_value",headerName:"ผลที่ได้",flex:1,renderCell:s=>{var r;return((r=s==null?void 0:s.row)==null?void 0:r.test_value)||"-"}},{field:"test_date",headerName:"วันที่ทดสอบ",flex:1,valueGetter:s=>{var r;return((r=s==null?void 0:s.row)==null?void 0:r.created_at)||"-"}}],W=s=>s.map((l,u)=>({id:l.detail_id,no:u+1,...l})),Q=[{value:"g",label:"กรัม"},{value:"kg",label:"กิโลกรัม"},{value:"oz",label:"ออนซ์"},{value:"ml",label:"มิลลิลิตร"},{value:"L",label:"ลิตร"}],V=[{value:"is_self_pickup",label:"รับด้วยตนเอง"},{value:"pdf_email",label:"ต้องการไฟล์ pdf เพิ่มเติมทาง E-mail"},{value:"is_mail_delivery",label:"ส่งทางไปรษณีย์"}],ee=s=>s.map(r=>{var l;return((l=V.find(u=>u.value===r))==null?void 0:l.label)||r}).join(", ");return e.jsx("div",{children:e.jsx(z,{style:{borderRadius:10,marginBottom:0},children:e.jsxs(z.Body,{style:{paddingBottom:20,paddingTop:20},children:[e.jsxs(I,{children:[b.request_no&&e.jsx(i,{md:12,children:e.jsxs("h5",{className:"mb-4",children:["เลขที่คำขอบริการ : ",e.jsx("span",{style:{fontSize:18},children:b.request_no})]})}),e.jsx(i,{md:12,children:e.jsx("h6",{className:"mb-3",children:"ข้อมูลผู้ขอขึ้นทะเบียน"})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ชื่อบริษัท : ",e.jsx("strong",{className:"text-dark",children:t.company_name})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["เลขที่ผู้เสียภาษี : ",e.jsx("strong",{className:"text-dark",children:t.tax_id})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ที่อยู่ : ",e.jsx("strong",{className:"text-dark",children:t.company_address})]})}),e.jsx(i,{md:6,children:e.jsxs("p",{className:"mb-0",children:["เงื่อนไขพิเศษ :"," ",e.jsx("strong",{className:"text-dark",children:R.length>0?R.map((s,r)=>`${s.description}${r<R.length-1?", ":""}`):"-"})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ประเภทคำขอ : ",e.jsx("strong",{className:"text-dark",children:b.sample_type_name})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["คำขอเพิ่มเติม : ",e.jsx("strong",{className:"text-dark",children:b.notes})]})})]}),e.jsx("h6",{className:"mt-3 mb-2",children:"ข้อมูลตัวอย่างปุ๋ย"}),_.map((s,r)=>{var l,u,C,K;return e.jsx(e.Fragment,{children:e.jsxs(e.Fragment,{children:[e.jsx(I,{children:e.jsxs(i,{md:12,className:"ms-2 ps-0 pe-0",style:{border:"1px solid #f8f9fa"},children:[e.jsxs(qe,{className:"mb-0",sx:{boxShadow:"none"},children:[e.jsx(Te,{expandIcon:e.jsx(Be,{}),"aria-controls":`panel${r}-content`,id:`panel${r}-header`,sx:{backgroundColor:"#f8f9fa",borderRadius:0},children:e.jsxs("p",{className:"mb-0",children:["ตัวอย่างที่ ",r+1," ",s.submission_no&&e.jsxs(e.Fragment,{children:["เลขที่ :"," ",e.jsx("strong",{className:"text-dark",style:{fontWeight:"bold"},children:s.submission_no||"-"})," "]}),"สูตรปุ๋ย : ",e.jsx("strong",{className:"text-dark",children:s.fertilizer_formula||"-"})," ( ชื่อสามัญ :"," ",e.jsx("strong",{className:"text-dark",style:{fontWeight:"bold"},children:s.common_name||"-"}),") สถานะ :",e.jsx(ie,{pill:!0,bg:s.verification_status==="No"&&s.is_job_accepted||s.verification_status==="No"&&!s.is_job_accepted||s.verification_status==="Yes"&&!s.is_job_accepted?"warning":s.verification_status==="Yes"&&s.is_job_accepted?"success":"danger",style:{marginLeft:12},children:s.verification_status==="No"&&s.is_job_accepted||s.verification_status==="No"&&!s.is_job_accepted||s.verification_status==="Yes"&&!s.is_job_accepted?"รอการตรวจสอบ":s.verification_status==="Yes"&&s.is_job_accepted?"รับงาน":" ไม่อนุมัติ"})]})}),e.jsx(Re,{className:"pb-0",children:e.jsxs(I,{children:[s.fertilizer_main_id&&e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ประเภทของปุ๋ย :"," ",e.jsx("strong",{className:"text-dark",children:(l=g.find(k=>k.value===s.fertilizer_main_id))==null?void 0:l.label})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ลักษณะปุ๋ย :"," ",e.jsx("strong",{className:"text-dark",children:((u=U.find(k=>k.fertilizer_type_id===s.fertilizer_type_id))==null?void 0:u.fertilizer_type_name)||"-"})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["สี : ",e.jsx("strong",{className:"text-dark",children:s.color||"-"})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ภาชนะบรรจุ :"," ",e.jsx("strong",{className:"text-dark",children:((C=p.find(k=>k.packaging_type_id===s.packaging_id))==null?void 0:C.packaging_type_name)||"-"})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ชื่อการค้า : ",e.jsx("strong",{className:"text-dark",children:s.trade_name||"-"})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ผู้ผลิต (บริษัท/ห้าง/ร้าน) : ",e.jsx("strong",{className:"text-dark",children:s.manufacturer||"-"}),"ประเทศ :"," ",e.jsx(ne,{name:"country",label:"ประเทศ",value:s.manufacturer_country||"-",onChange:(k,se)=>console.log(k,se),showText:!0})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["สั่งจาก (บริษัท/ห้าง/ร้าน) : ",e.jsx("strong",{className:"text-dark",children:s.supplier||"-"}),"ประเทศ :"," ",e.jsx(ne,{name:"country",label:"ประเทศ",value:s.supplier_country||"-",onChange:(k,se)=>console.log(k,se),showText:!0})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ปริมาณ : ",e.jsx("strong",{className:"text-dark",children:s.sample_weight||"-"})," ",e.jsx("strong",{className:"text-dark",children:((K=Q.find(k=>k.value===s.sample_weight_unit))==null?void 0:K.label)||"-"})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["วัตถุส่วนประกอบของปุ๋ย : ",e.jsx("strong",{className:"text-dark",children:s.composition||"-"})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ผู้ส่งตัวอย่าง : ",e.jsx("strong",{className:"text-dark",children:s.submitted_by||"-"})]})}),e.jsx(i,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["เบอร์โทรศัพท์ผู้ส่ง : ",e.jsx("strong",{className:"text-dark",children:s.phone||"-"})]})}),e.jsx(i,{md:6,className:"mb-3",children:e.jsxs("p",{className:"mb-0",children:["วันที่ส่ง :"," ",e.jsx("strong",{className:"text-dark",children:new Date(s.submission_date).toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"})||"-"})]})}),e.jsxs(i,{md:12,className:"mb-3",children:[e.jsx("h6",{className:"mb-3",children:"ข้อมูลการขอรับผลการตรวจ"}),e.jsxs("p",{className:"mb-1",children:["วิธีการรับรายงาน : ",e.jsx("strong",{className:"text-dark",children:ee(s.reportMethod)})]}),s.reportMethod.includes("pdf_email")&&e.jsxs("p",{className:"mb-1",children:["E-mail สำหรับรับผลตรวจ : ",e.jsx("strong",{className:"text-dark",children:s.pdf_email||"-"})]}),s.reportMethod.includes("is_mail_delivery")&&e.jsxs("p",{className:"mb-1",children:["ที่อยู่จัดส่ง : ",e.jsx("strong",{className:"text-dark",children:s.mail_delivery_location||"-"})]})]}),e.jsxs(i,{md:12,className:"mb-2",children:[e.jsx("h6",{className:"mb-3",children:"รายการทดสอบ"}),e.jsx("div",{style:{width:"100%"},children:e.jsx(Ie,{rows:W(s.sample_submission_details),columns:J,pageSize:5,rowsPerPageOptions:[5,10,20],pagination:!0,disableSelectionOnClick:!0,hideFooterSelectedRowCount:!0})})]})]})})]}),e.jsx(i,{style:{padding:"0px 16px "},children:e.jsx(De,{serviceData:b,submissionId:s.submission_id,handleTracking:y,trackingData:s.sample_tracking,reviewBy:j.user_id,sampleNo:s.submission_no,reloadData:d,sampleStatus:N.sample_submissions.find(k=>k.submission_id===s.submission_id),serviceRequestId:b.request_id})}),e.jsx(i,{style:{padding:"0px 16px 16px"},children:e.jsx(as,{sampleSubmissions:s,onSubmitReview:y,serviceRequestId:b.request_id})})]})},`Accordion-${r}`),r<_.length-1&&e.jsx("hr",{className:"mt-4 mb-2"})]})})})]})})})},rs="https://apiav2-jlp2nagalq-as.a.run.app/api",ns=async h=>{const y=new Headers;y.append("Content-Type","application/json");const c=JSON.stringify(h),j={method:"POST",headers:y,body:c,redirect:"follow"};try{const m=await fetch(`${rs}/send-email-file`,j);if(!m.ok){const d=await m.json();throw new Error(d.message||`HTTP Error: ${m.status}`)}return await m.json()}catch(m){throw console.error("Save customer special conditions Error:",m),m}},is=({buttonTitle:h="ส่งอีเมล",icon:y,serviceData:c})=>{const[j,m]=o.useState(!1);console.log("serviceData:",c);const[d,T]=o.useState({toEmail:c.sr_pdf_email,subject:"",message:"",username:c.customer_name,files:null}),[N,L]=o.useState(!1),[R,v]=o.useState(null),[t,n]=o.useState(!1);o.useEffect(()=>{(async()=>{try{const x=localStorage.getItem("authToken");if(console.log("token:",x),x){const g=await pe(c.user_id);console.log("response:",g),g&&g.user_id?T(w=>({...w,username:g.first_name+" "+g.last_name})):v("ไม่สามารถดึงข้อมูลผู้ใช้ได้")}else v("กรุณาเข้าสู่ระบบก่อนส่งอีเมล")}catch(x){v("เกิดข้อผิดพลาดในการตรวจสอบผู้ใช้: "+x.message)}})()},[]);const p=_=>{const{name:x,value:g}=_.target;T(w=>({...w,[x]:g}))},f=_=>{const x=_.target.files;if(x&&x.length>0){for(let w=0;w<x.length;w++)if(x[w].size>10485760){v("ไฟล์ขนาดเกิน 10MB ไม่สามารถอัปโหลดได้");return}}T(g=>({...g,files:x}))},b=()=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d.toEmail)?d.subject.trim()?d.message.trim()?d.username?!0:(v("ไม่พบข้อมูลผู้ใช้ กรุณาเข้าสู่ระบบ"),!1):(v("กรุณากรอกรายละเอียด"),!1):(v("กรุณากรอกหัวข้อ"),!1):(v("กรุณากรอกอีเมลให้ถูกต้อง"),!1),S=async _=>{if(_.preventDefault(),n(!0),v(null),!!b()){L(!0);try{let x=[];if(d.files&&d.files.length>0){const H=Array.from(d.files),E=await Me(H,"email-attachments",`${d.username}-${Date.now()}`);if(!E||E.length===0)throw new Error("การอัปโหลดไฟล์ล้มเหลว");console.log("uploadResults:",E),x=E.map(G=>G.fileName)}const g={toEmail:d.toEmail,subject:d.subject,message:d.message,username:d.username,filePath:x.length>0?x[0]:null};console.log("Email Data to Send:",g);const w=localStorage.getItem("authToken");if(!w)throw new Error("ไม่พบ token กรุณาเข้าสู่ระบบ");const A=await ns(g,w);P.success(A.message),console.log("postSendEmail:",A),T({toEmail:"",subject:"",message:"",username:d.username,files:null}),m(!1),n(!1)}catch{P.error(response.message||"เกิดข้อผิดพลาดในการส่งอีเมล")}finally{L(!1)}}};return e.jsxs(e.Fragment,{children:[e.jsxs(B,{variant:"primary",onClick:()=>m(!0),disabled:!d.username||N,children:[y&&y,h]}),e.jsxs(q,{show:j,onHide:()=>m(!1),size:"lg",centered:!0,children:[e.jsx(q.Header,{closeButton:!0,children:e.jsx("h5",{className:"mb-0",children:h})}),e.jsx(q.Body,{children:e.jsx(z,{children:e.jsx(z.Body,{children:e.jsxs(a,{noValidate:!0,validated:t,onSubmit:S,children:[e.jsx(I,{children:e.jsx(i,{md:12,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"อีเมลผู้รับ"}),e.jsx(a.Control,{type:"email",name:"toEmail",value:d.toEmail,onChange:p,placeholder:"เช่น email@gmail.com",required:!0,isInvalid:t&&!d.toEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)}),e.jsx(a.Control.Feedback,{type:"invalid",children:"กรุณากรอกอีเมลให้ถูกต้อง"})]})})}),e.jsx(I,{children:e.jsx(i,{md:12,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"หัวข้อ"}),e.jsx(a.Control,{type:"text",name:"subject",value:d.subject,onChange:p,placeholder:"หัวข้ออีเมล",required:!0,isInvalid:t&&!d.subject.trim()}),e.jsx(a.Control.Feedback,{type:"invalid",children:"กรุณากรอกหัวข้อ"})]})})}),e.jsx(I,{children:e.jsx(i,{md:12,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"รายละเอียด"}),e.jsx(a.Control,{as:"textarea",rows:4,name:"message",value:d.message,onChange:p,placeholder:"พิมพ์ข้อความของคุณที่นี่",required:!0,isInvalid:t&&!d.message.trim()}),e.jsx(a.Control.Feedback,{type:"invalid",children:"กรุณากรอกรายละเอียด"})]})})}),e.jsx(I,{children:e.jsx(i,{md:12,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"แนบไฟล์หรือรูปภาพ"}),e.jsx(a.Control,{type:"file",multiple:!0,onChange:f,accept:".pdf,.jpg,.jpeg,.png"}),e.jsx(a.Text,{className:"text-muted",children:"รองรับไฟล์ PDF และรูปภาพ (JPG, PNG) ขนาดไม่เกิน 10MB"})]})})}),R&&e.jsx("div",{className:"alert alert-danger",role:"alert",children:R})]})})})}),e.jsxs(q.Footer,{children:[e.jsx(B,{variant:"secondary",onClick:()=>m(!1),disabled:N,children:"ปิด"}),e.jsx(B,{variant:"primary",onClick:S,disabled:N,children:N?"กำลังส่ง...":"ส่งอีเมล"})]})]})]})};Oe.register({family:"THSarabunNew",fonts:[{src:"/assets/fonts/THSarabunNew.ttf"},{src:"/assets/fonts/THSarabunNew-Bold.ttf",fontWeight:"bold"}]});const F=He.create({page:{padding:"10px 30px",fontFamily:"THSarabunNew",fontSize:14},headerContainer:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",marginBottom:10},logo:{width:60,height:60},title:{fontSize:20,fontWeight:"bold"},formCode:{fontSize:12},section:{marginBottom:10},sectionTitle:{fontSize:14,fontWeight:"bold",marginBottom:5},textRow:{flexDirection:"row",marginBottom:5},value:{flex:1},checkboxRow:{flexDirection:"row",flexWrap:"wrap"},checkboxItem:{width:"50%",marginBottom:5}}),ls=({serviceData:h,submissionIndex:y,totalSubmissions:c})=>e.jsxs(O,{style:F.headerContainer,children:[e.jsx(O,{style:{width:"10%"},children:e.jsx($e,{src:xe,style:F.logo})}),e.jsx(D,{style:F.title,children:h.sample_type_id?"แบบฟอร์มนำส่งตัวอย่างปุ๋ยอินทรีย์":"แบบฟอร์มนำส่งตัวอย่างปุ๋ยเคมี เพื่อขึ้นทะเบียนปุ๋ย"}),e.jsxs(D,{style:[F.formCode,{width:"10%"}],children:["FM-LB-46 Rev.07 (01/12/23) P ",y+1,"/",c]})]}),os=({serviceData:h,submission:y,customerData:c,submissionIndex:j,totalSubmissions:m})=>e.jsxs(Ae,{size:"A4",style:F.page,children:[e.jsx(ls,{serviceData:h,submissionIndex:j,totalSubmissions:m}),e.jsxs(O,{style:F.section,children:[e.jsx(D,{style:F.sectionTitle,children:"ข้อมูลผู้ขอขึ้นทะเบียน"}),e.jsxs(O,{style:F.textRow,children:[e.jsx(D,{style:{width:100},children:"รหัสลูกค้า : "}),e.jsx(D,{children:c.company_code||"000"}),e.jsxs(D,{style:{marginLeft:10},children:["ชื่อลูกค้า : ",c.company_name]})]}),h.sample_type_id===1&&e.jsxs(O,{style:{},children:[e.jsx(D,{style:{width:100,fontWeight:"bold"},children:"วัตถุประสงค์การขอรับบริการ : "}),e.jsx(D,{children:h.is_quality_check_analysis===1?"วิเคราะห์เพื่อตรวจสอบคุณภาพ":"วิเคราะห์ขึ้นทะเบียน"})]}),e.jsx(D,{style:F.sectionTitle,children:"ข้อมูลตัวอย่าง"}),e.jsx(O,{style:F.textRow,children:e.jsx(D,{style:{width:100,fontWeight:"bold"},children:"ประเภทของปุ๋ย : "})}),e.jsx(D,{children:"วัตถุประสงค์การขอรับบริการ:"})]})]}),cs=({serviceData:h,customerData:y})=>{const c=h.sample_submissions||[];return e.jsx(Ge,{children:c.map((j,m)=>e.jsx(os,{serviceData:h,submission:j,customerData:y,submissionIndex:m,totalSubmissions:c.length},j.submission_id||m))})},ds=({serviceData:h,customerData:y})=>{const[c,j]=o.useState(!1),m=async()=>{const d=await Pe(e.jsx(cs,{serviceData:h,customerData:y})).toBlob(),T=URL.createObjectURL(d);window.open(T),j(!1)};return e.jsxs(e.Fragment,{children:[e.jsxs(B,{variant:"primary",onClick:()=>j(!0),disabled:!h,children:[e.jsx(We,{className:"me-2"})," สร้างฟอร์มนำส่ง"]}),e.jsxs(q,{show:c,onHide:()=>j(!1),size:"lg",centered:!0,children:[e.jsx(q.Header,{closeButton:!0,children:e.jsx("h6",{children:"ตัวอย่างฟอร์มนำส่งตัวอย่างปุ๋ยอินทรีย์"})}),e.jsx(q.Body,{children:e.jsx("p",{children:'คลิก "สร้าง PDF" เพื่อดูตัวอย่างฟอร์มที่สร้างจากข้อมูลปัจจุบัน'})}),e.jsxs(q.Footer,{children:[e.jsx(B,{variant:"primary",onClick:m,children:"สร้าง PDF"}),e.jsx(B,{variant:"secondary",onClick:()=>j(!1),children:"ปิด"})]})]})]})},ms=({title:h})=>{var r;const c=((r=je().state)==null?void 0:r.id)||null,j=me(),[m,d]=o.useState(1),[T,N]=o.useState(!1),[L,R]=o.useState(!1),[v,t]=o.useState(!1),[n,p]=o.useState(!1),[f,b]=o.useState("horizontal"),[S,_]=o.useState(0),[x,g]=o.useState(!0),[w,A]=o.useState(0),H=()=>{A(l=>{const u=l+1;return g(u>0),u})},E=()=>{A(l=>{const u=Math.max(l-1,0);return g(u>0),u})};o.useEffect(()=>{const l=()=>{window.innerWidth<=768?b("vertical"):b("horizontal")};return l(),window.addEventListener("resize",l),()=>window.removeEventListener("resize",l)},[]),o.useEffect(()=>{console.log("request id :",c),c?Y(c):(j("/admin/request"),g(!1))},[c,j]);const[G,X]=o.useState({}),[U,Z]=o.useState([]),Y=async l=>{try{H();const u=await _e(l);console.log("response",u),Z(u.sample_submissions||[]),X(u)}catch(u){console.error("Error fetching service request:",u),j("/admin/request")}finally{E()}},J=l=>{l&&Y(c)},W=[{label:"การขอรับบริการ",status:"requested"},{label:"ลูกค้าส่งตัวอย่าง",status:"sample_sent"},{label:"ทบทวนคำขอ",status:"request_reviewed"},{label:"ตัวอย่างจัดส่งถึงแล็บ",status:"sample_arrived_lab"},{label:"รับตัวอย่างเข้าระบบ",status:"sample_received"},{label:"รอทดสอบบางรายการ",status:"partial_testing"},{label:"ออกใบเสนอราคา",status:"quotation_issued"},{label:"ขอใบแจ้งหนี้",status:"invoice_requested"},{label:"รับชำระเงิน",status:"payment_received"},{label:"หัก ณ ที่จ่าย",status:"tax_withheld"},{label:"ออกใบเสร็จรับเงิน/ใบกำกับภาษี",status:"receipt_issued"}],Q=(l,u,C)=>{const K=u.length;switch(W[l].status,l){case 0:return C.requested!==null;case 1:return K===0?!1:C.sample_sent!==null;case 2:return C.request_reviewed!==null;case 3:return C.sample_arrived_lab!==null;case 4:return C.sample_received!==null;case 5:return C.partial_testing!==null;case 6:return C.quotation_issued!==null;case 7:return C.invoice_requested!==null;case 8:return C.payment_received!==null;case 9:return C.tax_withheld!==null;case 10:return C.receipt_issued!==null;default:return!1}},[V,ee]=o.useState({}),s=async l=>{console.log("handleSetCustomer data",l),ee(l)};return e.jsx("div",{children:x?e.jsx(ts,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh"},children:e.jsx(Le,{size:60})}):e.jsxs(z,{children:[e.jsx(z.Header,{children:e.jsx("h5",{children:h})}),e.jsx(z.Body,{children:e.jsx("div",{children:f==="vertical"?e.jsx(le,{activeStep:S,orientation:f,alternativeLabel:f==="horizontal",sx:{width:"100%",margin:"0 auto",padding:"20px 0"},children:W.map((l,u)=>e.jsxs(oe,{completed:Q(u,U,G.service_status_logs||{}),children:[e.jsx(ce,{children:l.label}),f==="vertical"&&e.jsx(Ze,{children:e.jsx(de,{serviceId:c,handleReload:J,startLoading:H,stopLoading:E,handleSetCustomer:s})})]},u))}):e.jsxs(e.Fragment,{children:[e.jsx(z,{style:{borderRadius:10,marginBottom:10},children:e.jsx(z.Body,{style:{padding:"8px 20px 3px"},children:e.jsx(le,{activeStep:S,orientation:f,alternativeLabel:f==="horizontal",sx:{width:"100%",margin:"0 auto",padding:"20px 0"},children:W.map((l,u)=>e.jsx(oe,{completed:Q(u,U,G.service_status_logs||{}),children:e.jsx(ce,{children:l.label})},u))})})}),e.jsx(de,{serviceId:c,handleReload:J,startLoading:H,stopLoading:E,handleSetCustomer:s})]})})}),e.jsxs(z.Footer,{className:"text-start",children:[e.jsx(is,{buttonTitle:"แจ้งแก้ไขข้อมูล",icon:e.jsx(fe,{style:{marginRight:8}}),serviceData:G}),e.jsx(ds,{serviceData:G,customerData:V}),e.jsxs(B,{variant:"danger",onClick:()=>j("/admin/request/"),children:[e.jsx("i",{className:"feather icon-corner-up-left"}),"กลับหน้าหลัก"]})]})]})})},Us=()=>e.jsx(ms,{title:"รายละเอียดข้อมูลการคำขอรับบริการ"});export{Us as default};
