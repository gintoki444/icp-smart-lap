import{r as j,u as me,h as de,y as u,j as e,R as p,C as i,B as y,w as X,aF as re}from"./index-6YeC_AS5.js";import{F as pe,c as Y,f as he,g as v,a as d}from"./formik.esm-C0GtiMNK.js";import{u as xe}from"./index-DRJWWvqM.js";import{p as je,b as _e,c as ue}from"./customerRequest-D-QXhSQD.js";import{a as ye,p as fe}from"./specialConditionsRequest-B-G5iiQh.js";import{F as be}from"./index-aza96_6a.js";import{h as Ce}from"./uploadFileRequest-j7nqPy1R.js";import{S as ge}from"./SpecialConditionSelect-BeFOEimW.js";import{C as f}from"./Card-BhOVTKNa.js";import{F as s}from"./Form-CGCyrcfL.js";import"./tslib.es6-RU1n5ZxP.js";import"./firebaseConfig-pMHECxRz.js";import"./react-select.esm-jYPj7h1v.js";import"./toPropertyKey-CTo9CRTC.js";import"./emotion-element-f0de968e.browser.esm-C-W82wov.js";import"./setPrototypeOf-DgZC2w_0.js";function Ae(){const[Z,ee]=j.useState({}),[Ne,ae]=j.useState([]),[b,F]=j.useState([]),k=me();j.useEffect(()=>{const n=localStorage.getItem("authToken");n&&de(n).then(a=>{ee(a.user||{})})},[]),j.useEffect(()=>{se()},[]);const se=()=>{ye().then(n=>{n&&ae(n)})},ne={company_code:"C",company_name:"",company_address:"",document_address:"",tax_id:"",email:"",phone:"",condition_id:[],special_conditions:"",contacts:[{contact_name:"",contact_phone:"",contact_email:"",position:""}],files:[]},S=()=>Y({company_name:d().required("กรุณากรอกชื่อบริษัท"),tax_id:d().matches(/^[0-9]{10,13}$/,"เลขที่ผู้เสียภาษีต้องมี 10 ถึง 13 หลัก").required("กรุณากรอกเลขที่ผู้เสียภาษี"),company_address:d().required("กรุณากรอกที่อยู่บริษัท"),document_address:d().min(3,"ที่อยู่จัดส่งเอกสารต้องมีอย่างน้อย 3 ตัวอักษร").required("กรุณากรอกที่อยู่จัดส่งเอกสาร"),email:d().email("รูปแบบอีเมล์ไม่ถูกต้อง").required("กรุณากรอกอีเมล์"),phone:d().matches(/^[0-9]{10}$/,"กรุณากรอกเบอร์โทรศัพท์ให้ถูกต้อง (10 หลัก)").required("กรุณากรอกเบอร์โทรศัพท์"),condition_id:v().min(1,"กรุณาเลือกเงื่อนไขพิเศษอย่างน้อย 1 รายการ").required("กรุณาเลือกเงื่อนไขพิเศษ"),contacts:v().of(Y({contact_name:d().required("กรุณากรอกชื่อผู้ติดต่อ"),contact_phone:d().matches(/^[0-9]{10}$/,"กรุณากรอกเบอร์โทรศัพท์ให้ถูกต้อง (10 หลัก)").required("กรุณากรอกเบอร์โทรศัพท์"),contact_email:d().email("รูปแบบอีเมล์ไม่ถูกต้อง").required("กรุณากรอกอีเมล์"),position:d().required("กรุณากรอกตำแหน่ง")})),files:v().test("fileFormat","รองรับเฉพาะไฟล์ PDF หรือรูปภาพเท่านั้น",n=>!n||n.every(a=>{var t;return a.type==="application/pdf"||((t=a.type)==null?void 0:t.startsWith("image/"))}))}),te=n=>{F(a=>a.filter((t,c)=>c!==n))},oe=async(n,{setErrors:a,setStatus:t,setSubmitting:c})=>{try{n.files=b,n.company_code=n.company_code+n.tax_id,console.log("values",n),await S().validate(n,{abortEarly:!1});const r={...n};delete r.contacts,delete r.files,delete r.condition_id;const m=await je(r);if(m.company_id){const h=n.condition_id.map(o=>fe({company_id:m.company_id,condition_id:o}));await Promise.all(h);const x=n.contacts.map(o=>({...o,company_id:m.company_id})).map(o=>_e(o));await Promise.all(x);const L={user_id:Z.user_id,company_id:m.company_id,approved_by:null,status:"pending"};if(await re(L),b.length>0){const g=(await Ce(b,`customer-documents/${m.company_id}`,`หนังสือรับรองบริษัท_${m.company_id}`)).map(_=>{const N=_.fileName.split("/").pop();return ue({company_id:m.company_id,document_name:N,document_type:"ใบจดทะเบียน",document_path:`/${_.fileName}`})});await Promise.all(g)}u.success("เพิ่มข้อมูลลูกค้า/บริษัทและผู้ติดต่อสำเร็จ!",{autoClose:3e3}),k("/company/")}}catch(l){if(l.name==="ValidationError"){const r=l.inner.reduce((m,h)=>(m[h.path]=h.message,m),{});a(r)}else console.log("err.message :",l.message),u.error(`เพิ่มข้อมูลไม่สำเร็จ: ${l.message}`,{autoClose:3e3}),t({success:!1}),a({submit:l.message});c(!1)}},ce=j.useCallback((n,a)=>{F(t=>[...t,...n]),a.length>0&&a.forEach(t=>{t.errors.forEach(c=>{c.code==="file-too-large"?u.error(`ไฟล์ ${t.file.name} มีขนาดใหญ่เกินไป (สูงสุด 5MB)`,{autoClose:3e3}):c.code==="file-invalid-type"?u.error(`ไฟล์ ${t.file.name} ไม่รองรับ (ต้องเป็น image หรือ PDF เท่านั้น)`,{autoClose:3e3}):u.error(`ไฟล์ ${t.file.name}: ${c.message}`,{autoClose:3e3})})})},[]),{getRootProps:ie,getInputProps:le,isDragActive:$}=xe({onDrop:ce,accept:{"image/*":[".jpeg",".jpg",".png"],"application/pdf":[".pdf"]},maxSize:5*1024*1024,maxFiles:5});return e.jsx(p,{className:"",children:e.jsxs(f,{children:[e.jsx(f.Header,{children:e.jsx(p,{children:e.jsx(i,{children:e.jsx(f.Title,{as:"h5",children:"เพิ่มข้อมูลลูกค้า/บริษัท"})})})}),e.jsx(f.Body,{children:e.jsx(pe,{initialValues:ne,validationSchema:S,onSubmit:oe,children:({values:n,errors:a,touched:t,handleChange:c,handleBlur:l,handleSubmit:r,isSubmitting:m,setFieldValue:h})=>e.jsxs(s,{onSubmit:r,children:[e.jsxs(p,{children:[e.jsx(i,{md:6,children:e.jsxs(s.Group,{className:"mb-2",children:[e.jsx(s.Label,{children:"ชื่อบริษัท :"}),e.jsx(s.Control,{type:"text",className:"form-control",placeholder:"ชื่อบริษัท",name:"company_name",value:n.company_name,onChange:c,onBlur:l,isInvalid:t.company_name&&!!a.company_name}),t.company_name&&a.company_name&&e.jsx(s.Control.Feedback,{type:"invalid",children:a.company_name})]})}),e.jsx(i,{md:6,children:e.jsxs(s.Group,{className:"mb-2",children:[e.jsx(s.Label,{children:"เลขที่ผู้เสียภาษี :"}),e.jsx(s.Control,{type:"text",className:"form-control",placeholder:"เลขที่ผู้เสียภาษี",name:"tax_id",value:n.tax_id,onChange:c,onBlur:l,isInvalid:t.tax_id&&!!a.tax_id}),t.tax_id&&a.tax_id&&e.jsx(s.Control.Feedback,{type:"invalid",children:a.tax_id})]})}),e.jsx(i,{md:6,children:e.jsxs(s.Group,{className:"mb-2",children:[e.jsx(s.Label,{children:"ที่อยู่บริษัท :"}),e.jsx(s.Control,{type:"text",className:"form-control",placeholder:"ที่อยู่บริษัท",name:"company_address",value:n.company_address,onChange:c,onBlur:l,isInvalid:t.company_address&&!!a.company_address}),t.company_address&&a.company_address&&e.jsx(s.Control.Feedback,{type:"invalid",children:a.company_address})]})}),e.jsx(i,{md:6,children:e.jsxs(s.Group,{className:"mb-2",children:[e.jsx(s.Label,{children:"ที่อยู่จัดส่งเอกสาร :"}),e.jsx(s.Control,{type:"text",className:"form-control",placeholder:"ที่อยู่จัดส่งเอกสาร",name:"document_address",value:n.document_address,onChange:c,onBlur:l,isInvalid:t.document_address&&!!a.document_address}),t.document_address&&a.document_address&&e.jsx(s.Control.Feedback,{type:"invalid",children:a.document_address})]})}),e.jsx(i,{md:6,children:e.jsxs(s.Group,{className:"mb-2",children:[e.jsx(s.Label,{children:"อีเมล์ :"}),e.jsx(s.Control,{type:"email",className:"form-control",placeholder:"อีเมล์",name:"email",value:n.email,onChange:c,onBlur:l,isInvalid:t.email&&!!a.email}),t.email&&a.email&&e.jsx(s.Control.Feedback,{type:"invalid",children:a.email})]})}),e.jsx(i,{md:6,children:e.jsxs(s.Group,{className:"mb-2",children:[e.jsx(s.Label,{children:"เบอร์โทรศัพท์ :"}),e.jsx(s.Control,{type:"text",className:"form-control",placeholder:"ตัวอย่าง: 0812345678",name:"phone",value:n.phone,onChange:c,onBlur:l,isInvalid:t.phone&&!!a.phone}),t.phone&&a.phone&&e.jsx(s.Control.Feedback,{type:"invalid",children:a.phone})]})}),e.jsxs(i,{md:6,children:[e.jsx(ge,{name:"condition_id",value:n.condition_id,onSelect:h,isMulti:!0}),t.condition_id&&a.condition_id&&e.jsx("div",{className:"invalid-feedback d-block",children:a.condition_id})]}),e.jsx(i,{md:12,className:"mb-2",children:e.jsx(he,{name:"contacts",children:({push:C,remove:x})=>e.jsxs(e.Fragment,{children:[e.jsx(p,{className:"mt-2 mb-2",children:e.jsx(i,{children:e.jsx("h6",{children:"ข้อมูลผู้ติดต่อ"})})}),n.contacts.map((L,o)=>{var g,_,N,D,I,q,G,P,w,B,z,R,E,A,U,V,M,T,H,W,J,K,O,Q;return e.jsx(f,{className:"p-3 mb-2 pb-0 rounded",children:e.jsxs(p,{className:"ps-2 pe-2",children:[e.jsx(i,{md:6,className:"mb-3",children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"ชื่อผู้ติดต่อ:"}),e.jsx(s.Control,{type:"text",name:`contacts.${o}.contact_name`,value:n.contacts[o].contact_name,onChange:c,placeholder:"กรอกชื่อผู้ติดต่อ",onBlur:l,isInvalid:((_=(g=t.contacts)==null?void 0:g[o])==null?void 0:_.contact_name)&&!!((D=(N=a.contacts)==null?void 0:N[o])!=null&&D.contact_name)}),e.jsx(s.Control.Feedback,{type:"invalid",children:(q=(I=a.contacts)==null?void 0:I[o])==null?void 0:q.contact_name})]})}),e.jsx(i,{md:6,className:"mb-3",children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"เบอร์โทร:"}),e.jsx(s.Control,{type:"text",name:`contacts.${o}.contact_phone`,value:n.contacts[o].contact_phone,onChange:c,placeholder:"กรอกเบอร์โทร",onBlur:l,isInvalid:((P=(G=t.contacts)==null?void 0:G[o])==null?void 0:P.contact_phone)&&!!((B=(w=a.contacts)==null?void 0:w[o])!=null&&B.contact_phone)}),e.jsx(s.Control.Feedback,{type:"invalid",children:(R=(z=a.contacts)==null?void 0:z[o])==null?void 0:R.contact_phone})]})}),e.jsx(i,{md:6,className:"mb-3",children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"อีเมล์:"}),e.jsx(s.Control,{type:"email",name:`contacts.${o}.contact_email`,value:n.contacts[o].contact_email,placeholder:"กรอกอีเมล์",onChange:c,onBlur:l,isInvalid:((A=(E=t.contacts)==null?void 0:E[o])==null?void 0:A.contact_email)&&!!((V=(U=a.contacts)==null?void 0:U[o])!=null&&V.contact_email)}),e.jsx(s.Control.Feedback,{type:"invalid",children:(T=(M=a.contacts)==null?void 0:M[o])==null?void 0:T.contact_email})]})}),e.jsx(i,{md:6,className:"mb-3",children:e.jsxs(s.Group,{children:[e.jsx(s.Label,{children:"ตำแหน่ง:"}),e.jsx(s.Control,{type:"text",name:`contacts.${o}.position`,value:n.contacts[o].position,onChange:c,placeholder:"กรอกตำแหน่ง",onBlur:l,isInvalid:((W=(H=t.contacts)==null?void 0:H[o])==null?void 0:W.position)&&!!((K=(J=a.contacts)==null?void 0:J[o])!=null&&K.position)}),e.jsx(s.Control.Feedback,{type:"invalid",children:(Q=(O=a.contacts)==null?void 0:O[o])==null?void 0:Q.position})]})}),n.contacts.length>1&&e.jsx(i,{md:12,className:"d-flex align-items-end mb-3",children:e.jsxs(y,{variant:"danger",onClick:()=>x(o),size:"sm",children:[e.jsx(X,{style:{fontSize:16},className:"me-2"})," ลบ"]})})]},o)},o)}),e.jsx(p,{className:"ps-2 pe-2",children:e.jsx(i,{children:e.jsxs(y,{variant:"outline-success",size:"sm",onClick:()=>C({contact_name:"",contact_phone:"",contact_email:"",position:""}),children:[e.jsx(be,{style:{fontSize:16},className:"me-2"})," เพิ่มผู้ติดต่อ"]})})})]})})}),e.jsxs(i,{md:12,children:[e.jsxs(s.Group,{className:"mb-4",children:[e.jsx(s.Label,{children:"เอกสารประกอบการขึ้นทะเบียน (ตย. หนังสือรับรองบริษัท, ภพ.20, บัตรประชาชนกรรมการบริษัท) :"}),e.jsxs("div",{...ie(),style:{border:"2px dashed #04a9f5",borderRadius:"8px",padding:"50px 20px",textAlign:"center",backgroundColor:$?"#e6f7ff":"#f8f9fa"},children:[e.jsx("input",{...le()}),$?e.jsx("p",{style:{marginBottom:0},children:"Drop your files here..."}):e.jsx("p",{style:{marginBottom:0},children:"Drag and drop files here, or click to select files (สูงสุด 5 ไฟล์, 5MB ต่อไฟล์)"})]}),a.files&&t.files&&e.jsx("div",{className:"invalid-feedback d-block",children:a.files})]}),e.jsx("ul",{className:"mt-3",children:b.map((C,x)=>e.jsxs("li",{children:[e.jsx("i",{className:"feather icon-file",style:{marginRight:12}}),C.name,e.jsx(y,{variant:"danger",size:"sm",className:"ms-2",onClick:()=>te(x),children:e.jsx(X,{style:{fontSize:16}})})]},x))})]})]}),e.jsx(p,{className:"mt-3",children:e.jsxs(i,{children:[e.jsx(y,{variant:"primary",type:"submit",disabled:m,children:m?e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"feather icon-save"})," บันทึก"]})}),e.jsxs(y,{variant:"danger",onClick:()=>k("/company/"),className:"ms-2",children:[e.jsx("i",{className:"feather icon-corner-up-left"})," ย้อนกลับ"]})]})})]})})})]})})}export{Ae as default};
