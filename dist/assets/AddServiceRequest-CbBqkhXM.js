import{u as G,r as d,j as e,B as v,a as U,h as Q,R as E,C as f,y as T}from"./index-6YeC_AS5.js";import{h as W,i as J,p as K}from"./serviceRequest-CJ15hpJs.js";import{b as P,c as X}from"./sampleSubmissionsRequest-bNYMIj3U.js";import{h as Y}from"./uploadFileRequest-j7nqPy1R.js";import{c as I,g as H,a as n,h as B,F as Z}from"./formik.esm-C0GtiMNK.js";import{g as ee}from"./fertilizerTypesRequest-CzftO6V-.js";import{S as se}from"./StepForm-BvfMe8oP.js";import{F as te}from"./Form-CGCyrcfL.js";import{C as p}from"./Card-BhOVTKNa.js";import{g as ie}from"./specialConditionsRequest-B-G5iiQh.js";import{a as re}from"./customerRequest-D-QXhSQD.js";import{p as ae}from"./telegramNotifyRequest-BwpORK4f.js";import{A as oe}from"./Alert-D32VqIXN.js";import{M as D}from"./Modal-D05P99kH.js";import"./firebaseConfig-pMHECxRz.js";import"./CountrySelect-DQQwKg9k.js";import"./react-select.esm-jYPj7h1v.js";import"./toPropertyKey-CTo9CRTC.js";import"./emotion-element-f0de968e.browser.esm-C-W82wov.js";import"./setPrototypeOf-DgZC2w_0.js";import"./packageingTypeRequest-CUTcv2jf.js";import"./testItemsRequest-CIY3wZGW.js";import"./index-DRJWWvqM.js";import"./tslib.es6-RU1n5ZxP.js";import"./fertilizerMainRequest-kGbpd_0A.js";import"./fertilizerFormulasRequest-DNgpnBu6.js";import"./TextField-DmQ6Lsg1.js";import"./DefaultPropsProvider-2RhE6zQB.js";import"./Transition-rt6HDaS9.js";import"./CloseButton-BYF_v0Zl.js";const le=({onHandleSave:_,userId:g,sampleType:c,company:y,spacialCon:x})=>{const N=G(),[j,S]=d.useState([]),a={user_id:g,company_id:y.company_id,analysisMethod:"is_registration_analysis",spacialCon:"",notes:"",sample_type_id:c,fertilizerRecords:[],files:[]},m=I({analysisMethod:n().test("analysis-method-required","กรุณาเลือกวัตถุประสงค์การขอใช้บริการ",function(r){const{sample_type_id:o}=this.options.context;return o===1?r&&["is_registration_analysis","is_quality_check_analysis"].includes(r):!0}),notes:n().notRequired(),fertilizerRecords:H().min(1,"กรุณาเพิ่มข้อมูลปุ๋ยอย่างน้อยหนึ่งรายการ").of(I({fertilizer_type_id:B().required("กรุณาเลือกประเภทลักษณะปุ๋ย").typeError("กรุณาเลือกประเภทลักษณะปุ๋ย"),packaging_id:B().required("กรุณาเลือกภาชนะบรรจุ").typeError("กรุณาเลือกภาชนะบรรจุ"),color:n().required("กรุณากรอกสี"),trade_name:n().required("กรุณากรอกชื่อการค้า"),trademark:n().required("กรุณากรอกเครื่องหมายการค้า"),manufacturer:n().required("กรุณากรอกชื่อผู้ผลิต"),manufacturer_country:n().required("กรุณากรอกประเทศของผู้ผลิต"),supplier:n().required("กรุณากรอกชื่อผู้จัดจำหน่าย"),supplier_country:n().required("กรุณากรอกประเทศของผู้จัดจำหน่าย"),composition:n().required("กรุณากรอกวัตถุส่วนประกอบของปุ๋ย"),sample_weight:B().required("กรุณากรอกปริมาณ").typeError("ปริมาณต้องเป็นตัวเลข").positive("ปริมาณต้องมากกว่า 0"),sample_weight_unit:n().required("กรุณากรอกหน่วย")})),files:H().min(1,"กรุณาอัปโหลดเอกสารอย่างน้อยหนึ่งไฟล์").required("กรุณาอัปโหลดเอกสาร")}),b=async(r,{setSubmitting:o,validateForm:u})=>{console.log("Submitting - Values:",r);const l=await u();console.log("Submitting - Errors:",l),Object.keys(l).length===0?(console.log("Form Values:",r),_(r)):console.log("Validation Errors:",l),o(!1)},h=async()=>{try{const r=await ee();S(r)}catch(r){console.error("Error fetching fertilizer types:",r)}};return d.useEffect(()=>{h()},[]),e.jsx(Z,{initialValues:a,validationSchema:m,onSubmit:b,validateOnChange:!0,validateOnBlur:!0,validationContext:{sample_type_id:c},children:({values:r,errors:o,touched:u,handleChange:l,handleBlur:w,setFieldValue:C,handleSubmit:F,validateForm:z})=>(console.log("Formik values:",r),console.log("Formik Errors:",o),e.jsx(te,{onSubmit:F,children:e.jsxs(p,{children:[e.jsx(p.Header,{children:e.jsx("h5",{children:c===1?e.jsxs(e.Fragment,{children:["ลงทะเบียนใบนำส่งตัวอย่าง",e.jsx("strong",{style:{color:"#8B4513"},children:" ปุ๋ยอินทรีย์"})]}):e.jsxs(e.Fragment,{children:["ลงทะเบียนใบนำส่งตัวอย่าง",e.jsx("strong",{style:{color:"#28A745"},children:" ปุ๋ยเคมี"})]})})}),e.jsx(p.Body,{className:"p-0",children:e.jsx(se,{values:r,errors:o,touched:u,handleChange:l,handleBlur:w,setFieldValue:C,company:y,spacialCon:x,fertilizerTypes:j,sampleType:c,validateForm:z})}),e.jsxs(p.Footer,{className:"text-start",children:[e.jsxs(v,{variant:"primary",type:"submit",children:[e.jsx("i",{className:"feather icon-save"})," บันทึก"]}),e.jsxs(v,{variant:"danger",onClick:()=>N("/request"),children:[e.jsx("i",{className:"feather icon-corner-up-left"})," ยกเลิก"]})]})]})}))})},ne="/assets/logo-fertilizer-organic-BI1yMMGv.webp",ce="/assets/logo-fertilizer-chemical-C2QnQa7w.webp",me=async(_,g,c,y,x)=>{var u;const{company_code:N,company_name:j,tax_id:S}=g,a=_.sample_type_id===1?"ปุ๋ยอินทรีย์":"ปุ๋ยเคมี",m=((u=_.fertilizerRecords)==null?void 0:u.length)||0,b=c.length>0?c.map((l,w)=>`${l.description}${w<c.length-1?", ":""}`).join(""):"-",h=x,r=new Date().toLocaleString("th-TH",{dateStyle:"long",timeStyle:"short"}),o=`
📌 *แจ้งเตือนการลงทะเบียนขอรับบริการใหม่*
--------------------------------------
🏷️ รหัสลูกค้า: *${N}*
🏢 ชื่อบริษัท: *${j}*
🧾 เลขประจำตัวผู้เสียภาษี: *${S}*
📦 ประเภทปุ๋ย: *${a}*
🔢 จำนวนตัวอย่าง: *${m}*
📄 เงื่อนไขพิเศษ: *${b}*
🗓️ วันที่สร้าง: *${r}*
🔗 รายละเอียดเพิ่มเติม:
${y}/admin/request/verify/${h}
`.trim();try{await ae({message:o}),console.log("📨 ส่งข้อความแจ้งเตือน Telegram สำเร็จ")}catch(l){console.error("❌ เกิดข้อผิดพลาดในการส่งข้อความ Telegram:",l)}},Ge=()=>{var z,A;const _=G(),[g,c]=d.useState(null),[y,x]=d.useState(null),[N,j]=d.useState(!1),S=U();(z=S.state)!=null&&z.user;const a=((A=S.state)==null?void 0:A.customer)||null,[m,b]=d.useState({}),[h,r]=d.useState({}),[o,u]=d.useState([]);d.useEffect(()=>{const t=localStorage.getItem("authToken");C(a==null?void 0:a.id),w(a==null?void 0:a.id),t&&Q(t).then(i=>{u(i.user)})},[]);const l=t=>{c(t),t==="organic"?x(1):t==="chemical"&&x(2)},w=async t=>{try{const i=await re(t);console.log("getCustomerByID:",i),r(i)}catch(i){console.error(i),r([])}},C=async t=>{try{const i=await ie(t);console.log("handleGetCusSpacialCon:",i),b(Array.isArray(i)?i:[])}catch(i){console.error(i),b([])}},F=async t=>{console.log(t);const i={user_id:o.user_id,customer_id:t.company_id,is_registration_analysis:t.analysisMethod==="is_registration_analysis"?1:0,is_quality_check_analysis:t.analysisMethod==="is_quality_check_analysis"?1:0,sample_type_id:t.sample_type_id,sr_is_self_pickup:(t.reportMethod||[]).includes("is_self_pickup")?1:0,sr_pdf_email:(t.reportMethod||[]).includes("pdf_email")?t.email:"",sr_is_mail_delivery:(t.reportMethod||[]).includes("is_self_pickup")?1:0,sr_mail_delivery_location:"-",notes:t.notes};console.log(i);let R=[];t.fertilizerRecords.forEach(s=>{const M={request_id:null,is_single_fertilizer:s.fertilizer_main_id===1?1:0,is_compound_fertilizer:s.fertilizer_main_id===2?1:0,is_mixed_fertilizer:s.fertilizer_main_id===3?1:0,is_secondary_nutrient_fertilizer:s.fertilizer_main_id===4?1:0,fertilizer_type_id:s.fertilizer_type_id,fertilizer_other:s.fertilizer_other,color:s.color,fertilizer_formula:s.fertilizer_formula,packaging_other:s.packaging_other,common_name:s.common_name,trade_name:s.trade_name,trademark:s.trademark,manufacturer:s.manufacturer,manufacturer_country:s.manufacturer_country,supplier:s.supplier,supplier_country:s.supplier_country,composition:s.composition,sample_weight:s.sample_weight,sample_weight_unit:s.sample_weight_unit,packaging_id:s.packaging_id,pdf_email:(s.reportMethod||[]).includes("pdf_email")?s.email:"",is_self_pickup:(s.reportMethod||[]).includes("is_self_pickup")?1:0,is_mail_delivery:(s.reportMethod||[]).includes("pdf_email")?1:0,mail_delivery_location:s.mail_delivery_location,test_all_items:s.test_all_items,is_lab_dispose_sample:s.sampleDisposal==="is_lab_dispose_sample"?1:0,is_collect_within_3_months:s.sampleDisposal==="is_collect_within_3_months"?1:0,is_return_sample:s.sampleDisposal==="is_return_sample"?1:0,submitted_by:s.submitted_by,phone:s.submitted_phone,test_items:s.test_items,formula_id:s.formula_id,fertilizer_main_id:s.fertilizer_main_id,other_requirements:s.other_requirements};R.push(M)}),console.log(R);const O=t.files;try{console.log("step1:",i);const s=await W(i);if(s.request_id){for(const q of R){q.request_id=s.request_id;const k=await P(q);if(console.log("responseSample:",k),k.submission_id){const $={submission_id:k.submission_id,test_items:q.test_items},L=await X($);console.log("responseTestItem:",L)}}const M=await Y(O,"service-requests","service_");for(const q of M){const k=q.fileName.split("/").pop(),$={request_id:s.request_id,uploaded_by:o.user_id,file_name:k,file_path:`/${q.fileName}`};await J($)}const V={newStatusTracking:"requested"};await K(s.request_id,V),await me(t,h,m,window.location.origin,s.request_id),T.success("เพิ่มข้อมูลคำขอรับบริการสำเร็จ!",{autoClose:3e3}),_("/request/detial",{state:{id:s.request_id}}),j(!0)}}catch(s){console.log("Error:",s),T.error("เพิ่มข้อมูลคำขอรับบริการไม่สำเร็จ!",{autoClose:3e3}),alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล:",s)}};return e.jsxs(e.Fragment,{children:[g===null&&e.jsxs(p,{children:[e.jsx(p.Header,{children:e.jsx("h5",{children:"เลือกประเภทการขอรับบริการ"})}),e.jsxs(p.Body,{children:[e.jsx(p,{className:"p-4 mb-3",children:e.jsxs(E,{children:[e.jsx(f,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["รหัสลูกค้า : ",e.jsx("strong",{className:"text-dark",children:h.company_code})," ",e.jsx("span",{className:"text-dark",children:"(กรณีมีการเปลี่ยนแปลง ชื่อ, ที่อยู่ กรุณาแจ้งห้องปฏิบัติการ)"})]})}),e.jsx(f,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ชื่อบริษัท : ",e.jsx("strong",{className:"text-dark",children:a.company_name})]})}),e.jsx(f,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["เลขที่ผู้เสียภาษี : ",e.jsx("strong",{className:"text-dark",children:a.tax_id})]})}),e.jsx(f,{md:6,className:"mb-2",children:e.jsxs("p",{className:"mb-0",children:["ที่อยู่ : ",e.jsx("strong",{className:"text-dark",children:a.company_address})]})}),m&&m.length>0&&e.jsx(f,{md:6,children:e.jsxs("p",{className:"mb-0",children:["เงื่อนไขพิเศษ :"," ",e.jsx("strong",{className:"text-dark",children:m.map((t,i)=>e.jsxs("span",{children:[t.description,i+1<m.length&&", "]},i))})]})})]})}),e.jsx(oe,{variant:"warning",className:"mb-3 rounded-0",style:{borderLeft:"solid 3px #FFA500"},children:"ลูกค้ามีเครดิต (Credit) กรุณาแจ้งหากต้องการเงื่อนไขพิเศษ (Advance Invoice)"}),e.jsx(p,{className:"p-4",children:e.jsxs(E,{className:"justify-content-start ",children:[e.jsx(f,{md:4,sm:12,className:"mb-3",children:e.jsxs(v,{variant:"outline",className:"w-100 h-100 py-4 d-flex align-items-center justify-content-top flex-column",style:{color:"#8B4513",fontSize:"18px",fontWeight:"bold",border:"solid 1px #8B4513",borderRadius:10},onClick:()=>l("organic"),children:[e.jsx("div",{className:"logo-fertilizer-style",style:{border:"solid 3px #8B4513"},children:e.jsx("img",{src:ne,alt:"ปุ๋ยอินทรีย์",style:{width:"120px",padding:"12px"}})}),"แบบฟอร์มนำส่งตัวอย่างปุ๋ยอินทรีย์"]})}),e.jsx(f,{md:4,sm:12,className:"mb-3",children:e.jsxs(v,{variant:"outline",className:"w-100 h-100 py-4 d-flex align-items-center justify-content-center flex-column",style:{color:"#28A745",fontSize:"18px",fontWeight:"bold",border:"solid 1px #28A745",borderRadius:10},onClick:()=>l("chemical"),children:[e.jsx("div",{className:"logo-fertilizer-style",style:{border:"solid 3px #28A745"},children:e.jsx("img",{src:ce,alt:"ปุ๋ยเคมี",style:{width:"120px",padding:"12px"}})}),e.jsxs("div",{children:["แบบฟอร์มนำส่งตัวอย่างปุ๋ยเคมี",e.jsx("br",{}),"(เพื่อขึ้นทะเบียนปุ๋ย)"]})]})})]})})]})]}),g!==null&&e.jsx(le,{userId:o.user_id,onHandleSave:F,sampleType:y,company:h,spacialCon:m}),e.jsxs(D,{show:N,onHide:()=>j(!1),centered:!0,children:[e.jsxs(D.Body,{className:"text-center",children:[e.jsx("i",{className:"text-success",style:{fontSize:"3rem"},children:"✔"}),e.jsx("h5",{className:"mt-3",children:"ลงทะเบียนขอรับบริการสำเร็จ"}),e.jsx("p",{children:"กรุณารอผลการตรวจสอบคำขอใช้บริการ"})]}),e.jsx(D.Footer,{children:e.jsx(v,{variant:"success",onClick:()=>_("/request/"),children:"ปิด"})})]})]})};export{Ge as default};
