import{u as se,a as re,aF as ae,r as l,h as ne,j as _,B as R}from"./index-Bq0BSIrC.js";import{c as w,g as z,a as r,e as v,h as y,F as _e}from"./formik.esm-BOpZLvMI.js";import{a as oe}from"./specialConditionsRequest-Dz72CEse.js";import{g as le}from"./fertilizerTypesRequest-CzftO6V-.js";import{c as me}from"./customerRequest-CvJAP-BQ.js";import{a as ce,i as de,h as pe,f as ue}from"./serviceRequest-BNwVWIYi.js";import{d as fe,p as ye,e as he,c as T,b as ge}from"./sampleSubmissionsRequest-CTdJwuzW.js";import{d as ze,h as qe}from"./uploadFileRequest-CHVQkj-t.js";import{S as Se}from"./StepForm-BIj5QW8J.js";import{F as be}from"./Form-C1nYDdO8.js";import{C as q}from"./Card-C7kDYjR9.js";import"./tslib.es6-RU1n5ZxP.js";import"./react-select.esm-CGHZA8pU.js";import"./toPropertyKey-KGmwFxs9.js";import"./emotion-element-f0de968e.browser.esm-xSVEHtue.js";import"./setPrototypeOf-DgZC2w_0.js";import"./packageingTypeRequest-CUTcv2jf.js";import"./testItemsRequest-CIY3wZGW.js";import"./fertilizerMainRequest-kGbpd_0A.js";import"./Modal-CjqQnpwU.js";import"./CloseButton-DJdHSP0V.js";import"./Transition-DABJrq3x.js";import"./TextField-BqqrABCd.js";import"./DefaultPropsProvider-CMzRgkCO.js";const Ge=({userId:A})=>{var F;const k=se(),N=re(),{requestId:E}=ae(),c=((F=N.state)==null?void 0:F.id)||E||null,[S,P]=l.useState(null),[b,$]=l.useState(null),[B,D]=l.useState(null),[O,V]=l.useState([]),[H,x]=l.useState([]),[h,p]=l.useState(null),[C,U]=l.useState(null),[u,J]=l.useState(A);l.useEffect(()=>{const e=localStorage.getItem("authToken");e&&ne(e).then(i=>{J(i.user.user_id)}).catch(i=>{console.error("Error authenticating user:",i),p("ไม่สามารถตรวจสอบผู้ใช้ได้")})},[]);const L=(e,i)=>{console.log("apiData:",e);const a=e.sample_submissions||[],n=a[0]||{};return{user_id:u||e.user_id,company_id:e.customer_id,analysisMethod:e.is_registration_analysis?"is_registration_analysis":"is_quality_check_analysis",notes:e.notes||"",sample_type_id:e.sample_type_id,fertilizerRecords:a.map(t=>({request_id:t.request_id,fertilizerCategory:t.is_single_fertilizer?"is_single_fertilizer":t.is_compound_fertilizer?"is_compound_fertilizer":t.is_mixed_fertilizer?"is_mixed_fertilizer":t.is_secondary_nutrient_fertilizer?"is_secondary_nutrient_fertilizer":null,fertilizer_main_id:t.fertilizer_main_id,fertilizer_type_id:t.fertilizer_type_id,color:t.color||"",fertilizer_formula:t.fertilizer_formula||"",common_name:t.common_name||"",trade_name:t.trade_name||"",trademark:t.trademark||"",manufacturer:t.manufacturer||"",manufacturer_country:t.manufacturer_country||"TH",supplier:t.supplier||"",supplier_country:t.supplier_country||"TH",composition:t.composition||"",sample_weight:t.sample_weight?parseFloat(t.sample_weight):null,sample_weight_unit:t.sample_weight_unit||"",packaging_id:t.packaging_id||null,packaging_other:t.packaging_other||"",submission_id:t.submission_id,test_items:(t.sample_submission_details||[]).map(o=>({test_item_id:o.test_item_id,test_percentage:o.test_percentage||""})),reportMethod:[t.is_self_pickup?"is_self_pickup":null,t.pdf_email?"pdf_email":null,t.is_mail_delivery?"is_mail_delivery":null].filter(Boolean),email:t.pdf_email||"",sameAddress:e.mail_delivery_location===(i==null?void 0:i.document_address),mail_delivery_location:e.mail_delivery_location||"",phone:n.phone||"",sampleDisposal:n.is_lab_dispose_sample?"is_lab_dispose_sample":n.is_collect_within_3_months?"is_collect_within_3_months":"is_return_sample",test_all_items:n.test_all_items!==null?!!n.test_all_items:!0,submitted_by:n.submitted_by||"",submitted_date:n.submission_date?new Date(n.submission_date).toISOString().split("T")[0]:"",submitted_phone:n.phone||""})),files:(e.service_request_documents||[]).map(t=>({name:t.file_name,path:t.file_path,document_id:t.document_id}))}},G=async e=>{try{const i=await ce(e),a=await me(i.customer_id);D(a);const n=L(i,a);P(n),$(i),await ie(i.customer_id)}catch(i){console.error("Error fetching service request:",i),p("ไม่สามารถโหลดข้อมูลได้ กรุณาลองใหม่")}},K=async()=>{try{const e=await le();V(e)}catch(e){console.error("Error fetching fertilizer types:",e)}};l.useEffect(()=>{c&&u?(G(c),K()):c||p("ไม่พบ Request ID")},[c,u]);const Q=w({company_id:y().required("กรุณาเลือกบริษัท"),analysisMethod:r().required("กรุณาเลือกวัตถุประสงค์การขอใช้บริการ").oneOf(["is_registration_analysis","is_quality_check_analysis"],"กรุณาเลือกวัตถุประสงค์ที่ถูกต้อง"),notes:r().max(500,"ความต้องการอื่นต้องไม่เกิน 500 ตัวอักษร").optional(),fertilizerRecords:z().min(1,"กรุณาเพิ่มข้อมูลปุ๋ยอย่างน้อยหนึ่งรายการ").of(w({fertilizerCategory:r().test("fertilizer-category-required","กรุณาเลือกประเภทของปุ๋ย",function(e){const{sample_type_id:i}=this.options.context;return i===2?e&&["is_single_fertilizer","is_compound_fertilizer","is_mixed_fertilizer","is_secondary_nutrient_fertilizer"].includes(e):!0}),fertilizer_type_id:y().required("กรุณาเลือกประเภทลักษณะปุ๋ย"),packaging_id:y().required("กรุณาเลือกภาชนะบรรจุ"),color:r().required("กรุณากรอกสี"),fertilizer_formula:r().required("กรุณากรอกสูตรปุ๋ย"),common_name:r().required("กรุณากรอกชื่อสามัญ"),trade_name:r().required("กรุณากรอกชื่อการค้า"),trademark:r().required("กรุณากรอกเครื่องหมายการค้า"),manufacturer:r().required("กรุณากรอกชื่อผู้ผลิต"),manufacturer_country:r().required("กรุณาเลือกประเทศของผู้ผลิต"),supplier:r().required("กรุณากรอกชื่อผู้จัดจำหน่าย"),supplier_country:r().required("กรุณาเลือกประเทศของผู้จัดจำหน่าย"),composition:r().required("กรุณากรอกวัตถุส่วนประกอบของปุ๋ย"),sample_weight:y().required("กรุณากรอกปริมาณ").typeError("ปริมาณต้องเป็นตัวเลข"),sample_weight_unit:r().required("กรุณาเลือกหน่วย"),test_items:z().min(1,"กรุณาเลือกอย่างน้อยหนึ่งรายการทดสอบ").of(w({test_item_id:y().required("ต้องระบุรายการทดสอบ"),test_percentage:r().test("requires-percentage","กรุณากรอกเปอร์เซ็นต์ให้ถูกต้อง",function(e){const i=this.parent.test_item_id;return[1,3,5,7,10,15].includes(i)&&e?/^\d+(\.\d+)?$/.test(e):!0})})),reportMethod:z().min(1,"กรุณาเลือกวิธีการรับรายงานอย่างน้อยหนึ่งวิธี").of(r().oneOf(["is_self_pickup","pdf_email","is_mail_delivery"],"วิธีการรับรายงานไม่ถูกต้อง")),email:r().test("email-required","กรุณากรอกอีเมลสำหรับรับผลตรวจ",function(e){const i=this.parent.reportMethod;return Array.isArray(i)&&i.includes("pdf_email")?r().email("กรุณากรอกอีเมลที่ถูกต้อง").isValidSync(e):!0}),sameAddress:v(),sr_mail_delivery_location:r().test("address-required","กรุณากรอกที่อยู่จัดส่ง",function(e){const{reportMethod:i,sameAddress:a}=this.parent;return Array.isArray(i)&&i.includes("is_mail_delivery")&&!a?e&&e.trim()!=="":!0}),phone:r().test("phone-required","กรุณากรอกเบอร์โทรศัพท์ 9-10 หลัก",function(e){const{reportMethod:i,sameAddress:a}=this.parent;return Array.isArray(i)&&i.includes("is_mail_delivery")&&!a?e&&/^\d{9,10}$/.test(e):!0}),sampleDisposal:r().required("กรุณาเลือกวิธีการจำหน่ายตัวอย่าง").oneOf(["is_lab_dispose_sample","is_collect_within_3_months","is_return_sample"],"วิธีการจำหน่ายตัวอย่างไม่ถูกต้อง"),test_all_items:v().required("กรุณาเลือกขอบเขตการทดสอบ"),submitted_by:r().required("กรุณากรอกชื่อผู้ส่งตัวอย่าง"),submitted_phone:r().required("กรุณากรอกเบอร์โทรศัพท์ผู้ส่งตัวอย่าง").matches(/^\d{9,10}$/,"กรุณากรอกเบอร์โทรศัพท์ 9-10 หลัก"),submitted_date:r().required("กรุณาเลือกวันที่ส่ง")})),files:z().min(1,"กรุณาอัปโหลดเอกสารอย่างน้อยหนึ่งไฟล์")}),W=(e,i)=>e.customer_id!==i.company_id||e.is_registration_analysis!==(i.analysisMethod==="is_registration_analysis"?1:0)||e.is_quality_check_analysis!==(i.analysisMethod==="is_quality_check_analysis"?1:0)||e.sr_is_self_pickup!==(i.reportMethod.includes("is_self_pickup")?1:0)||e.sr_pdf_email!==(i.reportMethod.includes("pdf_email")?i.email:"")||e.sr_is_mail_delivery!==(i.reportMethod.includes("is_mail_delivery")?1:0)||e.sr_mail_delivery_location!==i.sr_mail_delivery_location||e.notes!==i.notes,X=(e,i)=>{const a=["fertilizerCategory","fertilizer_type_id","color","fertilizer_formula","common_name","trade_name","trademark","manufacturer","manufacturer_country","supplier","supplier_country","composition","sample_weight","sample_weight_unit","packaging_id","packaging_other","test_all_items","sampleDisposal","submitted_by","submitted_phone","submitted_date"],n=(e.sample_submission_details||[]).map(t=>({test_item_id:t.test_item_id,test_percentage:t.test_percentage}));return a.some(t=>e[t]!==i[t])||JSON.stringify(n)!==JSON.stringify(i.test_items)},Y=async(e,i,a,n)=>{const t=e.filter(s=>!i.some(d=>d.submission_id===s.submission_id));await Promise.all(t.map(s=>fe(s.submission_id)));const o=i.map(async s=>{const d={request_id:a,is_single_fertilizer:s.fertilizerCategory==="is_single_fertilizer"?1:0,is_compound_fertilizer:s.fertilizerCategory==="is_compound_fertilizer"?1:0,is_mixed_fertilizer:s.fertilizerCategory==="is_mixed_fertilizer"?1:0,is_secondary_nutrient_fertilizer:s.fertilizerCategory==="is_secondary_nutrient_fertilizer"?1:0,fertilizer_type_id:s.fertilizer_type_id,color:s.color,fertilizer_formula:s.fertilizer_formula,common_name:s.common_name,trade_name:s.trade_name,trademark:s.trademark,manufacturer:s.manufacturer,manufacturer_country:s.manufacturer_country,supplier:s.supplier,supplier_country:s.supplier_country,composition:s.composition,sample_weight:String(s.sample_weight),sample_weight_unit:s.sample_weight_unit,packaging_id:s.packaging_id,packaging_other:s.packaging_other,test_all_items:n.test_all_items?1:0,is_lab_dispose_sample:s.sampleDisposal==="is_lab_dispose_sample"?1:0,is_collect_within_3_months:s.sampleDisposal==="is_collect_within_3_months"?1:0,is_return_sample:s.sampleDisposal==="is_return_sample"?1:0,submitted_by:s.submitted_by,phone:s.submitted_phone,submission_date:s.submitted_date};if(s.submission_id){const g=e.find(m=>m.submission_id===s.submission_id);X(g,s)&&await ye(d,s.submission_id);const M=g.sample_submission_details||[],I=s.test_items||[],te=M.filter(m=>!I.some(f=>f.test_item_id===m.test_item_id&&f.test_percentage===m.test_percentage));await Promise.all(te.map(m=>he(m.detail_id)));const j=I.filter(m=>!M.some(f=>f.test_item_id===m.test_item_id&&f.test_percentage===m.test_percentage));j.length>0&&await T({submission_id:s.submission_id,test_items:j})}else{const g=await ge(d);s.test_items.length>0&&await T({submission_id:g.submission_id,test_items:s.test_items})}});await Promise.all(o)},Z=async(e,i,a)=>{const n=e.filter(o=>!i.some(s=>s.document_id===o.document_id));await Promise.all(n.map(async o=>{await ze(o.file_path),await pe(o.document_id)}));const t=i.filter(o=>!o.document_id);if(t.length>0){const o=await qe(t,"service-requests","service_");await Promise.all(o.map(s=>{const d=s.fileName.split("/").pop();return ue({request_id:a,uploaded_by:u,file_name:d,file_path:s.fileName})}))}},ee=async(e,{setSubmitting:i})=>{console.log("values:",e);try{const a={user_id:e.user_id,customer_id:e.company_id,is_registration_analysis:e.analysisMethod==="is_registration_analysis"?1:0,is_quality_check_analysis:e.analysisMethod==="is_quality_check_analysis"?1:0,sr_is_self_pickup:e.fertilizerRecords[0].reportMethod.includes("is_self_pickup")?1:0,sr_pdf_email:e.fertilizerRecords[0].reportMethod.includes("pdf_email")?e.fertilizerRecords[0].email:"",sr_is_mail_delivery:e.fertilizerRecords[0].reportMethod.includes("is_mail_delivery")?1:0,sr_mail_delivery_location:e.fertilizerRecords[0].sr_mail_delivery_location,notes:e.notes};W(b,e)&&await de(a,c),await Y(b.sample_submissions,e.fertilizerRecords,c,e),await Z(b.service_request_documents,e.files,c),U("บันทึกการแก้ไขสำเร็จ"),p(null),setTimeout(()=>k("/request"),1e3)}catch(a){console.error("Error submitting form:",a),p("เกิดข้อผิดพลาดในการบันทึกข้อมูล")}finally{i(!1)}},ie=async e=>{try{const i=await oe(e);x(Array.isArray(i)?i:[])}catch(i){console.error("Error fetching special conditions:",i),x([])}};return h?_.jsx("div",{className:"text-danger",children:h}):!S||!u?_.jsx("div",{children:"Loading..."}):_.jsx(_e,{initialValues:S,validationSchema:Q,onSubmit:ee,enableReinitialize:!0,context:{sample_type_id:S.sample_type_id},children:({values:e,errors:i,touched:a,handleChange:n,handleBlur:t,setFieldValue:o,handleSubmit:s})=>_.jsx(be,{onSubmit:s,children:_.jsxs(q,{children:[_.jsx(q.Header,{children:_.jsx("h5",{children:e.sample_type_id===1?"แก้ไขใบนำส่งตัวอย่างปุ๋ยอินทรีย์":"แก้ไขใบนำส่งตัวอย่างปุ๋ยเคมี เพื่อขึ้นทะเบียนปุ๋ย"})}),_.jsx(q.Body,{className:"p-0",children:_.jsx(Se,{values:e,errors:i,touched:a,handleChange:n,handleBlur:t,setFieldValue:o,company:B,spacialCon:H,fertilizerTypes:O,sampleType:e.sample_type_id})}),_.jsxs(q.Footer,{className:"text-start",children:[C&&_.jsx("div",{className:"text-success mb-2",children:C}),h&&_.jsx("div",{className:"text-danger mb-2",children:h}),_.jsxs(R,{variant:"primary",type:"submit",disabled:e.isSubmitting,children:[_.jsx("i",{className:"feather icon-save"})," แก้ไข"]}),_.jsxs(R,{variant:"danger",onClick:()=>k("/request"),children:[_.jsx("i",{className:"feather icon-corner-up-left"})," ยกเลิก"]})]})]})})})};export{Ge as default};
